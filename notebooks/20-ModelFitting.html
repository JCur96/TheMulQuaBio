
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Model Fitting in Ecology and Evolution &#8212; TheMulQuaBio</title>
    
  <link rel="stylesheet" href="../_static/css/index.d431a4ee1c1efae0e38bdfebc22debff.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/sphinx-book-theme.bfb7730f9caf2ec0b46a44615585038c.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.30270b6e4c972e43c488.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Introduction to Jupyter" href="Appendix-JupyIntro.html" />
    <link rel="prev" title="Generalised Linear Models" href="19-glm.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">TheMulQuaBio</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Welcome to The Multilingual Quantitative Biologist!
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Computing
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="01-Unix.html">
   UNIX and Linux
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02-ShellScripting.html">
   Shell scripting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03-Git.html">
   Version control with Git
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04-LaTeX.html">
   Scientific documents with
   <span class="math notranslate nohighlight">
    \(\LaTeX\)
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05-Python_I.html">
   Biological Computing in Python I
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06-Python_II.html">
   Biological Computing in Python II
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07-R.html">
   Biological Computing in R
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Basic Data Analyses and Statistics
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats-Intro.html">
   Introduction to this section
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08-Data_R.html">
   Data Management and Visualization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12-ExpDesign.html">
   Experimental design and Data exploration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13-t_F_tests.html">
   <span class="math notranslate nohighlight">
    \(t\)
   </span>
   and
   <span class="math notranslate nohighlight">
    \(F\)
   </span>
   tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14-regress.html">
   Linear Models: Regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15-anova.html">
   Linear Models: Analysis of variance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16-MulExpl.html">
   Linear Models: Multiple explanatory variables
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="17-MulExplInter.html">
   Linear Models: Multiple variables with interactions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="18-ModelSimp.html">
   Model simplification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="19-glm.html">
   Generalised Linear Models
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Advanced Data Analyses and Statistics
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Model Fitting in Ecology and Evolution
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Appendices
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="Appendix-JupyIntro.html">
   Introduction to Jupyter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Appendix-Data-Python.html">
   Data analyses  with Python &amp; Jupyter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Appendix-Maths.html">
   Mathematical models in Jupyter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Appendix-Databases.html">
   Databases
   <span class="tocSkip">
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Appendix-NLLS-Python.html">
   Model fitting in Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Appendix-MiniProj.html">
   The Computing Miniproject
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Appendix-Assessment.html">
   Coursework Assessment
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/20-ModelFitting.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/mhasoba/TheMulQuaBio"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/mhasoba/TheMulQuaBio/issues/new?title=Issue%20on%20page%20%2Fnotebooks/20-ModelFitting.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/mhasoba/TheMulQuaBio/master?urlpath=tree/notebooks/20-ModelFitting.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/mhasoba/TheMulQuaBio/blob/master/notebooks/20-ModelFitting.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-fitting-using-non-linear-least-squares">
   Model fitting using Non-linear least squares
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#traits-data-as-an-example">
     Traits data as an example
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#allometric-scaling-of-traits">
       Allometric scaling of traits
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#exercises-a-id-allom-exercises-a">
         Exercises
         <a id="Allom_Exercises">
         </a>
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#comparing-models">
       Comparing models
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#exercises-a-id-modelselection-exercises-a">
       Exercises
       <a id="ModelSelection_Exercises">
       </a>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#albatross-chick-growth">
       Albatross chick growth
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fitting-the-three-models-using-nlls">
         Fitting the three models using NLLS
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#exercises-a-id-albatross-exercises-a">
       Exercises
       <a id="Albatross_Exercises">
       </a>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#aedes-aegypti-fecundity">
       Aedes aegypti fecundity
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#the-thermal-performance-curve-models">
         The Thermal Performance Curve models
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#exercises-a-id-aedes-exercises-a">
         Exercises
         <a id="Aedes_Exercises">
         </a>
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#abundances-as-an-example">
     Abundances as an example
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#population-growth-rates">
       Population growth rates
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#basic-approach">
       Basic approach
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#using-ols">
       Using OLS
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#using-nlls">
       Using NLLS
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercises">
     Exercises
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#obtaining-starting-values">
     Obtaining starting values
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-fitting-using-maximum-likelihood">
   Model fitting using Maximum Likelihood
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#implementing-the-likelihood-in-r">
     Implementing the Likelihood in R
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#likelihood-profile">
       Likelihood profile
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#likelihood-surface">
       Likelihood surface
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#conditional-likelihood">
       Conditional Likelihood
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#alternatives-to-grid-search">
     Alternatives to Grid Search
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#maximum-likelihood-using-optim">
     Maximum Likelihood using
     <code class="docutils literal notranslate">
      <span class="pre">
       optim()
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#confidence-intervals">
     Confidence intervals
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#comparison-to-fitting-with-least-squares">
     Comparison to fitting with least squares
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-selection">
     Model Selection
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#exercises-a-id-mle-exercises-a">
       Exercises
       <a id="MLE_Exercises">
       </a>
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fitting-models-the-bayesian-way">
   Fitting Models the Bayesian way
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-likelihoods-exercise">
     A Likelihoods exercise
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-binomial-distribution">
       The Binomial Distribution
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#simulating-from-the-binomial-using-r">
         Simulating from the Binomial using R
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#method-of-moments-mom-estimators">
       Method of Moments (MoM) Estimators
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#mle-for-binomial-distribution">
       MLE for Binomial Distribution
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#likelihood-and-log-likelihood">
         Likelihood and Log Likelihood
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#computing-the-likelihood-and-mle-in-r">
       Computing the likelihood and MLE in R
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-midge-wing-length">
     Example: Midge Wing Length
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#non-bayesian-analysis">
     Non-Bayesian analysis
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-the-bayesian-model">
     Setting up the Bayesian Model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#prior-information">
       Prior Information
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#analytic-posterior">
     Analytic Posterior
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-prior-sensitivity">
     Exercise: Prior sensitivity
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#numerical-evaluation-of-the-posterior-with-jags">
     Numerical evaluation of the posterior with JAGS
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#specifying-the-model">
       Specifying the model
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#estimating-the-population-variance">
     Estimating the population variance
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-updating-the-bayesian-model">
     Exercise: Updating the Bayesian model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#aedes-data-revisited-using-bayesian-fitting">
     Aedes data revisited using Bayesian fitting
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-data">
       The Data
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#two-thermal-performance-curve-models">
       Two thermal performance curve models
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-thermal-response-model-file">
       The thermal response model file
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#running-diagnostics">
       Running diagnostics
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#plot-the-fits">
       Plot the fits
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#additional-analyses">
       Additional analyses
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-bayesian-model-fitting-of-abundance-data">
     A Bayesian model fitting of abundance data
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       The Data
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#specifying-the-growth-curve">
       Specifying the growth curve
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       The thermal response model file
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#additional-settings-for-jags">
       Additional settings for jags
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#fitting-the-model">
       Fitting the model
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#diagnostics">
       Diagnostics
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#visualizing-the-joint-posterior-of-parameters">
       Visualizing the joint posterior of parameters
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-posterior-distribution-of-the-mean-function">
       The posterior distribution of the mean function
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#readings-and-resources-a-id-readings-a">
   Readings and Resources
   <a id="Readings">
   </a>
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="model-fitting-in-ecology-and-evolution">
<h1>Model Fitting in Ecology and Evolution<a class="headerlink" href="#model-fitting-in-ecology-and-evolution" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>In this Chapter we will work through multiple techniques of model fitting to biological data using various examples. It is recommended that you see the <a class="reference external" href="https://github.com/mhasoba/TheMulQuaBio/tree/master/content/lectures/ModelFitting">lecture</a> on model fitting in Ecology and Evolution.</p>
<p>We will use R. For starters, clear all variables and graphic devices and load necessary packages:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">rm</span><span class="p">(</span><span class="n">list</span> <span class="o">=</span> <span class="nf">ls</span><span class="p">())</span>
<span class="nf">graphics.off</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="model-fitting-using-non-linear-least-squares">
<h2>Model fitting using Non-linear least squares<a class="headerlink" href="#model-fitting-using-non-linear-least-squares" title="Permalink to this headline">¶</a></h2>
<p>We will work with several practical examples here. These assume that you have at least a conceptual understanding of what Linear vs Non-linear models are, how they are fitted to data, and how the fits can be assessed statistically. If not, you may want to see the <a class="reference external" href="https://github.com/vectorbite/VBiTraining2/blob/master/lectures/LinearModels">Linear Models</a> (<a class="reference external" href="https://drive.google.com/drive/folders/12Sj56wHX6vcAnp9GE9qQ1gIXbn7QRHU2?usp=sharing">video here</a>) and <a class="reference external" href="https://github.com/mhasoba/TheMulQuaBio/blob/master/content/lectures/NLLS">NLLS</a> lectures first.</p>
<p>You will need the <code class="docutils literal notranslate"><span class="pre">nls.lm</span></code> R package, which you can install using the standard method (linux users, launch R in <code class="docutils literal notranslate"><span class="pre">sudo</span></code> mode first):</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="nf">install.packages</span><span class="p">(</span><span class="s">&quot;minpack.lm&quot;</span><span class="p">)</span> 
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<ul class="simple">
<li><p>Why <code class="docutils literal notranslate"><span class="pre">nls.lm</span></code> * ? The standard NLLS function in R, called <code class="docutils literal notranslate"><span class="pre">nls</span></code>, uses a less robust algorithm called the Gauss-Newton algorithm. Therefore, <code class="docutils literal notranslate"><span class="pre">nls</span></code> will often fail to fit your model to the data if you start off at starting values for the parameters that are too far from what the optimal values would be, especially if the “parameter space” is weirdly shaped, i.e., the model has a mathematical form that makes it hard to find parameter combinations that minimize the residual sum of squared (RSS). If this does not makes sense, don’t worry about it- just go with <code class="docutils literal notranslate"><span class="pre">nls_LM</span></code> from the <code class="docutils literal notranslate"><span class="pre">nls.lm</span></code> package instead of <code class="docutils literal notranslate"><span class="pre">nls</span></code>! If you are really curious, try substituting <code class="docutils literal notranslate"><span class="pre">nls</span></code> for <code class="docutils literal notranslate"><span class="pre">nls_LM</span></code> in the examples below and compare the results.</p></li>
</ul>
</div>
<p>Now load the <code class="docutils literal notranslate"><span class="pre">minpack.lm</span></code> package:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">require</span><span class="p">(</span><span class="s">&quot;minpack.lm&quot;</span><span class="p">)</span> <span class="c1"># for Levenberg-Marquardt nlls fitting</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="traits-data-as-an-example">
<h3>Traits data as an example<a class="headerlink" href="#traits-data-as-an-example" title="Permalink to this headline">¶</a></h3>
<p>Our first set of examples will focus on traits.</p>
<p>A trait is any measurable feature of an individual organism. This includes physical traits (e.g., morphology, body mass, wing length), performance traits (e.g., respiration rate, body velocity, fecundity), and behavioral traits (e.g., feeding preference, foraging strategy, mate choice). All natural populations show variation in traits across individuals. A trait is functional when it directly (e.g., mortality rate) or indirectly (e.g., somatic development or growth rate) determines individual fitness. Therefore, variation in (functional) traits can generate variation in the rate of increase and persistence of populations. When measured in the context of life cycles, without considering interactions with other organisms (e.g., predators or prey of the focal population), functional traits are typically called life history traits (such as mortality rate and fecundity). Other traits determine interactions both within the focal population (e.g., intra-specific interference or mating frequency) and between the focal population/species and others, including the species which may act as resources (prey, for example). Thus both life history and interaction traits determine population fitness and therefore abundance, which ultimately influences dynamics and functioning of the wider ecosystem, such as carbon fixation rate or disease transmission rate.</p>
<div class="section" id="allometric-scaling-of-traits">
<h4>Allometric scaling of traits<a class="headerlink" href="#allometric-scaling-of-traits" title="Permalink to this headline">¶</a></h4>
<p>Let’s start with a common and reasonably simple example from biology: <a class="reference external" href="https://en.wikipedia.org/wiki/Allometry">allometric scaling</a>. Allometric relationships between linear measurements such as body length, wing span, and thorax width are a good way to obtain estimates of body weights of individual organisms. We will look at allometric scaling of body weight vs. total body length in dragonflies and damselfiles.</p>
<p>Allometric relationships take the form:</p>
<div class="math notranslate nohighlight">
\[
y = a x^b
\]</div>
<p>where <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> are morphological measures (body length and body weight respectively, in our current example), the constant is the value of <span class="math notranslate nohighlight">\(y\)</span> at body length <span class="math notranslate nohighlight">\(x = 1\)</span> unit, and <span class="math notranslate nohighlight">\(b\)</span> is the scaling “exponent”. This is also called a power-law, because <span class="math notranslate nohighlight">\(y\)</span> relates to <span class="math notranslate nohighlight">\(x\)</span> through a simple power.</p>
<p>First create a function object for the power law model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">powMod</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
 <span class="nf">return</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="o">^</span><span class="n">b</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Now get the <a class="reference external" href="https://raw.githubusercontent.com/mhasoba/TheMulQuaBio/master/content/data/GenomeSize.csv">data</a> (first click on link and use “Save as” or <code class="docutils literal notranslate"><span class="pre">Ctrl+S</span></code> to download it as a csv). Then, save it in your <code class="docutils literal notranslate"><span class="pre">data</span></code> directory. After that, import it into your R workspace:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">MyData</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="s">&quot;../data/GenomeSize.csv&quot;</span><span class="p">)</span>

<span class="nf">head</span><span class="p">(</span><span class="n">MyData</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A data.frame: 6 × 16</caption>
<thead>
	<tr><th></th><th scope=col>Suborder</th><th scope=col>Family</th><th scope=col>Species</th><th scope=col>GenomeSize</th><th scope=col>GenomeSE</th><th scope=col>GenomeN</th><th scope=col>BodyWeight</th><th scope=col>TotalLength</th><th scope=col>HeadLength</th><th scope=col>ThoraxLength</th><th scope=col>AdbdomenLength</th><th scope=col>ForewingLength</th><th scope=col>HindwingLength</th><th scope=col>ForewingArea</th><th scope=col>HindwingArea</th><th scope=col>MorphologyN</th></tr>
	<tr><th></th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>Anisoptera</td><td>Aeshnidae</td><td>Aeshna canadensis   </td><td>2.20</td><td>  NA</td><td>1</td><td>0.159</td><td>67.58</td><td>6.83</td><td>11.81</td><td>48.94</td><td>45.47</td><td>45.40</td><td>369.57</td><td>483.61</td><td>2</td></tr>
	<tr><th scope=row>2</th><td>Anisoptera</td><td>Aeshnidae</td><td>Aeshna constricta   </td><td>1.76</td><td>0.06</td><td>4</td><td>0.228</td><td>71.97</td><td>6.84</td><td>10.72</td><td>54.41</td><td>46.00</td><td>45.48</td><td>411.15</td><td>517.38</td><td>3</td></tr>
	<tr><th scope=row>3</th><td>Anisoptera</td><td>Aeshnidae</td><td>Aeshna eremita      </td><td>1.85</td><td>  NA</td><td>1</td><td>0.312</td><td>78.80</td><td>6.27</td><td>16.19</td><td>56.33</td><td>51.24</td><td>49.47</td><td>460.72</td><td>574.33</td><td>1</td></tr>
	<tr><th scope=row>4</th><td>Anisoptera</td><td>Aeshnidae</td><td>Aeshna tuberculifera</td><td>1.78</td><td>0.10</td><td>2</td><td>0.218</td><td>72.44</td><td>6.62</td><td>12.53</td><td>53.29</td><td>49.84</td><td>48.82</td><td>468.74</td><td>591.42</td><td>2</td></tr>
	<tr><th scope=row>5</th><td>Anisoptera</td><td>Aeshnidae</td><td>Aeshna umbrosa      </td><td>2.00</td><td>  NA</td><td>1</td><td>0.207</td><td>73.05</td><td>4.92</td><td>11.11</td><td>57.03</td><td>46.51</td><td>45.97</td><td>382.48</td><td>481.44</td><td>1</td></tr>
	<tr><th scope=row>6</th><td>Anisoptera</td><td>Aeshnidae</td><td>Aeshna verticalis   </td><td>1.59</td><td>  NA</td><td>1</td><td>0.220</td><td>66.25</td><td>6.48</td><td>11.64</td><td>48.13</td><td>45.91</td><td>44.91</td><td>400.40</td><td>486.97</td><td>1</td></tr>
</tbody>
</table>
</div></div>
</div>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Dragonfly">Anisoptera</a> are dragonflies, and <a class="reference external" href="https://en.wikipedia.org/wiki/Damselfly">Zygoptera</a> are Damselflies. The variables of interest are <code class="docutils literal notranslate"><span class="pre">BodyWeight</span></code> and <code class="docutils literal notranslate"><span class="pre">TotalLength</span></code>. Let’s use the dragonflies data subset.</p>
<p>So subset the data accordingly and remove NAs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Data2Fit</span> <span class="o">&lt;-</span> <span class="nf">subset</span><span class="p">(</span><span class="n">MyData</span><span class="p">,</span><span class="n">Suborder</span> <span class="o">==</span> <span class="s">&quot;Anisoptera&quot;</span><span class="p">)</span>

<span class="n">Data2Fit</span> <span class="o">&lt;-</span> <span class="n">Data2Fit</span><span class="p">[</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">TotalLength</span><span class="p">),]</span> <span class="c1"># remove NA&#39;s</span>
</pre></div>
</div>
</div>
</div>
<p>Plot it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">TotalLength</span><span class="p">,</span> <span class="n">Data2Fit</span><span class="o">$</span><span class="n">BodyWeight</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_18_0.png" src="../_images/20-ModelFitting_18_0.png" />
</div>
</div>
<p>Or, using <code class="docutils literal notranslate"><span class="pre">ggplot</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="s">&quot;ggplot2&quot;</span><span class="p">)</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">Data2Fit</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">TotalLength</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">BodyWeight</span><span class="p">))</span> <span class="o">+</span> 
<span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="m">3</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;red&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span> 
<span class="nf">labs</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s">&quot;Body mass (mg)&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="s">&quot;Wing length (mm)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_20_0.png" src="../_images/20-ModelFitting_20_0.png" />
</div>
</div>
<ul class="simple">
<li><p>Remember, when you write this analysis into a stand-alone R script, you should put all commands for loading packages (<code class="docutils literal notranslate"><span class="pre">library()</span></code>, <code class="docutils literal notranslate"><span class="pre">require()</span></code>) at the start of the script. *</p></li>
</ul>
<p>Now fit the model to the data using NLLS:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">PowFit</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">BodyWeight</span> <span class="o">~</span> <span class="nf">powMod</span><span class="p">(</span><span class="n">TotalLength</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">data</span> <span class="o">=</span> <span class="n">Data2Fit</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">.</span><span class="m">1</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">.</span><span class="m">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Before proceeding further, have a look at what nlsLM’s arguments are:</p>
<div class="highlight-rscript notranslate"><div class="highlight"><pre><span></span>?nlsLM
</pre></div>
</div>
<p>Note that NLLS fitting requires “starting values” for the parameters (two in this case: <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>).</p>
<p>Having obtained the fit, we can use <code class="docutils literal notranslate"><span class="pre">summary()</span></code> just like we would for a <code class="docutils literal notranslate"><span class="pre">lm()</span></code> fit object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">summary</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Formula: BodyWeight ~ powMod(TotalLength, a, b)

Parameters:
   Estimate Std. Error t value Pr(&gt;|t|)    
a 3.941e-06  2.234e-06   1.764    0.083 .  
b 2.585e+00  1.348e-01  19.174   &lt;2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.02807 on 58 degrees of freedom

Number of iterations to convergence: 39 
Achieved convergence tolerance: 1.49e-08
</pre></div>
</div>
</div>
</div>
<p>Most of the output is analogous to the output of an <code class="docutils literal notranslate"><span class="pre">lm()</span></code>. However, further statistical inference here cannot be done using Analysis of Variance (ANOVA), because the model is not a Linear Model. Try <code class="docutils literal notranslate"><span class="pre">anova(PowFit)</span></code>, and see what happens. The <code class="docutils literal notranslate"><span class="pre">Number</span> <span class="pre">of</span> <span class="pre">iterations</span> <span class="pre">to</span> <span class="pre">convergence</span></code>, and <code class="docutils literal notranslate"><span class="pre">Achieved</span> <span class="pre">convergence</span> <span class="pre">tolerance</span></code> stem from the fact that NLLS fitting requires computer simulations; revisit the <a class="reference external" href="https://github.com/mhasoba/TheMulQuaBio/blob/master/lectures/NLLS">Lecture</a> for an explanation of this.</p>
<p>Now let’s visualize the fit. For this, first we need to generate a vector of body lengths (the x-axis variable) for plotting:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Lengths</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">TotalLength</span><span class="p">),</span><span class="nf">max</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">TotalLength</span><span class="p">),</span><span class="n">len</span><span class="o">=</span><span class="m">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, calculate the predicted line. For this, we will need to extract the coefficient from the model fit object using the <code class="docutils literal notranslate"><span class="pre">coef()</span></code>command.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">coef</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)[</span><span class="s">&quot;a&quot;</span><span class="p">]</span>
<span class="nf">coef</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)[</span><span class="s">&quot;b&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><strong>a:</strong> 3.94068495559397e-06</div><div class="output text_html"><strong>b:</strong> 2.58504796499038</div></div>
</div>
<p>So, we can do the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Predic2PlotPow</span> <span class="o">&lt;-</span> <span class="nf">powMod</span><span class="p">(</span><span class="n">Lengths</span><span class="p">,</span><span class="nf">coef</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)[</span><span class="s">&quot;a&quot;</span><span class="p">],</span><span class="nf">coef</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)[</span><span class="s">&quot;b&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Now plot the data and the fitted model line:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">Exercisesplot</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">TotalLength</span><span class="p">,</span> <span class="n">Data2Fit</span><span class="o">$</span><span class="n">BodyWeight</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">Lengths</span><span class="p">,</span> <span class="n">Predic2PlotPow</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">lwd</span> <span class="o">=</span> <span class="m">2.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span>Error in Exercisesplot(Data2Fit$TotalLength, Data2Fit$BodyWeight): could not find function &quot;Exercisesplot&quot;
Traceback:
</pre></div>
</div>
</div>
</div>
<p>We can claculate the confidence intervals on the estimated parameters as we would in OLS fitting used for Linear Models:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">confint</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Waiting for profiling to be done...
</pre></div>
</div>
<div class="output text_html"><table>
<caption>A matrix: 2 × 2 of type dbl</caption>
<thead>
	<tr><th></th><th scope=col>2.5%</th><th scope=col>97.5%</th></tr>
</thead>
<tbody>
	<tr><th scope=row>a</th><td>1.171935e-06</td><td>1.205273e-05</td></tr>
	<tr><th scope=row>b</th><td>2.318292e+00</td><td>2.872287e+00</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>As you likely have learnt before, a coefficient’s CI should not include zero for it to be statistically significant (different from zero).</p>
<div class="section" id="exercises-a-id-allom-exercises-a">
<h5>Exercises <a id='Allom_Exercises'></a><a class="headerlink" href="#exercises-a-id-allom-exercises-a" title="Permalink to this headline">¶</a></h5>
<p>(a) Make the same plot as above, fitted line and all, in <code class="docutils literal notranslate"><span class="pre">ggplot</span></code>, and add (display) the equation you estimated to your new (ggplot) plot. The equation is: <span class="math notranslate nohighlight">\(\text{Weight} = 3.94 \times 10^{-06} \times \text{Length}^{2.59}\)</span></p>
<p>(b) Try playing with the starting values, and see if you can “break” the model fitting – that is, change the starting values till the NLLS fitting does not converge on a solution.</p>
<p>(c) Repeat the model fitting (including a-b above) using the Zygoptera data subset.</p>
<p>(d) There is an alternative (and in fact, more commonly-used) approach for fitting the allometric model to data: using Ordinary Least Squares on bi-logarithamically transformed data. That is, if you take a log of both sides of the <a class="reference external" href="#eq:allom">allometric equation</a> we get,</p>
<div class="math notranslate nohighlight">
\[
\log(y) = \log(a) + b \log(x)
\]</div>
<p>This is a straight line equation of the form <span class="math notranslate nohighlight">\(c = d + b z \)</span>, where <span class="math notranslate nohighlight">\(c = \log(c)\)</span>, <span class="math notranslate nohighlight">\(d = \log(a)\)</span>, <span class="math notranslate nohighlight">\(z = \log(x)\)</span>, and <span class="math notranslate nohighlight">\(b\)</span> is now the slope parameter. So you can use Ordinary Least Squares and the linear models framework (with <code class="docutils literal notranslate"><span class="pre">lm()</span></code>) in R to estimate the parameters of the allometric equation.</p>
<p>In this exercise, try comparing the NLLS vs OLS methods to see how much difference you get in the parameter estimates between them. For example, see the methods used in this paper by <a class="reference external" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3465447/">Cohen et al 2012</a>.</p>
<p>(e) The allometry between Body weight and Length is not the end of the story. You have a number of other linear morphological measurements (<code class="docutils literal notranslate"><span class="pre">HeadLength</span></code>, <code class="docutils literal notranslate"><span class="pre">ThoraxLength</span></code>, <code class="docutils literal notranslate"><span class="pre">AdbdomenLength</span></code>, <code class="docutils literal notranslate"><span class="pre">ForewingLength</span></code>, <code class="docutils literal notranslate"><span class="pre">HindwingLength</span></code>, <code class="docutils literal notranslate"><span class="pre">ForewingArea</span></code>, and <code class="docutils literal notranslate"><span class="pre">HindwingArea</span></code>) that can also be investigated. In this exercise, try two lines of investigation (again, repeated separately for Dragonflies and Damselfiles):</p>
<p>(i) How do each of these measures allometrically scale with Body length (obtain estimates of scaling constant and exponent)? (Hint: you may want to use the <code class="docutils literal notranslate"><span class="pre">pairs()</span></code> command in R to get an overview of all the pairs of potential scaling relationships.</p>
<p>(ii) Do any of the linear morphological measurements other than body length better predict Body weight? That is, does body weight scale more tightly with a linear morphological measurement other than total body length? You would use model selection here, which we will learn next. But for now, you can just look at and compare the <span class="math notranslate nohighlight">\(R^2\)</span> values of the models.</p>
</div>
</div>
<div class="section" id="comparing-models">
<span id="model-fitting-r-comparing-models"></span><h4>Comparing models<a class="headerlink" href="#comparing-models" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>How do we know that there isn’t a better or alternative model that adequately explains the pattern in your dataset? *</p></li>
</ul>
<p>This is important consideration in all data analyses (and more generally, the scientific method!), so you must aim to compare your NLLS model with an one or more alternatives for a more extensive and reliable investigation of the problem.</p>
<p>Let’s use model comparison to investigate whether the relationship between body weight and length we found above is indeed allometric. For this, we need an alternative model that can be fitted to the same data. Let’s try a quadratic curve, which is of the form:</p>
<div class="math notranslate nohighlight">
\[
y = a + b x + c x^2
\]</div>
<p>This can also capture curvature in data, and is an alternative model to the <a class="reference external" href="#eq:allom">allometric equation</a>. Note that this mode is linear in its parameters (a linear model), which you can fit to the simply data using your familiar <code class="docutils literal notranslate"><span class="pre">lm()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">QuaFit</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">BodyWeight</span> <span class="o">~</span> <span class="nf">poly</span><span class="p">(</span><span class="n">TotalLength</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">data</span> <span class="o">=</span> <span class="n">Data2Fit</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And like before, we obtain the predicted values (but this time using the <code class="docutils literal notranslate"><span class="pre">predict.lm</span></code> function):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Predic2PlotQua</span> <span class="o">&lt;-</span> <span class="nf">predict.lm</span><span class="p">(</span><span class="n">QuaFit</span><span class="p">,</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">TotalLength</span> <span class="o">=</span> <span class="n">Lengths</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s plot the two fitted models together:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">TotalLength</span><span class="p">,</span> <span class="n">Data2Fit</span><span class="o">$</span><span class="n">BodyWeight</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">Lengths</span><span class="p">,</span> <span class="n">Predic2PlotPow</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">lwd</span> <span class="o">=</span> <span class="m">2.5</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">Lengths</span><span class="p">,</span> <span class="n">Predic2PlotQua</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">lwd</span> <span class="o">=</span> <span class="m">2.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_44_0.png" src="../_images/20-ModelFitting_44_0.png" />
</div>
</div>
<p>Very similar fits, except that the quadratic model seems to deviate a bit from the data at the lower end of the data range. Let’s do a proper, formal model comparison now to check which model better-fits the data.</p>
<p>First calculate the R<span class="math notranslate nohighlight">\(^2\)</span> values of the two fitted models:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">RSS_Pow</span> <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">(</span><span class="nf">residuals</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="c1"># Residual sum of squares</span>
<span class="n">TSS_Pow</span> <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">((</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">BodyWeight</span> <span class="o">-</span> <span class="nf">mean</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">BodyWeight</span><span class="p">))</span><span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="c1"># Total sum of squares</span>
<span class="n">RSq_Pow</span> <span class="o">&lt;-</span> <span class="m">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">RSS_Pow</span><span class="o">/</span><span class="n">TSS_Pow</span><span class="p">)</span> <span class="c1"># R-squared value</span>

<span class="n">RSS_Qua</span> <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">(</span><span class="nf">residuals</span><span class="p">(</span><span class="n">QuaFit</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="c1"># Residual sum of squares</span>
<span class="n">TSS_Qua</span> <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">((</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">BodyWeight</span> <span class="o">-</span> <span class="nf">mean</span><span class="p">(</span><span class="n">Data2Fit</span><span class="o">$</span><span class="n">BodyWeight</span><span class="p">))</span><span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="c1"># Total sum of squares</span>
<span class="n">RSq_Qua</span> <span class="o">&lt;-</span> <span class="m">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">RSS_Qua</span><span class="o">/</span><span class="n">TSS_Qua</span><span class="p">)</span> <span class="c1"># R-squared value</span>

<span class="n">RSq_Pow</span> 
<span class="n">RSq_Qua</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.90054752976309</div><div class="output text_html">0.900302864503218</div></div>
</div>
<p>Not very useful. In general, R<span class="math notranslate nohighlight">\(^2\)</span> is a good measure of model fit, but cannot be used for model selection – epecially not here, given the tiny difference in R<span class="math notranslate nohighlight">\(^2\)</span>’s.</p>
<p>Instead, as explained in the <a class="reference external" href="https://github.com/mhasoba/TheMulQuaBio/blob/master/lectures/ModelFitting">lecture</a>, we can use the Akaike Information Criterion (AIC):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">Data2Fit</span><span class="p">)</span> <span class="c1">#set sample size</span>
<span class="n">pPow</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="nf">coef</span><span class="p">(</span><span class="n">PowFit</span><span class="p">))</span> <span class="c1"># get number of parameters in power law model</span>
<span class="n">pQua</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="nf">coef</span><span class="p">(</span><span class="n">QuaFit</span><span class="p">))</span> <span class="c1"># get number of parameters in quadratic model</span>

<span class="n">AIC_Pow</span> <span class="o">&lt;-</span> <span class="n">n</span> <span class="o">+</span> <span class="m">2</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="nf">log</span><span class="p">((</span><span class="m">2</span> <span class="o">*</span> <span class="kc">pi</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="nf">log</span><span class="p">(</span><span class="n">RSS_Pow</span><span class="p">)</span> <span class="o">+</span> <span class="m">2</span> <span class="o">*</span> <span class="n">pPow</span>
<span class="n">AIC_Qua</span> <span class="o">&lt;-</span> <span class="n">n</span> <span class="o">+</span> <span class="m">2</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="nf">log</span><span class="p">((</span><span class="m">2</span> <span class="o">*</span> <span class="kc">pi</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="nf">log</span><span class="p">(</span><span class="n">RSS_Qua</span><span class="p">)</span> <span class="o">+</span> <span class="m">2</span> <span class="o">*</span> <span class="n">pQua</span>
<span class="n">AIC_Pow</span> <span class="o">-</span> <span class="n">AIC_Qua</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">-2.14742608125084</div></div>
</div>
<p>Of course, as you might have suspected, we can do this using an in-built function in R!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">AIC</span><span class="p">(</span><span class="n">PowFit</span><span class="p">)</span> <span class="o">-</span> <span class="nf">AIC</span><span class="p">(</span><span class="n">QuaFit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">-2.1474260812509</div></div>
</div>
<ul class="simple">
<li><p>So which model wins? * As we had dicussed in the NLLS lecture, a rule of thumb is that a AIC value difference (typically denoted as <span class="math notranslate nohighlight">\(\Delta\)</span>AIC) &gt; 2 is a acceptable cutoff for calling a winner. So the power law (allometric model) is a better fit here. Read the <a class="reference external" href="https://github.com/mhasoba/TheMulQuaBio/blob/master/readings/Modelling/JohnsonOmland2004.pdf">Johnson &amp; Omland paper</a> for more on model selection in Ecology and Evolution.</p></li>
</ul>
</div>
<div class="section" id="exercises-a-id-modelselection-exercises-a">
<h4>Exercises <a id='ModelSelection_Exercises'></a><a class="headerlink" href="#exercises-a-id-modelselection-exercises-a" title="Permalink to this headline">¶</a></h4>
<p>(a) Calculate the Bayesian Information Criterion (BIC), also know as the Schwarz Criterion (see your Lecture notes and the <a class="reference external" href="https://github.com/mhasoba/TheMulQuaBio/blob/master/readings/Modelling/JohnsonOmland2004.pdf">Johnson &amp; Omland paper</a>, and use <span class="math notranslate nohighlight">\(\Delta\)</span>BIC to select the better fitting model.</p>
<p>(b) Fit a straight line to the same data and compare with the allometric and quadratic models.</p>
<p>(c) Repeat the model comparison (incuding 1-2 above) using the Damselflies (Zygoptera) data subset – does the allometric model still win?</p>
<p>(d) Repeat exercise (e)(i) and (ii) from the <a class="reference external" href="#Allom_Exercises">above set</a>, but with model comparison (e.g., again using a quadratic as an alternative model) to establish that the relationships are indeed allometric.</p>
<p>(e) Repeat exercise (e)(ii) from the <a class="reference external" href="#Allom_Exercises">above set</a>, but with model comparison to establish which linear measurement is the best predictor of Body weight.</p>
</div>
<div class="section" id="albatross-chick-growth">
<h4>Albatross chick growth<a class="headerlink" href="#albatross-chick-growth" title="Permalink to this headline">¶</a></h4>
<p>Now let’s look at a different trait example: the growth of an individual albatross chick (you can find similar data for vector and non-vector arthropods in <a class="reference external" href="https://vectorbyte.org/">VecTraits</a>). First load and plot the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">alb</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="s">&quot;../data/albatross_grow.csv&quot;</span><span class="p">)</span>
<span class="n">alb</span> <span class="o">&lt;-</span> <span class="nf">subset</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">alb</span><span class="p">,</span> <span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">alb</span><span class="o">$</span><span class="n">wt</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">alb</span><span class="o">$</span><span class="n">age</span><span class="p">,</span> <span class="n">alb</span><span class="o">$</span><span class="n">wt</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;age (days)&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;weight (g)&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_54_0.png" src="../_images/20-ModelFitting_54_0.png" />
</div>
</div>
<div class="section" id="fitting-the-three-models-using-nlls">
<h5>Fitting the three models using NLLS<a class="headerlink" href="#fitting-the-three-models-using-nlls" title="Permalink to this headline">¶</a></h5>
<p>Let’s fit multiple models to this dataset.</p>
<p>The Von Bertalanffy model is commonly used for modelling the growth of an individual. It’s formulation is:</p>
<div class="math notranslate nohighlight">
\[
W(t) = \rho (L_{\infty}(1-e^{-Kt})+L_0 e^{-Kt})^3
\]</div>
<p>If we pull out <span class="math notranslate nohighlight">\(L_{\infty}\)</span> and define <span class="math notranslate nohighlight">\(c=L_0/L_{\infty}\)</span> and <span class="math notranslate nohighlight">\(W_{\infty}=\rho L_{\infty}^3\)</span> this equation becomes:</p>
<div class="math notranslate nohighlight">
\[
W(t) = W_{\infty}(1-e^{-Kt}+ c e^{-Kt})^3.
\]</div>
<p><span class="math notranslate nohighlight">\(W_{\infty}\)</span> is interpreted as the mean asymptotic weight, and <span class="math notranslate nohighlight">\(c\)</span> the ratio between the initial and final lengths. This second equation is the one we will fit.</p>
<p>We will compare this model against the classical Logistic growth equation and a straight line.</p>
<p>The logistic equation is:</p>
<div class="math notranslate nohighlight">
\[
N_t = \frac{N_0 K e^{r t}}{K + N_0 (e^{r t} - 1)}
\]</div>
<p>Here <span class="math notranslate nohighlight">\(N_t\)</span> is population size at time <span class="math notranslate nohighlight">\(t\)</span>, <span class="math notranslate nohighlight">\(N_0\)</span> is initial population size, <span class="math notranslate nohighlight">\(r\)</span> is maximum growth rate (AKA <span class="math notranslate nohighlight">\(r_\text{max}\)</span>), and <span class="math notranslate nohighlight">\(K\)</span> is carrying capacity.</p>
<p>First, as we did before, let’s define the R functions for the two models:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">logistic1</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">N0</span><span class="p">){</span>
 <span class="n">N0</span> <span class="o">*</span> <span class="n">K</span> <span class="o">*</span> <span class="nf">exp</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">K</span><span class="o">+</span><span class="n">N0</span> <span class="o">*</span> <span class="p">(</span><span class="nf">exp</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span><span class="m">-1</span><span class="p">))</span>
<span class="p">}</span>

<span class="n">vonbert.w</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Winf</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">K</span><span class="p">){</span>
 <span class="n">Winf</span> <span class="o">*</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> <span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="n">K</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="n">K</span> <span class="o">*</span> <span class="n">t</span><span class="p">))</span><span class="o">^</span><span class="m">3</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>For the straight line, we use simply use R’s <code class="docutils literal notranslate"><span class="pre">lm()</span></code> function, as that is a linear least squares problem. Using NLLS will give (approximately) the same answer, of course. Now fit all 3 models using least squares.</p>
<p>We will scale the data before fitting to improve the stability of the estimates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">scale</span> <span class="o">&lt;-</span> <span class="m">4000</span>

<span class="n">alb.lin</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">wt</span><span class="o">/</span><span class="n">scale</span> <span class="o">~</span> <span class="n">age</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">alb</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">alb.log</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">wt</span><span class="o">/</span><span class="n">scale</span><span class="o">~</span><span class="nf">logistic1</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">N0</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">K</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="m">0.1</span><span class="p">,</span> <span class="n">N0</span><span class="o">=</span><span class="m">0.1</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">alb</span><span class="p">)</span>

<span class="n">alb.vb</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">wt</span><span class="o">/</span><span class="n">scale</span><span class="o">~</span><span class="nf">vonbert.w</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">Winf</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">K</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">Winf</span><span class="o">=</span><span class="m">0.75</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="m">0.01</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="m">0.01</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">alb</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next let’s calculate predictions for each of the models across a range of ages.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">ages</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="m">1000</span><span class="p">)</span>

<span class="n">pred.lin</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">alb.lin</span><span class="p">,</span> <span class="n">newdata</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="n">ages</span><span class="p">))</span> <span class="o">*</span> <span class="n">scale</span>

<span class="n">pred.log</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">alb.log</span><span class="p">,</span> <span class="n">newdata</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="n">ages</span><span class="p">))</span> <span class="o">*</span> <span class="n">scale</span>

<span class="n">pred.vb</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">alb.vb</span><span class="p">,</span> <span class="n">newdata</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="n">ages</span><span class="p">))</span> <span class="o">*</span> <span class="n">scale</span>
</pre></div>
</div>
</div>
</div>
<p>And finally plot the data with the fits:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">alb</span><span class="o">$</span><span class="n">age</span><span class="p">,</span> <span class="n">alb</span><span class="o">$</span><span class="n">wt</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;age (days)&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;weight (g)&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">100</span><span class="p">))</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">pred.lin</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">pred.log</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="m">3</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">pred.vb</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>

<span class="nf">legend</span><span class="p">(</span><span class="s">&quot;topleft&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;linear&quot;</span><span class="p">,</span> <span class="s">&quot;logistic&quot;</span><span class="p">,</span> <span class="s">&quot;Von Bert&quot;</span><span class="p">),</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lty</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="m">2</span><span class="o">:</span><span class="m">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_63_0.png" src="../_images/20-ModelFitting_63_0.png" />
</div>
</div>
<p>Next examine the residuals between the 3 models:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> <span class="n">bty</span><span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">alb</span><span class="o">$</span><span class="n">age</span><span class="p">,</span> <span class="nf">resid</span><span class="p">(</span><span class="n">alb.lin</span><span class="p">),</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;LM resids&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">100</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">alb</span><span class="o">$</span><span class="n">age</span><span class="p">,</span> <span class="nf">resid</span><span class="p">(</span><span class="n">alb.log</span><span class="p">),</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;Logisitic resids&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">100</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">alb</span><span class="o">$</span><span class="n">age</span><span class="p">,</span> <span class="nf">resid</span><span class="p">(</span><span class="n">alb.vb</span><span class="p">),</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;VB resids&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_65_0.png" src="../_images/20-ModelFitting_65_0.png" />
</div>
</div>
<p>The residuals for all 3 models still exhibit some patterns. In particular, the data seems to go down near the end of the observation period, but none of these models can capture that behavior.</p>
<p>Finally, let’s compare the 3 models using a simpler approach than the AIC/BIC one that we used <a class="reference external" href="#Allom_Exercises">above</a> by calculating adjusted Sums of Squared Errors (SSE’s):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">alb</span><span class="o">$</span><span class="n">wt</span><span class="p">)</span>
<span class="nf">list</span><span class="p">(</span><span class="n">lin</span><span class="o">=</span><span class="nf">signif</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="nf">resid</span><span class="p">(</span><span class="n">alb.lin</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="m">-2</span> <span class="o">*</span> <span class="m">2</span><span class="p">),</span> <span class="m">3</span><span class="p">),</span> 
 <span class="n">log</span><span class="o">=</span> <span class="nf">signif</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="nf">resid</span><span class="p">(</span><span class="n">alb.log</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="m">-2</span> <span class="o">*</span> <span class="m">3</span><span class="p">),</span> <span class="m">3</span><span class="p">),</span> 
 <span class="n">vb</span><span class="o">=</span> <span class="nf">signif</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="nf">resid</span><span class="p">(</span><span class="n">alb.vb</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="m">-2</span> <span class="o">*</span> <span class="m">3</span><span class="p">),</span> <span class="m">3</span><span class="p">))</span>   
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><dl>
	<dt>$lin</dt>
		<dd>0.00958</dd>
	<dt>$log</dt>
		<dd>0.0056</dd>
	<dt>$vb</dt>
		<dd>0.00628</dd>
</dl>
</div></div>
</div>
<p>The adjusted SSE accounts for sample size and number of parameters by dividing the RSS by the residual degrees of freedom. Adjusted SSE can also be used for model selection like AIC/BIC (but is less robust than AIC/BIC). The residual degrees of freedom is calculated as the number of response values (sample size, <span class="math notranslate nohighlight">\(n\)</span>) minus 2, times the number of fitted coefficients <span class="math notranslate nohighlight">\(m\)</span> (= 2 or 3 in this case) estimated.</p>
<p>The logistic model has the lowest adjusted SSE, so it’s the best by this measure. It is also, visually, a better fit.</p>
</div>
</div>
<div class="section" id="exercises-a-id-albatross-exercises-a">
<h4>Exercises <a id='Albatross_Exercises'></a><a class="headerlink" href="#exercises-a-id-albatross-exercises-a" title="Permalink to this headline">¶</a></h4>
<p>(a) Use AIC/BIC to perform model selection on the Albatross data as we did for the trait allometry example.</p>
<p>(b) Write this example as a self-sufficient R script, with ggplot istead of base plotting</p>
</div>
<div class="section" id="aedes-aegypti-fecundity">
<h4>Aedes aegypti fecundity<a class="headerlink" href="#aedes-aegypti-fecundity" title="Permalink to this headline">¶</a></h4>
<p>Now let’s look at a disease vector example. These data measure the reponse of * Aedes aegypti * fecundity to temperature.</p>
<p>First load and visualize the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">aedes</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="s">&quot;../data/aedes_fecund.csv&quot;</span><span class="p">)</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">aedes</span><span class="o">$</span><span class="bp">T</span><span class="p">,</span> <span class="n">aedes</span><span class="o">$</span><span class="n">EFD</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;temperature (C)&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;Eggs/day&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_71_0.png" src="../_images/20-ModelFitting_71_0.png" />
</div>
</div>
<div class="section" id="the-thermal-performance-curve-models">
<span id="model-fitting-nlls-tpcs"></span><h5>The Thermal Performance Curve models<a class="headerlink" href="#the-thermal-performance-curve-models" title="Permalink to this headline">¶</a></h5>
<p>Let’s define some models for Thermal Performance Curves:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">quad1</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="bp">T</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">Tm</span><span class="p">,</span> <span class="n">c</span><span class="p">){</span>
 <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="bp">T</span><span class="o">-</span><span class="n">T0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">T</span><span class="o">-</span><span class="n">Tm</span><span class="p">)</span> <span class="o">*</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="bp">T</span><span class="o">&lt;</span><span class="n">Tm</span><span class="p">)</span> <span class="o">*</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="bp">T</span><span class="o">&gt;</span><span class="n">T0</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Instead of using the inbuilt quadratic function in R, we we defined our own to make it easier to choose starting values, and so that we can force the function to be equal to zero above and below the minimum and maximum temperature thresholds (more on this below).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">briere</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="bp">T</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">Tm</span><span class="p">,</span> <span class="n">c</span><span class="p">){</span>
 <span class="n">c</span> <span class="o">*</span> <span class="bp">T</span> <span class="o">*</span> <span class="p">(</span><span class="bp">T</span><span class="o">-</span><span class="n">T0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">Tm</span><span class="o">-</span><span class="bp">T</span><span class="p">)</span><span class="o">^</span><span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="m">2</span><span class="p">))</span> <span class="o">*</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="bp">T</span><span class="o">&lt;</span><span class="n">Tm</span><span class="p">)</span> <span class="o">*</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="bp">T</span><span class="o">&gt;</span><span class="n">T0</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>The Briere function is a commonly used model for temperature dependence of insect traits. See here <a class="reference internal" href="Appendix-MiniProj.html#miniproj-tpcs-models"><span class="std std-ref">section</span></a> for more info. Unlike the original <a class="reference internal" href="Appendix-MiniProj.html#miniproj-tpcs-models"><span class="std std-ref">model definition</span></a>, we have used <code class="docutils literal notranslate"><span class="pre">abs()</span></code> to allow the NLLS algorithm to explore the full parameter space of <span class="math notranslate nohighlight">\(T_m\)</span>; if we did not do this, the NLLS could fail as soon as a value of <span class="math notranslate nohighlight">\(T_m &lt; T\)</span> was reached during the optimization, because the <a class="reference external" href="https://en.wikipedia.org/wiki/Square_root">square root of a negative number is complex</a>. Another way to deal with this issue is to set parameter bounds on <span class="math notranslate nohighlight">\(T_m\)</span> so that it is can never be less than T. However, this is a more technical approach that we will not go into here.</p>
<p>As in the case of the albatross growth data, we will also compare the above two models with a * straight line * (again, its a linear model, so we can just use <code class="docutils literal notranslate"><span class="pre">lm()</span></code> without needing to define a function for it).</p>
<p>Now fit all 3 models using least squares. Although it’s not as necessary here (as the data don’t have as large values as the albatross example), lets again scale the data first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">scale</span> <span class="o">&lt;-</span> <span class="m">20</span>

<span class="n">aed.lin</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">EFD</span><span class="o">/</span><span class="n">scale</span> <span class="o">~</span> <span class="bp">T</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">aedes</span><span class="p">)</span>

<span class="n">aed.quad</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">EFD</span><span class="o">/</span><span class="n">scale</span><span class="o">~</span><span class="nf">quad1</span><span class="p">(</span><span class="bp">T</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">Tm</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">T0</span><span class="o">=</span><span class="m">10</span><span class="p">,</span> <span class="n">Tm</span><span class="o">=</span><span class="m">40</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="m">0.01</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">aedes</span><span class="p">)</span>

<span class="n">aed.br</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">EFD</span><span class="o">/</span><span class="n">scale</span><span class="o">~</span><span class="nf">briere</span><span class="p">(</span><span class="bp">T</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">Tm</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">T0</span><span class="o">=</span><span class="m">10</span><span class="p">,</span> <span class="n">Tm</span><span class="o">=</span><span class="m">40</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="m">0.1</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">aedes</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="exercises-a-id-aedes-exercises-a">
<h5>Exercises <a id='Aedes_Exercises'></a><a class="headerlink" href="#exercises-a-id-aedes-exercises-a" title="Permalink to this headline">¶</a></h5>
<p>(a) Complete the * Aedes * data analysis by fitting the models, calculating predictions and then comparing models. Write a single, self-standing script for it. Which model fits best? By what measure?</p>
<p>(b) In this script, use ggplot instead of base plotting.</p>
</div>
</div>
</div>
<div class="section" id="abundances-as-an-example">
<h3>Abundances as an example<a class="headerlink" href="#abundances-as-an-example" title="Permalink to this headline">¶</a></h3>
<p>Fluctuations in the abundance (density) of single populations may play a crucial role in ecosystem dynamics and emergent functional characteristics, such as rates of carbon fixation or disease transmission. For example, if vector population densities or their traits change at the same or shorter timescales than the rate of disease transmission, then (vector) abundance fluctuations can cause significant fluctuations in disease transmission rates. Indeed, most disease vectors are small ectotherms with short generation times and greater sensitivity to environmental conditions than their (invariably larger, longer-lived, and often, endothermic) hosts. So understanding how populations vary over time, space, and with respect to environmental variables such as temperature and precipitation is key. We will look at fitting models to the growth of a single population here.</p>
<div class="section" id="population-growth-rates">
<span id="model-fitting-r-population-growth"></span><h4>Population growth rates<a class="headerlink" href="#population-growth-rates" title="Permalink to this headline">¶</a></h4>
<p>A population grows exponentially while its abundance is low and resources are not limiting (the Malthusian principle). This growth then slows and eventually stops as resources become limiting. There may also be a time lag before the population growth really takes off at the start. We will focus on microbial (specifically, bacterial) growth rates. Bacterial growth in batch culture follows a distinct set of phases; lag phase, exponential phase and stationary phase. During the lag phase a suite of transcriptional machinery is activated, including genes involved in nutrient uptake and metabolic changes, as bacteria prepare for growth. During the exponential growth phase, bacteria divide at a constant rate, the population doubling with each generation. When the carrying capacity of the media is reached, growth slows and the number of cells in the culture stabilizes, beginning the stationary phase.</p>
<p>Traditionally, microbial growth rates were measured by plotting cell numbers or culture density against time on a semi-log graph and fitting a straight line through the exponential growth phase – the slope of the line gives the maximum growth rate (<span class="math notranslate nohighlight">\(r_{max}\)</span>). Models have since been developed which we can use to describe the whole sigmoidal bacterial growth curve (e.g., using NLLS). Here we will take a look at these different approaches, from applying linear models to the exponential phase, through to fitting non-linear models to the full growth curve.</p>
<p>Let’s first generate some “data” on the number of bacterial cells as a function of time that we can play with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">22</span><span class="p">,</span> <span class="m">2</span><span class="p">)</span>
<span class="n">N</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">32500</span><span class="p">,</span> <span class="m">33000</span><span class="p">,</span> <span class="m">38000</span><span class="p">,</span> <span class="m">105000</span><span class="p">,</span> <span class="m">445000</span><span class="p">,</span> <span class="m">1430000</span><span class="p">,</span> <span class="m">3020000</span><span class="p">,</span> <span class="m">4720000</span><span class="p">,</span> <span class="m">5670000</span><span class="p">,</span> <span class="m">5870000</span><span class="p">,</span> <span class="m">5930000</span><span class="p">,</span> <span class="m">5940000</span><span class="p">)</span>

<span class="nf">set.seed</span><span class="p">(</span><span class="m">1234</span><span class="p">)</span> <span class="c1"># set seed to ensure you always get the same random sequence </span>

<span class="n">data</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="p">(</span><span class="m">1</span> <span class="o">+</span> <span class="nf">rnorm</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">sd</span> <span class="o">=</span> <span class="m">0.1</span><span class="p">)))</span> <span class="c1"># add some random error</span>

<span class="nf">names</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;Time&quot;</span><span class="p">,</span> <span class="s">&quot;N&quot;</span><span class="p">)</span>

<span class="nf">head</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A data.frame: 6 × 2</caption>
<thead>
	<tr><th></th><th scope=col>Time</th><th scope=col>N</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td> 0</td><td>  28577.04</td></tr>
	<tr><th scope=row>2</th><td> 2</td><td>  33915.52</td></tr>
	<tr><th scope=row>3</th><td> 4</td><td>  42120.88</td></tr>
	<tr><th scope=row>4</th><td> 6</td><td>  80370.17</td></tr>
	<tr><th scope=row>5</th><td> 8</td><td> 464096.05</td></tr>
	<tr><th scope=row>6</th><td>10</td><td>1502365.99</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>Note how we added some random “sampling” error using <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">*</span> <span class="pre">(1</span> <span class="pre">+</span> <span class="pre">rnorm(length(t),</span> <span class="pre">sd</span> <span class="pre">=</span> <span class="pre">.1))</span></code>.</p>
<p>This means that we are adding an error at each time point <span class="math notranslate nohighlight">\(t\)</span> (let’s call this fluctuation <span class="math notranslate nohighlight">\(\epsilon_t\)</span>) as a * percentage * of the population (<span class="math notranslate nohighlight">\(N_t\)</span>) at that time point in a vectorized way. That is, we are performing the operation <span class="math notranslate nohighlight">\(N_t \times (1 + \epsilon_t)\)</span> at all time points at one go. This is important to note because this is often the way that errors appear – proportional to the value being measured.</p>
<p>Now let’s plot these data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="p">))</span> <span class="o">+</span> 
 <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&quot;Time (Hours)&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s">&quot;Population size (cells)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_83_0.png" src="../_images/20-ModelFitting_83_0.png" />
</div>
</div>
</div>
<div class="section" id="basic-approach">
<h4>Basic approach<a class="headerlink" href="#basic-approach" title="Permalink to this headline">¶</a></h4>
<p>The size of an exponentially growing population (<span class="math notranslate nohighlight">\(N\)</span>) at any given time (<span class="math notranslate nohighlight">\(t\)</span>) is given by:</p>
<p><span class="math notranslate nohighlight">\(
N(t) = N_0 \cdot e^{rt} ,
\)</span></p>
<p>where <span class="math notranslate nohighlight">\(N_0\)</span> is the initial population size and <span class="math notranslate nohighlight">\(r\)</span> is the growth rate. We can re-arrange this to give:</p>
<p><span class="math notranslate nohighlight">\(
r = \frac{\log(N(t)) - \log(N_0)}{t} ,
\)</span></p>
<p>That is, in exponential growth at a constant rate, the growth rate can be simply calculated as the difference in the log of two population sizes, over time. We will log-transform the data and estimate by eye where growth looks exponential.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span> <span class="o">&lt;-</span> <span class="nf">log</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">N</span><span class="p">)</span>

<span class="c1"># visualise</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">LogN</span><span class="p">))</span> <span class="o">+</span> 
 <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&quot;Time (Hours)&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s">&quot;log(cell number)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_85_0.png" src="../_images/20-ModelFitting_85_0.png" />
</div>
</div>
<p>By eye the logged data looks fairly linear (beyond the initial “lag phase” of growth; see below) between hours 5 and 10, so we’ll use that time-period to calculate the growth rate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">$</span><span class="n">Time</span> <span class="o">==</span> <span class="m">10</span><span class="p">,]</span><span class="o">$</span><span class="n">LogN</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">$</span><span class="n">Time</span> <span class="o">==</span> <span class="m">6</span><span class="p">,]</span><span class="o">$</span><span class="n">LogN</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="m">10-6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.732038333517017</div></div>
</div>
<p>This is our first, most basic estimate of <span class="math notranslate nohighlight">\(r\)</span>.</p>
<p>Or, we can decide not to eyeball the data, but just pick the maximum observed gradient of the curve. For this, we can use the the <code class="docutils literal notranslate"><span class="pre">diff()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">diff</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>0.171269154259665</li><li>0.216670872460636</li><li>0.646099642770272</li><li>1.75344839347772</li><li>1.17470494059035</li><li>0.639023867964838</li><li>0.44952974020198</li><li>0.181493481601755</li><li>-0.000450183952025895</li><li>0.0544907101941003</li><li>-0.0546009242768832</li></ol>
</div></div>
</div>
<p>This gives all the (log) population size differences between successive timepoint pairs. The max of this is what we want, divided by the time-step.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">max</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">))</span><span class="o">/</span><span class="m">2</span> <span class="c1"># 2 is the difference in any successive pair of timepoints</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.87672419673886</div></div>
</div>
</div>
<div class="section" id="using-ols">
<h4>Using OLS<a class="headerlink" href="#using-ols" title="Permalink to this headline">¶</a></h4>
<p>But we can do better than this. To account for some error in measurement, we shouldn’t really take the data points directly, but fit a linear model through them instead, where the slope gives our growth rate. This is pretty much the “traditional” way of calculating microbial growth rates – draw a straight line through the linear part of the log-transformed data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">lm_growth</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">LogN</span> <span class="o">~</span> <span class="n">Time</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">$</span><span class="n">Time</span> <span class="o">&gt;</span> <span class="m">2</span> <span class="o">&amp;</span> <span class="n">data</span><span class="o">$</span><span class="n">Time</span> <span class="o">&lt;</span> <span class="m">12</span><span class="p">,])</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">lm_growth</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Call:
lm(formula = LogN ~ Time, data = data[data$Time &gt; 2 &amp; data$Time &lt; 
    12, ])

Residuals:
       3        4        5        6 
 0.21646 -0.38507  0.12076  0.04785 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept)   7.9366     0.5350  14.835  0.00451 **
Time          0.6238     0.0728   8.569  0.01335 * 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.3256 on 2 degrees of freedom
Multiple R-squared:  0.9735,	Adjusted R-squared:  0.9602 
F-statistic: 73.42 on 1 and 2 DF,  p-value: 0.01335
</pre></div>
</div>
</div>
</div>
<p>Npw we get <span class="math notranslate nohighlight">\(r \approx 0.62\)</span>, which is probably closer to the “truth”.</p>
<p>But this is still not ideal because we only guessed the exponential phase by eye. We could do it better by iterating through different windows of points, comparing the slopes and finding which the highest is to give the maximum growth rate, <span class="math notranslate nohighlight">\(r_{max}\)</span>. This is called a “rolling regression”.</p>
<p>Or better still, we can fit a more appropriate mathematical model using NLLS!</p>
</div>
<div class="section" id="using-nlls">
<h4>Using NLLS<a class="headerlink" href="#using-nlls" title="Permalink to this headline">¶</a></h4>
<p>For starters, a classical, (somewhat) mechanistic model is the logistic equation:</p>
<div class="math notranslate nohighlight" id="equation-eq-logist-growth-sol">
<span class="eqno">(6)<a class="headerlink" href="#equation-eq-logist-growth-sol" title="Permalink to this equation">¶</a></span>\[
N_t = \frac{N_0 K e^{r t}}{K + N_0 (e^{r t} - 1)}
\]</div>
<p>Here <span class="math notranslate nohighlight">\(N_t\)</span> is population size at time <span class="math notranslate nohighlight">\(t\)</span>, <span class="math notranslate nohighlight">\(N_0\)</span> is initial population size, <span class="math notranslate nohighlight">\(r\)</span> is maximum growth rate (AKA <span class="math notranslate nohighlight">\(r_\text{max}\)</span>), and <span class="math notranslate nohighlight">\(K\)</span> is carrying capacity (maximum possible abundance of the population). Note that this model is actually the solution to the differential equation that defines the classic logistic population growth model (eqn. <a class="reference internal" href="Appendix-Maths.html#equation-eq-logist-growth">(9)</a>). The derivation of eqn. <a class="reference internal" href="#equation-eq-logist-growth-sol">(6)</a> is covered <a class="reference internal" href="Appendix-Maths.html#logistic-population-growth"><span class="std std-ref">here</span></a> (though you don’t need to know the derivation to fit eqn. <a class="reference internal" href="#equation-eq-logist-growth-sol">(6)</a> to data).</p>
<p>Let’s fit it to the data. First, we need to define it as a function object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">logistic_model</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">r_max</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">N_0</span><span class="p">){</span> <span class="c1"># The classic logistic equation</span>
 <span class="nf">return</span><span class="p">(</span><span class="n">N_0</span> <span class="o">*</span> <span class="n">K</span> <span class="o">*</span> <span class="nf">exp</span><span class="p">(</span><span class="n">r_max</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">K</span> <span class="o">+</span> <span class="n">N_0</span> <span class="o">*</span> <span class="p">(</span><span class="nf">exp</span><span class="p">(</span><span class="n">r_max</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="m">1</span><span class="p">)))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Now fit it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># first we need some starting parameters for the model</span>
<span class="n">N_0_start</span> <span class="o">&lt;-</span> <span class="nf">min</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">N</span><span class="p">)</span> <span class="c1"># lowest population size</span>
<span class="n">K_start</span> <span class="o">&lt;-</span> <span class="nf">max</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">N</span><span class="p">)</span> <span class="c1"># highest population size</span>
<span class="n">r_max_start</span> <span class="o">&lt;-</span> <span class="m">0.62</span> <span class="c1"># use our estimate from the OLS fitting from above</span>

<span class="n">fit_logistic</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">N</span> <span class="o">~</span> <span class="nf">logistic_model</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">r_max</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">N_0</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span>
      <span class="nf">list</span><span class="p">(</span><span class="n">r_max</span><span class="o">=</span><span class="n">r_max_start</span><span class="p">,</span> <span class="n">N_0</span> <span class="o">=</span> <span class="n">N_0_start</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">K_start</span><span class="p">))</span>

<span class="nf">summary</span><span class="p">(</span><span class="n">fit_logistic</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Formula: N ~ logistic_model(t = Time, r_max, K, N_0)

Parameters:
       Estimate Std. Error t value Pr(&gt;|t|)    
r_max 6.309e-01  3.791e-02  16.641 4.56e-08 ***
N_0   3.317e+03  1.451e+03   2.286   0.0481 *  
K     5.538e+06  7.192e+04  76.995 5.32e-14 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 119200 on 9 degrees of freedom

Number of iterations to convergence: 12 
Achieved convergence tolerance: 1.49e-08
</pre></div>
</div>
</div>
</div>
<p>We did not pay much attention to what starting values we used in the simpler example of fitting the allometric model because the power-law model is easy to fit using NLLS, and starting far from the optimal parameters does not matter too much. Here, we used the actual data to generate more realistic start values for each of the three parameters (<code class="docutils literal notranslate"><span class="pre">r_max</span></code>, <code class="docutils literal notranslate"><span class="pre">N_0</span></code>, <code class="docutils literal notranslate"><span class="pre">K</span></code>) of the Logistic equation.</p>
<p>Now, plot the fit:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">timepoints</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">22</span><span class="p">,</span> <span class="m">0.1</span><span class="p">)</span>

<span class="n">logistic_points</span> <span class="o">&lt;-</span> <span class="nf">logistic_model</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">timepoints</span><span class="p">,</span> 
         <span class="n">r_max</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_logistic</span><span class="p">)[</span><span class="s">&quot;r_max&quot;</span><span class="p">],</span> 
         <span class="n">K</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_logistic</span><span class="p">)[</span><span class="s">&quot;K&quot;</span><span class="p">],</span> 
         <span class="n">N_0</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_logistic</span><span class="p">)[</span><span class="s">&quot;N_0&quot;</span><span class="p">])</span>
<span class="n">df1</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">timepoints</span><span class="p">,</span> <span class="n">logistic_points</span><span class="p">)</span>
<span class="n">df1</span><span class="o">$</span><span class="n">model</span> <span class="o">&lt;-</span> <span class="s">&quot;Logistic equation&quot;</span>
<span class="nf">names</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;Time&quot;</span><span class="p">,</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">)</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="p">))</span> <span class="o">+</span>
 <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">geom_line</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">df1</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">model</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">theme</span><span class="p">(</span><span class="n">aspect.ratio</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="o">+</span> <span class="c1"># make the plot square </span>
 <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&quot;Time&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s">&quot;Cell number&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_101_0.png" src="../_images/20-ModelFitting_101_0.png" />
</div>
</div>
<p>That looks nice, and the <span class="math notranslate nohighlight">\(r_{max}\)</span> estimate we get (0.64) is fairly close to what we got above with OLS fitting.</p>
<p>Note that we’ve done this fitting to the original non transformed data, whilst the linear regressions earlier were on log transformed data. What would this function look like on a log-transformed axis?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">LogN</span><span class="p">))</span> <span class="o">+</span>
 <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">geom_line</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">df1</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nf">log</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">col</span> <span class="o">=</span> <span class="n">model</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">theme</span><span class="p">(</span><span class="n">aspect.ratio</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="o">+</span> 
 <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&quot;Time&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s">&quot;log(Cell number)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_103_0.png" src="../_images/20-ModelFitting_103_0.png" />
</div>
</div>
<p>The model actually diverges from the data at the lower end! This was not visible in the previous plot where you examined the model in linear scale (without taking a log) because the deviation of the model is small, and only becomes clear in the log scale. This is because of the way logarithms work. Let’s have a look at this in our Cell counts “data”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">LogN</span><span class="p">))</span> <span class="o">+</span>
 <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">theme</span><span class="p">(</span><span class="n">aspect.ratio</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span><span class="o">+</span> 
 <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s">&quot;log(N)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_105_0.png" src="../_images/20-ModelFitting_105_0.png" />
</div>
</div>
<p>As you can see the logarithm is a strongly nonlinear transformation of any sequence of real numbers, with small numbers close to zero yielding disproportionately large deviations.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may play with increasing the error (by increasing the value of <code class="docutils literal notranslate"><span class="pre">sd</span></code> in synthetic data generation step above) and re-evaluating all the subsequent model fitting steps above. However, note that above some values of <code class="docutils literal notranslate"><span class="pre">sd</span></code>, you will start to get negative values of populations, especially at early time points, which will raise issues with taking a logarithm.</p>
</div>
<p>The above seen deviation of the Logistic model from the data is because this model assumes that the population is growing right from the start (Time = 0), while in “reality” (in our synthetic “data”), this is not what’s happening; the population takes a while to grow truly exponentially (i.e., there is a time lag in the population growth). This time lag is seen frequently in the lab, and is also expected in nature, because when bacteria encounter fresh growth media (in the lab) or a new resource/environment (in the field), they take some time to acclimate, activating genes involved in nutrient uptake and metabolic processes, before beginning exponential growth. This is called the lag phase and can be seen in our example data where exponential growth doesn’t properly begin until around the 4th hour.</p>
<p>To capture the lag phase, more complicated bacterial growth models have been designed.</p>
<p>One of these is the modified Gompertz model (Zwietering et. al., 1990), which has been used frequently in the literature to model bacterial growth:</p>
<div class="math notranslate nohighlight">
\[ \label{eq:Gompertz}
  \log(N_t) = N_0 + (N_{max} - N_0) e^{-e^{r_{max} \exp(1) \frac{t_{lag} - t}{(N_{max} - N_0) \log(10)} + 1}}
\]</div>
<p>Here maximum growth rate (<span class="math notranslate nohighlight">\(r_{max}\)</span>) is the tangent to the inflection point, <span class="math notranslate nohighlight">\(t_{lag}\)</span> is the x-axis intercept to this tangent (duration of the delay before the population starts growing exponentially) and <span class="math notranslate nohighlight">\(\log\left(\frac{N_{max}}{N_0}\right)\)</span> is the asymptote of the log-transformed population growth trajectory, i.e., the log ratio of maximum population density <span class="math notranslate nohighlight">\(N_{max}\)</span> (aka “carrying capacity”) and initial cell (Population) <span class="math notranslate nohighlight">\(N_0\)</span> density.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that unlike the Logistic growth model above, the Gompertz model is in the log scale. This is because the model is not derived from a differential equation, but was designed * specifically * to be fitted to log-transformed data.</p>
</div>
<p>Now let’s fit and compare the two alternative nonlinear growth models: Logistic and Gompertz.</p>
<p>First, specify the function object for the Gompertz model (we already defined the function for the Logistic model above):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">gompertz_model</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">r_max</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">N_0</span><span class="p">,</span> <span class="n">t_lag</span><span class="p">){</span> <span class="c1"># Modified gompertz growth model (Zwietering 1990)</span>
 <span class="nf">return</span><span class="p">(</span><span class="n">N_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">K</span> <span class="o">-</span> <span class="n">N_0</span><span class="p">)</span> <span class="o">*</span> <span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="nf">exp</span><span class="p">(</span><span class="n">r_max</span> <span class="o">*</span> <span class="nf">exp</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_lag</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">K</span> <span class="o">-</span> <span class="n">N_0</span><span class="p">)</span> <span class="o">*</span> <span class="nf">log</span><span class="p">(</span><span class="m">10</span><span class="p">))</span> <span class="o">+</span> <span class="m">1</span><span class="p">)))</span>
<span class="p">}</span>   
</pre></div>
</div>
</div>
</div>
<p>Again, note that unlike the Logistic growth function above, this function has been written in the log scale.</p>
<p>Now let’s generate some starting values for the NLLS fitting of the Gompertz model.</p>
<p>As we did above for the logistic equation, let’s derive the starting values by using the actual data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">N_0_start</span> <span class="o">&lt;-</span> <span class="nf">min</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">)</span> <span class="c1"># lowest population size, note log scale</span>
<span class="n">K_start</span> <span class="o">&lt;-</span> <span class="nf">max</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">)</span> <span class="c1"># highest population size, note log scale</span>
<span class="n">r_max_start</span> <span class="o">&lt;-</span> <span class="m">0.62</span> <span class="c1"># use our previous estimate from the OLS fitting from above</span>
<span class="n">t_lag_start</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="o">$</span><span class="n">Time</span><span class="p">[</span><span class="nf">which.max</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">)))]</span> <span class="c1"># find last timepoint of lag phase</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>So how did we find a reasonable time lag from the data? *</p></li>
</ul>
<p>Let’s break the last command down:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">diff</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">)</span> <span class="c1"># same as what we did above - get differentials</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>0.171269154259665</li><li>0.216670872460636</li><li>0.646099642770272</li><li>1.75344839347772</li><li>1.17470494059035</li><li>0.639023867964838</li><li>0.44952974020198</li><li>0.181493481601755</li><li>-0.000450183952025895</li><li>0.0544907101941003</li><li>-0.0546009242768832</li></ol>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">diff</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">))</span> <span class="c1"># get the differentials of the differentials (approx 2nd order derivatives)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>0.0454017182009707</li><li>0.429428770309636</li><li>1.10734875070745</li><li>-0.578743452887371</li><li>-0.535681072625511</li><li>-0.189494127762858</li><li>-0.268036258600224</li><li>-0.181943665553781</li><li>0.0549408941461262</li><li>-0.109091634470984</li></ol>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">which.max</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">)))</span> <span class="c1"># find the timepoint where this 2nd order derivative really takes off </span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">3</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">$</span><span class="n">Time</span><span class="p">[</span><span class="nf">which.max</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="nf">diff</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">LogN</span><span class="p">)))]</span> <span class="c1"># This then is a good guess for the last timepoint of the lag phase</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">4</div></div>
</div>
<p>Now fit the model using these start values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">fit_gompertz</span> <span class="o">&lt;-</span> <span class="nf">nlsLM</span><span class="p">(</span><span class="n">LogN</span> <span class="o">~</span> <span class="nf">gompertz_model</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">r_max</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">N_0</span><span class="p">,</span> <span class="n">t_lag</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span>
      <span class="nf">list</span><span class="p">(</span><span class="n">t_lag</span><span class="o">=</span><span class="n">t_lag_start</span><span class="p">,</span> <span class="n">r_max</span><span class="o">=</span><span class="n">r_max_start</span><span class="p">,</span> <span class="n">N_0</span> <span class="o">=</span> <span class="n">N_0_start</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">K_start</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>You might one or more warning(s) that the model fitting iterations generated NaNs during the fitting procedure for these data (because at some point the NLLS fitting algorithm “wandered” to a combination of K and N_0 values that yields a NaN for log(K/N_0)).</p>
<p>You can ignore these warning in this case. But not always – sometimes these NaNs mean that the equation is wrongly written, or that it generates NaNs across the whole range of the x-values, in which case the model is inappropriate for these data.</p>
<p>Get the model summary:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">summary</span><span class="p">(</span><span class="n">fit_gompertz</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Formula: LogN ~ gompertz_model(t = Time, r_max, K, N_0, t_lag)

Parameters:
      Estimate Std. Error t value Pr(&gt;|t|)    
t_lag  4.80680    0.18433   26.08 5.02e-09 ***
r_max  1.86616    0.08749   21.33 2.45e-08 ***
N_0   10.39142    0.05998  173.24 1.38e-15 ***
K     15.54956    0.05056  307.57  &lt; 2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.09418 on 8 degrees of freedom

Number of iterations to convergence: 10 
Achieved convergence tolerance: 1.49e-08
</pre></div>
</div>
</div>
</div>
<p>And see how the fits of the two nonlinear models compare:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">timepoints</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">24</span><span class="p">,</span> <span class="m">0.1</span><span class="p">)</span>

<span class="n">logistic_points</span> <span class="o">&lt;-</span> <span class="nf">log</span><span class="p">(</span><span class="nf">logistic_model</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">timepoints</span><span class="p">,</span> 
          <span class="n">r_max</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_logistic</span><span class="p">)[</span><span class="s">&quot;r_max&quot;</span><span class="p">],</span> 
          <span class="n">K</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_logistic</span><span class="p">)[</span><span class="s">&quot;K&quot;</span><span class="p">],</span> 
          <span class="n">N_0</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_logistic</span><span class="p">)[</span><span class="s">&quot;N_0&quot;</span><span class="p">]))</span>

<span class="n">gompertz_points</span> <span class="o">&lt;-</span> <span class="nf">gompertz_model</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">timepoints</span><span class="p">,</span> 
         <span class="n">r_max</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_gompertz</span><span class="p">)[</span><span class="s">&quot;r_max&quot;</span><span class="p">],</span> 
         <span class="n">K</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_gompertz</span><span class="p">)[</span><span class="s">&quot;K&quot;</span><span class="p">],</span> 
         <span class="n">N_0</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_gompertz</span><span class="p">)[</span><span class="s">&quot;N_0&quot;</span><span class="p">],</span> 
         <span class="n">t_lag</span> <span class="o">=</span> <span class="nf">coef</span><span class="p">(</span><span class="n">fit_gompertz</span><span class="p">)[</span><span class="s">&quot;t_lag&quot;</span><span class="p">])</span>

<span class="n">df1</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">timepoints</span><span class="p">,</span> <span class="n">logistic_points</span><span class="p">)</span>
<span class="n">df1</span><span class="o">$</span><span class="n">model</span> <span class="o">&lt;-</span> <span class="s">&quot;Logistic model&quot;</span>
<span class="nf">names</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;Time&quot;</span><span class="p">,</span> <span class="s">&quot;LogN&quot;</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">)</span>

<span class="n">df2</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">timepoints</span><span class="p">,</span> <span class="n">gompertz_points</span><span class="p">)</span>
<span class="n">df2</span><span class="o">$</span><span class="n">model</span> <span class="o">&lt;-</span> <span class="s">&quot;Gompertz model&quot;</span>
<span class="nf">names</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;Time&quot;</span><span class="p">,</span> <span class="s">&quot;LogN&quot;</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">)</span>

<span class="n">model_frame</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">)</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">LogN</span><span class="p">))</span> <span class="o">+</span>
 <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">geom_line</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">model_frame</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Time</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">LogN</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">model</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span> <span class="c1"># make the background white</span>
 <span class="nf">theme</span><span class="p">(</span><span class="n">aspect.ratio</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="o">+</span> <span class="c1"># make the plot square </span>
 <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&quot;Time&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s">&quot;log(Abundance)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_124_0.png" src="../_images/20-ModelFitting_124_0.png" />
</div>
</div>
<p>Clearly, the Gompertz model fits way better than the logistic growth equation in this case! Note also that there is a big difference in the fitted value of <span class="math notranslate nohighlight">\(r_{max}\)</span> from the two models; the value is much lower from the Logistic model because it ignores the lag phase, including it into the exponential growth phase.</p>
<p>You can now perform model selection like you did above in the allometric scaling example.</p>
</div>
</div>
<div class="section" id="exercises">
<h3>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h3>
<p>(a) Calculate the confidence intervals on the parameters of each of the two fitted models, and use model selection (using AIC and/or BIC) as you did before to see if you can determine the best-fitting model among the three.</p>
<p>(b) Alternatively, for a different random sequence of fluctuations, one or more of the models may fail to fit (a <code class="docutils literal notranslate"><span class="pre">singular</span> <span class="pre">gradiant</span> <span class="pre">matrix</span></code> error). Try repeating the above fitting with a different random seed (change the integers given to the <code class="docutils literal notranslate"><span class="pre">random.seed(</span> <span class="pre">)</span></code> function), or increase the sampling error by increasing the standard deviation and see if it happens. If/when the NLLS optimization does fail to converge (the RSS minimum was not found), you can try to fix it by changing the starting values.</p>
<p>(c) Repeat the model comparison exercise 1000 times (You will have to write a loop), and determine if/whether one model generally wins more often than the others. Note that each run will generate a slightly different dataset, because we are adding a vector of random errors every time the “data” are generated. This may result in failure of the NLLS fitting to converge, in which case you will need to use the <a class="reference external" href="https://nbviewer.jupyter.org/github/mhasoba/TheMulQuaBio/blob/master/notebooks/07-R.ipynb"><code class="docutils literal notranslate"><span class="pre">try()</span></code> or <code class="docutils literal notranslate"><span class="pre">tryCatch</span></code> functions</a>.</p>
<p>(d) Repeat (b), but increase the error by increasing the standard deviation of the normal error distribution, and see if there are differences in the robustness of the models to sampling/experimental errors. You may also want to try changing the distribution of the errors to some non-normal distribution and see what happens.</p>
</div>
<div class="section" id="obtaining-starting-values">
<span id="model-fitting-nlls-starting-values"></span><h3>Obtaining starting values<a class="headerlink" href="#obtaining-starting-values" title="Permalink to this headline">¶</a></h3>
<p>The main challenge for NLLS fitting is finding starting values for the parameters.</p>
<p>Ideally, you should determine starting values specific to each dataset (e.g., every distinct functional response, population growth rate, or thermal performance curve) that you are trying to fit a model to. To do so, understanding how each parameter in the model corresponds to features of the actual data is key.</p>
<p>For example, in the Gompertz population growth rate model, your starting values generator would essentially be an algorithm which, for each dataset,</p>
<ul class="simple">
<li><p>Calculates a starting value for <span class="math notranslate nohighlight">\(r_{max}\)</span> by searching for the steepest slope of the growth curve using the first few data points (fitting a straight line using OLS)</p></li>
<li><p>Calculates a starting value of <span class="math notranslate nohighlight">\(t_{lag}\)</span> by intersecting the fitted line with the x (time)-axis</p></li>
<li><p>Calculates a starting value for the asymptote <span class="math notranslate nohighlight">\(A\)</span> as the highest data (abundance) value in the dataset.</p></li>
</ul>
<p>In general, a good strategy to optimize fits (and maximize how many datasets are successfully fitted to a non-linear model) is to <em>sample starting values from a distribution</em>. For example, you can choose a Gaussian (if you have high confidence in mean value of parameter) or a uniform distribution (if you have low confidence in mean, but high confidence in the range of values that the parameter can take), with the mean of the sampling distribution  being the value you inferred from the data.</p>
<p><em>Ideally, you should write a separate script/module/function that calculates starting values for the model parameters.</em></p>
</div>
</div>
<div class="section" id="model-fitting-using-maximum-likelihood">
<h2>Model fitting using Maximum Likelihood<a class="headerlink" href="#model-fitting-using-maximum-likelihood" title="Permalink to this headline">¶</a></h2>
<p>Above we learned how to fit a mathematical model/equation to data by using the Least Squares method (linear or nonlinear). That is, we choose the parameters of model being fitted (e.g., straight line) to minimize the sum of the squares of the residuals/errors sround the fitted model. An alternative to minimizing the sum of squared errors is to find parameters to the function such that the * likelihood * of the parameters, given the data and the model, is maximized. Please see the <a class="reference external" href="https://github.com/vectorbite/VBiTraining2/tree/master/lectures">lectures</a> for the theoretical background to the following R examples.</p>
<p>We will first implement the (negative log) likelihood for simple linear regression (SLR) in R. Recall that SLR assumes every observation in the dataset was generated by the model:</p>
<div class="math notranslate nohighlight">
\[Y_i = \beta_0 + \beta_1 X_i + \varepsilon_i, \;\;\; \varepsilon_i \stackrel{\mathrm{iid}}{\sim} \mathrm{N}(0, \sigma^2)
\]</div>
<p>That is, this is a model for the * conditional distribution * of <span class="math notranslate nohighlight">\(Y\)</span> given <span class="math notranslate nohighlight">\(X\)</span>. The pdf for the normal distribution is given by</p>
<div class="math notranslate nohighlight">
\[
f(x) = \frac{1}{\sqrt{2\sigma^2 \pi}} \exp\left(-\frac{(x-\mu)^2}{2\sigma^2} \right)
\]</div>
<p>In the SLR model, the conditional distribution has * this * distribution.</p>
<p>That is, for any single observation, <span class="math notranslate nohighlight">\(y_i\)</span>
$<span class="math notranslate nohighlight">\(
f(y_i|\beta_0, \beta_1, x_i) = \frac{1}{\sqrt{2\sigma^2 \pi}} \exp\left(-\frac{(y_i-(\beta_0+\beta_1 x_i))^2}{2\sigma^2} \right)
\)</span>$</p>
<p>Interpreting this function as a function of the parameters <span class="math notranslate nohighlight">\(\theta=\{ \beta_0, \beta_1, \sigma \}\)</span>, then it gives us the likelihood of the <span class="math notranslate nohighlight">\(i^{\mathrm{th}}\)</span> data point.</p>
<p>As we did for the simple binomial distribution (see <a class="reference external" href="https://github.com/vectorbite/VBiTraining2/tree/master/lectures">lecture</a>), we can use this to estimate the parameters of the model.</p>
<div class="section" id="implementing-the-likelihood-in-r">
<h3>Implementing the Likelihood in R<a class="headerlink" href="#implementing-the-likelihood-in-r" title="Permalink to this headline">¶</a></h3>
<p>First, we need to build an R function that returns the (negative log) likelihood for simple linear regression (it is negative log because the log of likelihood is itself negative):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">nll.slr</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="kc">...</span><span class="p">){</span>
 <span class="n">args</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="kc">...</span><span class="p">)</span>
 
 <span class="n">b0</span> <span class="o">&lt;-</span> <span class="n">par</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>
 <span class="n">b1</span> <span class="o">&lt;-</span> <span class="n">par</span><span class="p">[</span><span class="m">2</span><span class="p">]</span>
 <span class="n">X</span> <span class="o">&lt;-</span> <span class="n">dat</span><span class="o">$</span><span class="n">X</span>
 <span class="n">Y</span> <span class="o">&lt;-</span> <span class="n">dat</span><span class="o">$</span><span class="n">Y</span>
 <span class="nf">if</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">args</span><span class="o">$</span><span class="n">sigma</span><span class="p">)){</span>
  <span class="n">sigma</span> <span class="o">&lt;-</span> <span class="n">args</span><span class="o">$</span><span class="n">sigma</span>
 <span class="p">}</span> <span class="n">else</span> 
  <span class="n">sigma</span> <span class="o">&lt;-</span> <span class="n">par</span><span class="p">[</span><span class="m">3</span><span class="p">]</span>

 <span class="n">mu</span> <span class="o">&lt;-</span> <span class="n">b0</span><span class="o">+</span><span class="n">b1</span> <span class="o">*</span> <span class="n">X</span>
 
 <span class="nf">return</span><span class="p">(</span><span class="o">-</span><span class="nf">sum</span><span class="p">(</span><span class="nf">dnorm</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Note that we do something a bit different here (the “<code class="docutils literal notranslate"><span class="pre">...</span></code>” bit). We do it this way because we want to be able to use R’s <code class="docutils literal notranslate"><span class="pre">optim()</span></code> function later.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">dnorm()</span></code> function calculates the logged (the <code class="docutils literal notranslate"><span class="pre">log=TRUE</span></code> argument) probability of observing Y given mu, sigma and that X.</p>
<p>The negative sign on <code class="docutils literal notranslate"><span class="pre">sum()</span></code> is because the <code class="docutils literal notranslate"><span class="pre">optim()</span></code> function in R will minimize the negative log-likelihood, which is a sum: Recall that The log-likelihood of the parameters <span class="math notranslate nohighlight">\(\theta\)</span> being true given data x equals to the sum of the logged probability densities of observing the data x given parameters <span class="math notranslate nohighlight">\(\theta\)</span>. We want to maximize this (log-) likelihood using <code class="docutils literal notranslate"><span class="pre">optim()</span></code>.</p>
<p>Let’s generate some simulated data, assuming that: <span class="math notranslate nohighlight">\(\beta_0=\)</span> <code class="docutils literal notranslate"><span class="pre">b0</span></code>, <span class="math notranslate nohighlight">\(\beta_1=\)</span> <code class="docutils literal notranslate"><span class="pre">b1</span></code>, and <span class="math notranslate nohighlight">\(\sigma=\)</span> <code class="docutils literal notranslate"><span class="pre">sigma</span></code>. For this, we will generate random deviations to simulate sampling or measurement error around an otherwise perfect line of data values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">)</span>
<span class="n">n</span> <span class="o">&lt;-</span> <span class="m">30</span>
<span class="n">b0</span> <span class="o">&lt;-</span> <span class="m">10</span>
<span class="n">b1</span> <span class="o">&lt;-</span> <span class="m">3</span>
<span class="n">sigma</span> <span class="o">&lt;-</span> <span class="m">2</span>
<span class="n">X</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="m">3</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="m">7</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">&lt;-</span> <span class="n">b0</span> <span class="o">+</span> <span class="n">b1</span> <span class="o">*</span> <span class="n">X</span> <span class="o">+</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
<span class="n">dat</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="n">Y</span><span class="p">)</span> <span class="c1"># convert to a data frame</span>
</pre></div>
</div>
</div>
</div>
<p>In the first line, we <code class="docutils literal notranslate"><span class="pre">set.seed()</span></code> to ensure that we can reproduce the results. The seed number you choose is the starting point used in the generation of a sequence of random numbers. No plot the “data”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_135_0.png" src="../_images/20-ModelFitting_135_0.png" />
</div>
</div>
<div class="section" id="likelihood-profile">
<h4>Likelihood profile<a class="headerlink" href="#likelihood-profile" title="Permalink to this headline">¶</a></h4>
<p>For now, let’s assume that we know what <span class="math notranslate nohighlight">\(\beta_1\)</span> is. Let’s build a likelihood profile for the simulated data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">&lt;-</span> <span class="m">50</span>
<span class="n">b0s</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">5</span><span class="p">,</span> <span class="m">15</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
<span class="n">mynll</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="m">50</span><span class="p">)</span>
<span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">N</span><span class="p">){</span>
 <span class="n">mynll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">nll.slr</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">b0s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">b1</span><span class="p">),</span> <span class="n">dat</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>That is, we calculate the negative log-likelihood for fixed b1, across a range (5 - 15) of b0.</p>
<p>Now plot the profile:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">b0s</span><span class="p">,</span> <span class="n">mynll</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&quot;l&quot;</span><span class="p">)</span>
<span class="nf">abline</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="n">b0</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
<span class="nf">abline</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="n">b0s</span><span class="p">[</span><span class="nf">which.min</span><span class="p">(</span><span class="n">mynll</span><span class="p">)],</span> <span class="n">col</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_140_0.png" src="../_images/20-ModelFitting_140_0.png" />
</div>
</div>
<p>The true value for b0 (10) is the red line, while the value that minimizes the log-likelihood (i.e., maximizes the negative log-likelihood) is the green line. These are not the same because maximum likelihood is providing an * estimate * of the true value given the measurement errors (that we ourselves generated in tgis synthetic dataset).</p>
</div>
<div class="section" id="likelihood-surface">
<h4>Likelihood surface<a class="headerlink" href="#likelihood-surface" title="Permalink to this headline">¶</a></h4>
<p>If we wanted to estimate both <span class="math notranslate nohighlight">\(\beta_0\)</span> and <span class="math notranslate nohighlight">\(\beta_1\)</span> (two parameters), we need to deal with a two-dimensional maximum likelihood surface. The simplest approach is to do a * grid search * to find this likelihood surface.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">N0</span> <span class="o">&lt;-</span> <span class="m">100</span>
<span class="n">N1</span> <span class="o">&lt;-</span> <span class="m">101</span>
<span class="n">b0s</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">7</span><span class="p">,</span><span class="m">12</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">N0</span><span class="p">)</span>
<span class="n">b1s</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">5</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">N1</span><span class="p">)</span>

<span class="n">mynll</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="n">N0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">N1</span><span class="p">)</span>
<span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">N0</span><span class="p">){</span>
 <span class="nf">for</span><span class="p">(</span><span class="n">j</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">N1</span><span class="p">)</span> <span class="n">mynll</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">nll.slr</span><span class="p">(</span><span class="n">par</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">b0s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">b1s</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">dat</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">ww</span> <span class="o">&lt;-</span> <span class="nf">which</span><span class="p">(</span><span class="n">mynll</span><span class="o">==</span><span class="nf">min</span><span class="p">(</span><span class="n">mynll</span><span class="p">),</span> <span class="n">arr.ind</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>

<span class="n">b0.est</span> <span class="o">&lt;-</span> <span class="n">b0s</span><span class="p">[</span><span class="n">ww</span><span class="p">[</span><span class="m">1</span><span class="p">]]</span>
<span class="n">b1.est</span> <span class="o">&lt;-</span> <span class="n">b1s</span><span class="p">[</span><span class="n">ww</span><span class="p">[</span><span class="m">2</span><span class="p">]]</span>
<span class="nf">rbind</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="n">b0.est</span><span class="p">,</span> <span class="n">b1.est</span><span class="p">))</span>

<span class="nf">filled.contour</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">b0s</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">b1s</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span> <span class="n">mynll</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="nf">heat.colors</span><span class="p">(</span><span class="m">21</span><span class="p">),</span> 
    <span class="n">plot.axes</span> <span class="o">=</span> <span class="p">{</span><span class="nf">axis</span><span class="p">(</span><span class="m">1</span><span class="p">);</span> <span class="nf">axis</span><span class="p">(</span><span class="m">2</span><span class="p">);</span> <span class="nf">points</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span> <span class="n">pch</span><span class="o">=</span><span class="m">21</span><span class="p">);</span> 
       <span class="nf">points</span><span class="p">(</span><span class="n">b0.est</span><span class="p">,</span> <span class="n">b1.est</span><span class="p">,</span> <span class="n">pch</span><span class="o">=</span><span class="m">8</span><span class="p">,</span> <span class="n">cex</span><span class="o">=</span><span class="m">1.5</span><span class="p">);</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;b0&quot;</span><span class="p">;</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;b1&quot;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A matrix: 2 × 2 of type dbl</caption>
<tbody>
	<tr><td>10.00000</td><td>3.00</td></tr>
	<tr><td>10.48485</td><td>2.96</td></tr>
</tbody>
</table>
</div><img alt="../_images/20-ModelFitting_143_1.png" src="../_images/20-ModelFitting_143_1.png" />
</div>
</div>
<p>There is a lot going on here. Make sure you ask one of us if some of the code does not make sense!</p>
<p>Again, note that the true parameter combination (asterisk) and the one what maximizes the negative log-likelihood (circle) are different.</p>
</div>
<div class="section" id="conditional-likelihood">
<h4>Conditional Likelihood<a class="headerlink" href="#conditional-likelihood" title="Permalink to this headline">¶</a></h4>
<p>We can also look at the conditional surfaces (i.e., we look at the slice around whatever the best estimate is for the other parameter):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">bty</span><span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">b0s</span><span class="p">,</span> <span class="n">mynll</span><span class="p">[,</span><span class="n">ww</span><span class="p">[</span><span class="m">2</span><span class="p">]],</span> <span class="n">type</span><span class="o">=</span><span class="s">&quot;l&quot;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;b0&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;NLL&quot;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">b1s</span><span class="p">,</span> <span class="n">mynll</span><span class="p">[</span><span class="n">ww</span><span class="p">[</span><span class="m">1</span><span class="p">],],</span> <span class="n">type</span><span class="o">=</span><span class="s">&quot;l&quot;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;b1&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;NLL&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_146_0.png" src="../_images/20-ModelFitting_146_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="alternatives-to-grid-search">
<h3>Alternatives to Grid Search<a class="headerlink" href="#alternatives-to-grid-search" title="Permalink to this headline">¶</a></h3>
<p>There are many alternative methods to grid searches. Since we are seeking to minimize an arbitrary function (the negative log likelihood) we typically use a descent method to perform general optimization.</p>
<p>There are lots of options implemented in the <code class="docutils literal notranslate"><span class="pre">optim</span></code>function in R. We won’t go into the details of these methods, due to time constraints. However, typically one would most commonly use:</p>
<ul class="simple">
<li><p>Brent’s method: for 1-D search within a bounding box, only</p></li>
<li><p>L-BFGS-B (limited-memory Broyden–Fletcher–Goldfarb–Shanno algorithm with bounding box constraints): a quasi-Newton method, used for higher dimensions, when you want to be able to put simple limits on your search area.</p></li>
</ul>
</div>
<div class="section" id="maximum-likelihood-using-optim">
<h3>Maximum Likelihood using <code class="docutils literal notranslate"><span class="pre">optim()</span></code><a class="headerlink" href="#maximum-likelihood-using-optim" title="Permalink to this headline">¶</a></h3>
<p>We can now do the fitting. This involves optimization (to find the appropriate parameter values that achieve the maximum of the likelihood surface above). For this, we will use R’s versatile <code class="docutils literal notranslate"><span class="pre">optim()</span></code> function.</p>
<p>The first argument for <code class="docutils literal notranslate"><span class="pre">optim()</span></code> is the function that you want to minimize, and the second is a vector of starting values for your parameters (as always, do a<code class="docutils literal notranslate"><span class="pre">?optim</span></code>). After the main arguments, you can add what you need to evaluate your function (e.g. <code class="docutils literal notranslate"><span class="pre">sigma</span></code> ). The addtional argument sigma can be “fed” to <code class="docutils literal notranslate"><span class="pre">nll.slr</span></code> because we use the <code class="docutils literal notranslate"><span class="pre">...</span></code> convention when defining it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">fit</span> <span class="o">&lt;-</span> <span class="nf">optim</span><span class="p">(</span><span class="n">nll.slr</span><span class="p">,</span> <span class="n">par</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="c1">## this is a n-D method</span>
    <span class="n">lower</span><span class="o">=-</span><span class="kc">Inf</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="kc">Inf</span><span class="p">,</span> <span class="n">dat</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>

<span class="n">fit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><dl>
	<dt>$par</dt>
		<dd><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>10.4589351280817</li><li>2.96170447551098</li></ol>
</dd>
	<dt>$value</dt>
		<dd>58.2247252772924</dd>
	<dt>$counts</dt>
		<dd><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>function</dt><dd>12</dd><dt>gradient</dt><dd>12</dd></dl>
</dd>
	<dt>$convergence</dt>
		<dd>0</dd>
	<dt>$message</dt>
		<dd>'CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH'</dd>
</dl>
</div></div>
</div>
<p>Easy as pie (once you have the recipe)! We can also fit sigma as the same time if we want:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">fit</span> <span class="o">&lt;-</span> <span class="nf">optim</span><span class="p">(</span><span class="n">nll.slr</span><span class="p">,</span> <span class="n">par</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">5</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="c1">## this is a n-D method</span>
    <span class="n">lower</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="o">-</span><span class="kc">Inf</span><span class="p">,</span> <span class="o">-</span><span class="kc">Inf</span><span class="p">,</span> <span class="m">0.1</span><span class="p">),</span> <span class="n">upper</span><span class="o">=</span><span class="kc">Inf</span><span class="p">,</span> <span class="n">dat</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">NA</span><span class="p">)</span>
<span class="n">fit</span><span class="o">$</span><span class="n">par</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>10.4589449542964</li><li>2.96170371229526</li><li>1.62168936031414</li></ol>
</div></div>
</div>
<p>The starting values (b0 = 2, b1 = 1, sigma = 5) need to be assigned as we would do for NLLS. Also note that much like NLLS, we have bounded the parameters. The exact starting values are not too important in this case (try changing them see what happens).</p>
<p>Now visualize the fit:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
<span class="nf">abline</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">fit</span><span class="o">$</span><span class="n">par</span><span class="p">[</span><span class="m">1</span><span class="p">],</span> <span class="n">b</span><span class="o">=</span><span class="n">fit</span><span class="o">$</span><span class="n">par</span><span class="p">[</span><span class="m">2</span><span class="p">],</span> <span class="n">col</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_153_0.png" src="../_images/20-ModelFitting_153_0.png" />
</div>
</div>
</div>
<div class="section" id="confidence-intervals">
<h3>Confidence intervals<a class="headerlink" href="#confidence-intervals" title="Permalink to this headline">¶</a></h3>
<p>The joint distribution of the MLEs are asymptotically Normally distributed. Given this, if you are minimizing the negative log likelihood (NLL) then the covariance matrix of the estimates is (asymptotically) the inverse of the Hessian matrix. The Hessian matrix evalutes the second derivatives of the NLL (numerically here), which gives us information about the curvature the likelihood. Thus we can use the Hessian to estimate confidence intervals:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">fit</span> <span class="o">&lt;-</span> <span class="nf">optim</span><span class="p">(</span><span class="n">nll.slr</span><span class="p">,</span> <span class="n">par</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">hessian</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">lower</span><span class="o">=-</span><span class="kc">Inf</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="kc">Inf</span><span class="p">,</span> <span class="n">dat</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>

<span class="n">fisher_info</span> <span class="o">&lt;-</span> <span class="nf">solve</span><span class="p">(</span><span class="n">fit</span><span class="o">$</span><span class="n">hessian</span><span class="p">)</span>
<span class="n">est_sigma</span> <span class="o">&lt;-</span> <span class="nf">sqrt</span><span class="p">(</span><span class="nf">diag</span><span class="p">(</span><span class="n">fisher_info</span><span class="p">))</span>
<span class="n">upper</span> <span class="o">&lt;-</span> <span class="n">fit</span><span class="o">$</span><span class="n">par</span><span class="m">+1.96</span> <span class="o">*</span> <span class="n">est_sigma</span>
<span class="n">lower</span> <span class="o">&lt;-</span> <span class="n">fit</span><span class="o">$</span><span class="n">par</span><span class="m">-1.96</span> <span class="o">*</span> <span class="n">est_sigma</span>
<span class="n">interval</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">fit</span><span class="o">$</span><span class="n">par</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">)</span>
<span class="n">interval</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A data.frame: 2 × 3</caption>
<thead>
	<tr><th scope=col>value</th><th scope=col>upper</th><th scope=col>lower</th></tr>
	<tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>10.458935</td><td>11.228565</td><td>9.689305</td></tr>
	<tr><td> 2.961704</td><td> 3.067705</td><td>2.855704</td></tr>
</tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="comparison-to-fitting-with-least-squares">
<h3>Comparison to fitting with least squares<a class="headerlink" href="#comparison-to-fitting-with-least-squares" title="Permalink to this headline">¶</a></h3>
<p>We can, of course, simply fit the model with lest squares using the <code class="docutils literal notranslate"><span class="pre">lm()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">lmfit</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">Y</span><span class="o">~</span><span class="n">X</span><span class="p">)</span>

<span class="nf">summary</span><span class="p">(</span><span class="n">lmfit</span><span class="p">)</span><span class="o">$</span><span class="n">coeff</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A matrix: 2 × 4 of type dbl</caption>
<thead>
	<tr><th></th><th scope=col>Estimate</th><th scope=col>Std. Error</th><th scope=col>t value</th><th scope=col>Pr(&gt;|t|)</th></tr>
</thead>
<tbody>
	<tr><th scope=row>(Intercept)</th><td>10.458936</td><td>0.32957007</td><td>31.73509</td><td>1.699822e-23</td></tr>
	<tr><th scope=row>X</th><td> 2.961704</td><td>0.04539126</td><td>65.24834</td><td>3.874555e-32</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>The estimates we get using <code class="docutils literal notranslate"><span class="pre">optim()</span></code> are almost identical to the estimates that we obtain here, and the standard errors on the intercept and slope are very similar to those we calculated from the Hessian (est_sigma= <code class="docutils literal notranslate"><span class="pre">r</span> <span class="pre">est_sigma</span></code>).</p>
</div>
<div class="section" id="model-selection">
<h3>Model Selection<a class="headerlink" href="#model-selection" title="Permalink to this headline">¶</a></h3>
<p>You can use <a class="reference external" href="#Comparing-models">AIC or BIC as you did in NLLS</a> using the likelihood you have calculated.</p>
<p>You can also use the Likelihood Ratio Test (LRT).</p>
<div class="section" id="exercises-a-id-mle-exercises-a">
<h4>Exercises <a id='MLE_Exercises'></a><a class="headerlink" href="#exercises-a-id-mle-exercises-a" title="Permalink to this headline">¶</a></h4>
<p>Try MLE fitting for the allometric trait data example <a class="reference external" href="#Allometric-scaling-of-traits">above</a>. You will use the same data + functions that you used to practice fitting curves using non-linear least squares methods. You have two options here. The easier one is to convert the power law model to a straight line model by taking a log (explained the Allometry <a class="reference external" href="#Allom_Exercises">Exercises</a>. Specifically,</p>
<p>(a) Using the <a class="reference external" href="#Implementing-the-Likelihood-in-R"><code class="docutils literal notranslate"><span class="pre">nll.slr</span></code></a> function as an example, write a function that calculates the negative log likelihood as a function of the parameters describing your trait and any additional parameters you need for an appropriate noise distribution (e.g., <span class="math notranslate nohighlight">\(\sigma\)</span> if you have normally distributed errors).</p>
<p>(b) For at least one of your parameters plot a likelihood profile given your data, with the other parametes fixed.</p>
<p>(c) Use the <code class="docutils literal notranslate"><span class="pre">optim</span></code> function to find the MLE of the same parameter and indicate this on your likelihood profile.</p>
<p>(d) Obtain a confidence interval for your estimate.</p>
<p>A more challenging option is to fit the allometry data directly to the power law equation. You would need to assume a log-normal distribution for the errors instead of normal, in this case.</p>
</div>
</div>
</div>
<div class="section" id="fitting-models-the-bayesian-way">
<h2>Fitting Models the Bayesian way<a class="headerlink" href="#fitting-models-the-bayesian-way" title="Permalink to this headline">¶</a></h2>
<p>Recall from the <a class="reference external" href="https://github.com/vectorbite/VBiTraining2/tree/master/lectures">lectures</a> that for Bayesian model fitting/inference, we need to:</p>
<ol class="simple">
<li><ul class="simple">
<li><ul>
<li><p>Assess MCMC convergence * * : MCMC is family of algorithm for sampling probability distributions so that it can be adequately characterized (in the Bayesian context the posterior distribution). The MCMC procedure reaches * convergence * once we have sufficient random draws from the posterior distribution. To assess convergence we look at trace plots. The goal is to get “fuzzy caterpillars”-looking curves.</p></li>
</ul>
</li>
</ul>
</li>
<li><ul class="simple">
<li><ul>
<li><p>Summarize MCMC draws * * : Summarize and visualize outcome of the random draws using histograms for all draws for each parameter, and calculate expectation, variance, credibility interval, etc.</p></li>
</ul>
</li>
</ul>
</li>
<li><ul class="simple">
<li><ul>
<li><p>Prior Sensitivity * * : Assess prior sensitivity by changing prior values and check whether it affects the results or not. If it does, that means that the results are too sensitive to that prior, not good!</p></li>
</ul>
</li>
</ul>
</li>
<li><ul class="simple">
<li><ul>
<li><p>Make inferences * * : We use the values from item (2) to make inferences and answer the research question.</p></li>
</ul>
</li>
</ul>
</li>
</ol>
<p>Because likelihoods form the basis for Bayesian model fitting, we will first do an exercise to understand their calculation.</p>
<div class="section" id="a-likelihoods-exercise">
<h3>A Likelihoods exercise<a class="headerlink" href="#a-likelihoods-exercise" title="Permalink to this headline">¶</a></h3>
<div class="section" id="the-binomial-distribution">
<h4>The Binomial Distribution<a class="headerlink" href="#the-binomial-distribution" title="Permalink to this headline">¶</a></h4>
<p>The Binomial distribution is used to model the number of “successes” in a set of trials (e.g., number of heads when you flip a coin <span class="math notranslate nohighlight">\(N\)</span> times). The pmf is</p>
<div class="math notranslate nohighlight">
\[
{N \choose x} p^x(1-p)^{N-x}
\]</div>
<p>such that <span class="math notranslate nohighlight">\(\mathrm{E}[x] = Np \)</span>. Throughout this “experiment”, you will assume that your experiment consists of flipping 20 coins, so that <span class="math notranslate nohighlight">\(N = 20\)</span>.</p>
<p>Let’s use the Binomial distribution to practice two methods of estimating parameters for a probability distribution: method of moments and maximum likelihood.</p>
<div class="section" id="simulating-from-the-binomial-using-r">
<h5>Simulating from the Binomial using R<a class="headerlink" href="#simulating-from-the-binomial-using-r" title="Permalink to this headline">¶</a></h5>
<p>First take 50 draws from a binomial (using <em>rbinom</em>) for each <span class="math notranslate nohighlight">\(p\in\)</span> 0.1, 0.5, 0.8 with <span class="math notranslate nohighlight">\(N=20\)</span>. For this, lets set seed so that we can reproduce this exact sequence of sampling (why?):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set.seed</span><span class="p">(</span><span class="m">54321</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">## 50 draws with each p </span>
<span class="n">pp</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">0.8</span><span class="p">)</span>
<span class="n">N</span> <span class="o">&lt;-</span> <span class="m">20</span>
<span class="n">reps</span> <span class="o">&lt;-</span> <span class="m">50</span> 
</pre></div>
</div>
</div>
</div>
<p>Now plot the histograms of these draws together with the density functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">## histograms + density here</span>
<span class="n">x</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">50</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">bty</span><span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">)</span>

<span class="c1"># Write more code here</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><ul>
<li><p>Q1: Do the histograms look like the distributions for all 3 values of <span class="math notranslate nohighlight">\(p\)</span>? If not, what do you think is going on? * *</p></li>
</ul>
</li>
</ul>
<p>You’ll notice that for <span class="math notranslate nohighlight">\(p=0.1\)</span> the histogram and densities don’t look quite the same – the <code class="docutils literal notranslate"><span class="pre">hist()</span></code> function is lumping together the zeros and ones which makes it look off. This is typical for distributions that are truncated.</p>
</div>
</div>
<div class="section" id="method-of-moments-mom-estimators">
<h4>Method of Moments (MoM) Estimators<a class="headerlink" href="#method-of-moments-mom-estimators" title="Permalink to this headline">¶</a></h4>
<p>To obtain a method of moments estimator, we equate the theoretical moments (which will be a function of the parameters of the distribution) with the corresponding sample moments, and solve for the parameters in order to obtain an estimate. For the binomial distribution, there is only one parameter, <span class="math notranslate nohighlight">\(p\)</span>.</p>
<ul class="simple">
<li><ul>
<li><p>Q2: Given the analytic expected value, above, and assuming that the sample mean is <span class="math notranslate nohighlight">\(m\)</span> (the mean number of observed heads across replicates), what is the MoM estimator for <span class="math notranslate nohighlight">\(p\)</span>? * *</p></li>
</ul>
</li>
</ul>
<p>Now calculate the MoM estimator for each of your 3 sets of simulated data sets to get the estimates for each of your values of <span class="math notranslate nohighlight">\(p\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">## MOM estimators for 3 simulated sets</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><ul>
<li><p>Q3: How good are your estimates for <span class="math notranslate nohighlight">\(p\)</span>? Do you get something close to the true value? * *</p></li>
</ul>
</li>
</ul>
<p>For 1 of your values of <span class="math notranslate nohighlight">\(p\)</span>, take 20 draws from the binomial with <span class="math notranslate nohighlight">\(N=20\)</span> and calculate the MoM. Repeat this 100 times (hint: the <code class="docutils literal notranslate"><span class="pre">replicate()</span></code> and <code class="docutils literal notranslate"><span class="pre">lapply</span></code> functions may be useful.) Make a histogram of your estimates, and add a line/point to the plot to indicate the real value of <span class="math notranslate nohighlight">\(p\)</span> that you used to simulate the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">## MoM estimates, histogram </span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><ul>
<li><p>Q4: Is the MoM successfully estimating <span class="math notranslate nohighlight">\(p\)</span>? Does your histogram for <span class="math notranslate nohighlight">\(p\)</span> look more or less normal? If so, what theorem might explain why this would be the case? * *</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="mle-for-binomial-distribution">
<h4>MLE for Binomial Distribution<a class="headerlink" href="#mle-for-binomial-distribution" title="Permalink to this headline">¶</a></h4>
<div class="section" id="likelihood-and-log-likelihood">
<h5>Likelihood and Log Likelihood<a class="headerlink" href="#likelihood-and-log-likelihood" title="Permalink to this headline">¶</a></h5>
<p>Imagine that you flip a coin <span class="math notranslate nohighlight">\(N\)</span> times, and then repeat the experiment <span class="math notranslate nohighlight">\(n\)</span> times. Thus, you have data <span class="math notranslate nohighlight">\(x=x`1, x`2, \dots x`n\)</span> that are the number of times you observed a head in each trial. <span class="math notranslate nohighlight">\(p\)</span> is the probability of obtaining a head.</p>
<ul class="simple">
<li><ul>
<li><p>Q5: Write down the likelihood and log-likelihood for the data. Take the derivative of the negative log-likelihood, set this equal to zero, and find the MLE, <span class="math notranslate nohighlight">\(\hat{p}\)</span>. * *</p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="computing-the-likelihood-and-mle-in-r">
<h4>Computing the likelihood and MLE in R<a class="headerlink" href="#computing-the-likelihood-and-mle-in-r" title="Permalink to this headline">¶</a></h4>
<p>Simulate some data with <span class="math notranslate nohighlight">\(p=0.25\)</span>, <span class="math notranslate nohighlight">\(N=10\)</span>, and 10 replicates. Calculate the negative log-likelihood of your simulated data across a range of <span class="math notranslate nohighlight">\(p\)</span> (from 0 to 1), and plot them. You may do this by using the built in functions in R (specifically <code class="docutils literal notranslate"><span class="pre">dbinom</span></code>) or write your own function. This is called a “likelihood profile’’. Plot your likelihood profile with a line indicating the true value of <span class="math notranslate nohighlight">\(p\)</span>. Add lines indicating the MLE <span class="math notranslate nohighlight">\(\hat{p}\)</span> and the MoM estimator for <span class="math notranslate nohighlight">\(p\)</span> to your likelihood profile.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">pp</span> <span class="o">&lt;-</span> <span class="n">.</span><span class="m">25</span>
<span class="n">N</span> <span class="o">&lt;-</span> <span class="m">10</span>
<span class="n">reps</span> <span class="o">&lt;-</span> <span class="m">10</span>
<span class="c1">## Make one set of data</span>

<span class="c1">## the likelihood is always exactly zero</span>
<span class="c1">## at p=0,1, so I skip those values</span>
<span class="n">ps</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0.01</span><span class="p">,</span> <span class="m">0.99</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="m">0.01</span><span class="p">)</span> 

<span class="c1">## Likelihood</span>


<span class="c1">## MLE/MoM estimators </span>

<span class="c1">## now plot the negative log likelihood profile</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><ul>
<li><p>Q6: How does your MLE compare to the true parameter value? How could you estimate the MLE from the likelihood profile if you didn’t have a way to calculate the MLE directly? If you chose another version of the random seed, do you get the same answer? * *</p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="example-midge-wing-length">
<h3>Example: Midge Wing Length<a class="headerlink" href="#example-midge-wing-length" title="Permalink to this headline">¶</a></h3>
<p>We will use this simple example to go through the steps of assessing a Bayesian model and we’ll see that MCMC can allow us to approximate the posterior distribution.</p>
<p>Grogan and Wirth (1981) provide data on the wing length (in millimeters) of nine members of a species of midge (small, two-winged flies).</p>
<p>From these measurements we wish to make inference about the population mean <span class="math notranslate nohighlight">\(\mu\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">WL.data</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="s">&quot;../data/MidgeWingLength.csv&quot;</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">&lt;-</span> <span class="n">WL.data</span><span class="o">$</span><span class="n">WingLength</span>
<span class="n">n</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

<span class="nf">hist</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">breaks</span><span class="o">=</span><span class="m">10</span><span class="p">,</span><span class="n">xlab</span><span class="o">=</span><span class="s">&quot;Wing Length (mm)&quot;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_175_0.png" src="../_images/20-ModelFitting_175_0.png" />
</div>
</div>
</div>
<div class="section" id="non-bayesian-analysis">
<h3>Non-Bayesian analysis<a class="headerlink" href="#non-bayesian-analysis" title="Permalink to this headline">¶</a></h3>
<p>We might expect that these midge data could be draws from a <em>Normal</em> distribution <span class="math notranslate nohighlight">\(\mathcal{N}(\mu, \sigma^2)\)</span>. Recall that the MLEs for <span class="math notranslate nohighlight">\(\mu\)</span> and <span class="math notranslate nohighlight">\(\sigma^2\)</span> here are simply the <em>sample mean</em> and <em>sample variance</em> respectively:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
<span class="n">s2</span> <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">((</span><span class="n">Y</span><span class="o">-</span><span class="n">m</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="m">-1</span><span class="p">)</span>
<span class="nf">round</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s2</span><span class="p">),</span> <span class="m">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>1.804</li><li>0.017</li></ol>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">1.4</span><span class="p">,</span><span class="m">2.2</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="m">50</span><span class="p">)</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">breaks</span><span class="o">=</span><span class="m">10</span><span class="p">,</span><span class="n">xlab</span><span class="o">=</span><span class="s">&quot;Wing Length (mm)&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1.4</span><span class="p">,</span> <span class="m">2.2</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span> 
<span class="nf">lines</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nf">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">s2</span><span class="p">)),</span> <span class="n">col</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_178_0.png" src="../_images/20-ModelFitting_178_0.png" />
</div>
</div>
<ul class="simple">
<li><ul>
<li><p>NOTE: * * I’ve plotted the estimate of the <em>population</em> distribution here, but this is not the * * * predictive distribution * * * (which would be a Student T because we’re estimating both the mean and variance…).</p></li>
</ul>
</li>
</ul>
<hr class="docutils" />
<p>The non-Bayesian version here has the advantage of being quick and familiar. However, from our point of view it has two weaknesses:</p>
<ol class="simple">
<li><p>Because we have so few data points estimates of the accuracy of our predictions aren’t available. 9 points is only barely enough to estimate a mean, so we don’t trust any of the variance calculations.</p></li>
<li><p>We can’t easily incorporate things that we might already know about midges into our analysis.</p></li>
</ol>
<p>Let’s see how we can do a similar analysis using a Bayesian approach, first analytically, and the with JAGS.</p>
</div>
<div class="section" id="setting-up-the-bayesian-model">
<h3>Setting up the Bayesian Model<a class="headerlink" href="#setting-up-the-bayesian-model" title="Permalink to this headline">¶</a></h3>
<p>We need to define the likelihood and the priors for our Bayesian analysis. Given the analysis that we’ve just done, let’s assume that our data come from a normal distribution with unknown mean, <span class="math notranslate nohighlight">\(\mu\)</span> but that we know the variance is <span class="math notranslate nohighlight">\(\sigma^2 = 0.025\)</span>. That is:</p>
<div class="math notranslate nohighlight">
\[
\mathbf{Y} \stackrel{\mathrm{iid}}{\sim} \mathcal{N}(\mu, 0.025^2)
\]</div>
<div class="section" id="prior-information">
<h4>Prior Information<a class="headerlink" href="#prior-information" title="Permalink to this headline">¶</a></h4>
<p>Studies from other populations suggest that wing lengths are usually around 1.9 mm, so we set <span class="math notranslate nohighlight">\(\mu_0 = 1.9\)</span></p>
<p>We also know that lengths must be positive (<span class="math notranslate nohighlight">\(\mu &gt;0\)</span>)</p>
<p>We can approximate this restriction with a normal prior distribution for <span class="math notranslate nohighlight">\(\mu\)</span> as follows:</p>
<p>Since most of the normal density is within two standard deviations of the mean we choose <span class="math notranslate nohighlight">\(\tau^2_0\)</span> so that</p>
<div class="math notranslate nohighlight">
\[ \mu_0 - 2\sigma_0 &gt;0 \Rightarrow \sigma_0 &lt;1.9/2 = 0.95 \]</div>
<p>I will choose <span class="math notranslate nohighlight">\(\sigma_0=0.8\)</span> here. Thus our prior for mu will be:
$<span class="math notranslate nohighlight">\(
\mu \sim \mathcal{N}(1.9, 0.8^2)
\)</span>$</p>
<hr class="docutils" />
<p>Together, then, our full model is:</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
    \mathbf{Y} &amp; \stackrel{\mathrm{iid}}{\sim} \mathcal{N}(\mu, 0.025^2)\\
    \mu &amp;\sim \mathcal{N}(1.9, 0.8^2)
\end{align*}\]</div>
</div>
</div>
<div class="section" id="analytic-posterior">
<h3>Analytic Posterior<a class="headerlink" href="#analytic-posterior" title="Permalink to this headline">¶</a></h3>
<p>For this very simple case it is easy to write down the posterior distribution (up to some constant). First, note that the likelihood for the data can be written as</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
    \mathcal{L} &amp;\propto \prod_{i=1}^n \frac{1}{\sigma} \exp\left(-\frac{1}{2\sigma^2}(Y_i-\mu)^2 \right) \\
    &amp; = \frac{1}{\sigma^n} \exp\left(-\frac{1}{2\sigma^2}\sum_{i=1}^n (Y_i-\mu)^2 \right)\\
    &amp; \propto \exp\left(-\frac{n}{2\sigma^2} (\bar{Y}-\mu)^2 \right)
\end{align*}\]</div>
<p>Multiplying the prior through we get the following for the posterior:</p>
<div class="math notranslate nohighlight">
\[
\mathrm{P}(\mu|\mathbf{Y}) \propto \exp \left(-\frac{n}{2\sigma^2} (\bar{Y}-\mu)^2 \right) \exp\left(-\frac{1}{2\sigma_0^2}(\mu-\mu_0)^2 \right)
\]</div>
<p>You can re-arrange, complete the square, etc, to get a new expression that is like</p>
<div class="math notranslate nohighlight">
\[
\mathrm{P}(\mu|\mathbf{Y}) \propto \exp \left(-\frac{1}{2\sigma_p^2} (\mu_p-\mu)^2 \right)
\]</div>
<p>where</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\mu_p &amp; = \frac{n\sigma_0^2}{\sigma^2 + n\sigma_0^2} \bar{Y} + \frac{\sigma^2}{\frac{\sigma^2}{n} + \sigma_0^2} \mu_0\\
&amp; \\
\sigma_p^2 &amp; = \left( \frac{n}{\sigma^2} + \frac{1}{\sigma_0^2} \right)^{-1}
\end{align*}\]</div>
<p>Instead of writing this last in terms of the variances, we could instead use precision (the inverse variance) which gives a simpler expression:</p>
<div class="math notranslate nohighlight">
\[
\tau_p = n\tau + \tau_0
\]</div>
<p>Just like in our earlier example, our estimate of the mean is a weighted average of the data and the prior, with the variance being determined by the data and prior variances.</p>
<p>So lets write a little function to calculate <span class="math notranslate nohighlight">\(\mu_p\)</span> and <span class="math notranslate nohighlight">\(\tau_p\)</span> and the plug in our numbers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">tau.post</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">tau0</span><span class="p">,</span> <span class="n">n</span><span class="p">){</span><span class="n">n</span> <span class="o">*</span> <span class="n">tau</span> <span class="o">+</span> <span class="n">tau0</span><span class="p">}</span>
<span class="n">mu.post</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">Ybar</span><span class="p">,</span> <span class="n">mu0</span><span class="p">,</span> <span class="n">sig20</span><span class="p">,</span> <span class="n">sig2</span><span class="p">,</span> <span class="n">n</span><span class="p">){</span>
 <span class="n">weight</span> <span class="o">&lt;-</span> <span class="n">sig2</span><span class="o">+</span><span class="n">n</span> <span class="o">*</span> <span class="n">sig20</span>
 
 <span class="nf">return</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">sig20</span> <span class="o">*</span> <span class="n">Ybar</span><span class="o">/</span><span class="n">weight</span> <span class="o">+</span> <span class="n">sig2</span> <span class="o">*</span> <span class="n">mu0</span><span class="o">/</span><span class="n">weight</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s plot 3 things together – the data histogram, the prior, and the posterior:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">mu0</span> <span class="o">&lt;-</span> <span class="m">1.9</span>
<span class="n">s20</span> <span class="o">&lt;-</span> <span class="m">0.8</span>
<span class="n">s2</span> <span class="o">&lt;-</span> <span class="m">0.025</span> <span class="c1">## &quot;true&quot; variance</span>

<span class="n">mp</span> <span class="o">&lt;-</span> <span class="nf">mu.post</span><span class="p">(</span><span class="n">Ybar</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">mu0</span><span class="o">=</span><span class="n">mu0</span><span class="p">,</span> <span class="n">sig20</span><span class="o">=</span><span class="n">s20</span><span class="p">,</span> <span class="n">sig2</span><span class="o">=</span><span class="n">s2</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">tp</span> <span class="o">&lt;-</span> <span class="nf">tau.post</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="m">1</span><span class="o">/</span><span class="n">s2</span><span class="p">,</span> <span class="n">tau0</span><span class="o">=</span><span class="m">1</span><span class="o">/</span><span class="n">s20</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s plot the result:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">1.3</span><span class="p">,</span><span class="m">2.3</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="m">1000</span><span class="p">)</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">breaks</span><span class="o">=</span><span class="m">10</span><span class="p">,</span><span class="n">xlab</span><span class="o">=</span><span class="s">&quot;Wing Length (mm)&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1.3</span><span class="p">,</span> <span class="m">2.3</span><span class="p">),</span>
  <span class="n">freq</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">8</span><span class="p">))</span> 
<span class="nf">lines</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nf">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mu0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">s20</span><span class="p">)),</span> <span class="n">col</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lty</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span> <span class="c1">## prior</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nf">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mp</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="nf">sqrt</span><span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="n">tp</span><span class="p">)),</span> <span class="n">col</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span> <span class="c1">## posterior</span>
<span class="nf">legend</span><span class="p">(</span><span class="s">&quot;topleft&quot;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;prior&quot;</span><span class="p">,</span> <span class="s">&quot;posterior&quot;</span><span class="p">),</span> <span class="n">col</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">4</span><span class="p">),</span> <span class="n">lty</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_184_0.png" src="../_images/20-ModelFitting_184_0.png" />
</div>
</div>
</div>
<div class="section" id="exercise-prior-sensitivity">
<h3>Exercise: Prior sensitivity<a class="headerlink" href="#exercise-prior-sensitivity" title="Permalink to this headline">¶</a></h3>
<p>Change the values of the mean and the variance that you choose for the prior (“hyperparameters”). What does this do to the posterior distribution. E.g., what happens if the variance you choose is small, and <span class="math notranslate nohighlight">\(\mu_0 =2.5\)</span> or so. Is this what you expect?</p>
</div>
<div class="section" id="numerical-evaluation-of-the-posterior-with-jags">
<h3>Numerical evaluation of the posterior with JAGS<a class="headerlink" href="#numerical-evaluation-of-the-posterior-with-jags" title="Permalink to this headline">¶</a></h3>
<p>Let’s show that we can get the same thing from JAGS that we were able to get from the analytic results. You’ll need to make sure you have installed JAGS (which must be done outside of R) and then the libraries <code class="docutils literal notranslate"><span class="pre">rjags</span></code> and <code class="docutils literal notranslate"><span class="pre">coda</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load libraries</span>
<span class="nf">require</span><span class="p">(</span><span class="n">rjags</span><span class="p">)</span> <span class="c1"># does the fitting</span>
<span class="nf">require</span><span class="p">(</span><span class="n">coda</span><span class="p">)</span> <span class="c1"># makes diagnostic plots</span>
<span class="c1">##require(mcmcplots) # another option for diagnostic plots</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading required package: rjags

Loading required package: coda

Linked to JAGS 4.3.0

Loaded modules: basemod,bugs
</pre></div>
</div>
</div>
</div>
<div class="section" id="specifying-the-model">
<h4>Specifying the model<a class="headerlink" href="#specifying-the-model" title="Permalink to this headline">¶</a></h4>
<p>First we must encode our choices for our data model and priors to pass them to the fitting routines in JAGS. This involves setting up a <span class="math notranslate nohighlight">\({\tt model}\)</span> that includes the likelihood for each data point and a prior for every parameter we want to estimate. Here is an example of how we would do this for the simple model we fit for the midge data (note that JAGS uses the precision instead of the variance or sd for the normal distribution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">model1</span> <span class="o">&lt;-</span> <span class="s">&quot;model{</span>

<span class="s"> ## Likelihood</span>
<span class="s"> for(i in 1:n){</span>
<span class="s"> Y[i] ~ dnorm(mu,tau)</span>
<span class="s"> }</span>

<span class="s"> ## Prior for mu</span>
<span class="s"> mu  ~ dnorm(mu0,tau0)</span>

<span class="s">} ## close model </span>
<span class="s">&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Now create the JAGS model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">&lt;-</span> <span class="nf">jags.model</span><span class="p">(</span><span class="nf">textConnection</span><span class="p">(</span><span class="n">model1</span><span class="p">),</span> 
     <span class="n">n.chains</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="c1">## usually do more</span>
     <span class="n">data</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="c1">## data</span>
        <span class="n">mu0</span><span class="o">=</span><span class="n">mu0</span><span class="p">,</span> <span class="n">tau0</span><span class="o">=</span><span class="m">1</span><span class="o">/</span><span class="n">s20</span><span class="p">,</span> <span class="c1">## hyperparams</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="m">1</span><span class="o">/</span><span class="n">s2</span> <span class="c1">## known precision</span>
        <span class="p">),</span>
     <span class="n">inits</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="m">3</span><span class="p">)</span> <span class="c1">## setting an starting val</span>
     <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Compiling model graph
   Resolving undeclared variables
   Allocating nodes
Graph information:
   Observed stochastic nodes: 9
   Unobserved stochastic nodes: 1
   Total graph size: 735

Initializing model
</pre></div>
</div>
</div>
</div>
<p>Now we’ll run the MCMC and, see how the output looks for a short chain with no burnin:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">samp</span> <span class="o">&lt;-</span> <span class="nf">coda.samples</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> 
  <span class="n">variable.names</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;mu&quot;</span><span class="p">),</span> 
  <span class="n">n.iter</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span> <span class="n">progress.bar</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">)</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">samp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_192_0.png" src="../_images/20-ModelFitting_192_0.png" />
</div>
</div>
<p>MCMC is a rejection algorithm that often needs to converge or “burn-in” – that is we need to potentially move until we’re taking draws from the correct distribution. Unlike for optimization problems, this does not mean that the algorithm :eads toward a single value. Instead we’re looking for a pattern where the draws are seemingly unrelated and random. To assess convergence we look at trace plots, the goal is to get traces that look like “fuzzy caterpillars”.</p>
<p>Sometimes at the beginning of a run, if we start far from the area near the posterior mean of the parameter, we will instead get something that looks like a trending time series. If this is the case we have to drop the samples that were taken during the burn-in phase. Here’s an example of how to do that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">update</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="m">10000</span><span class="p">,</span> <span class="n">progress.bar</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">)</span> <span class="c1"># Burnin for 10000 samples</span>

<span class="n">samp</span> <span class="o">&lt;-</span> <span class="nf">coda.samples</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> 
  <span class="n">variable.names</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;mu&quot;</span><span class="p">),</span> 
  <span class="n">n.iter</span><span class="o">=</span><span class="m">20000</span><span class="p">,</span> <span class="n">progress.bar</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">)</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">samp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_194_0.png" src="../_images/20-ModelFitting_194_0.png" />
</div>
</div>
<p>This is a very fuzzy caterpillar!</p>
<p>We can also use the summary function to examine the samples generated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">summary</span><span class="p">(</span><span class="n">samp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iterations = 11001:31000
Thinning interval = 1 
Number of chains = 1 
Sample size per chain = 20000 

1. Empirical mean and standard deviation for each variable,
   plus standard error of the mean:

          Mean             SD       Naive SE Time-series SE 
     0.1198035      0.0523818      0.0003704      0.0003704 

2. Quantiles for each variable:

   2.5%     25%     50%     75%   97.5% 
0.01777 0.08413 0.12008 0.15490 0.22154 
</pre></div>
</div>
</div>
</div>
<p>Let’s compare these draws to what we got with our analytic solution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">1.3</span><span class="p">,</span><span class="m">2.3</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="m">1000</span><span class="p">)</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">samp</span><span class="p">[[</span><span class="m">1</span><span class="p">]],</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;mu&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1.3</span><span class="p">,</span> <span class="m">2.3</span><span class="p">),</span>
  <span class="n">freq</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">8</span><span class="p">),</span> <span class="n">main</span> <span class="o">=</span><span class="s">&quot;posterior samples&quot;</span><span class="p">)</span> 
<span class="nf">lines</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nf">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mu0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">s20</span><span class="p">)),</span> <span class="n">col</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lty</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span> <span class="c1">## prior</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nf">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mp</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="nf">sqrt</span><span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="n">tp</span><span class="p">)),</span> <span class="n">col</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span> <span class="c1">## posterior</span>
<span class="nf">legend</span><span class="p">(</span><span class="s">&quot;topleft&quot;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;prior&quot;</span><span class="p">,</span> <span class="s">&quot;analytic posterior&quot;</span><span class="p">),</span> <span class="n">col</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">4</span><span class="p">),</span> <span class="n">lty</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_198_0.png" src="../_images/20-ModelFitting_198_0.png" />
</div>
</div>
<p>It worked!</p>
<p>As with the analytic approach, it’s always a good idea when you run your analyses to see how sensitive is your result to the priors you choose. Unless you are purposefully choosing an informative prior, we usually want the prior and posterior to look different.</p>
</div>
</div>
<div class="section" id="estimating-the-population-variance">
<h3>Estimating the population variance<a class="headerlink" href="#estimating-the-population-variance" title="Permalink to this headline">¶</a></h3>
<p>One advantage of the numerical approach is that we can choose almost anything we want for the priors on multiple parameters without worrying if they are conjugate, or if we want to include additional information. For example, let’s say that, not, we want to force the mean to be positive (and also the data, perhaps), and concurrently estimate the variance. Here is a possible model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span> <span class="o">&lt;-</span> <span class="s">&quot;model{</span>

<span class="s"> # Likelihood</span>
<span class="s"> for(i in 1:n){</span>
<span class="s"> Y[i] ~ dnorm(mu,tau) T(0,) ## truncates at 0</span>
<span class="s"> }</span>

<span class="s"> # Prior for mu</span>
<span class="s"> mu ~ dnorm(mu0,tau0)</span>

<span class="s"> # Prior for the precision</span>
<span class="s"> tau ~ dgamma(a, b)</span>

<span class="s"> # Compute the variance</span>
<span class="s"> s2  &lt;- 1/tau</span>
<span class="s">}&quot;</span>

<span class="c1">## hyperparams for tau</span>
<span class="n">a</span> <span class="o">&lt;-</span> <span class="m">0.01</span>
<span class="n">b</span> <span class="o">&lt;-</span> <span class="m">0.01</span>

<span class="n">m2</span> <span class="o">&lt;-</span> <span class="nf">jags.model</span><span class="p">(</span><span class="nf">textConnection</span><span class="p">(</span><span class="n">model2</span><span class="p">),</span> 
     <span class="n">n.chains</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span>
     <span class="n">data</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
        <span class="n">mu0</span><span class="o">=</span><span class="n">mu0</span><span class="p">,</span> <span class="n">tau0</span><span class="o">=</span><span class="m">1</span><span class="o">/</span><span class="n">s20</span><span class="p">,</span> <span class="c1">## mu hyperparams</span>
        <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span> <span class="c1">## tau hyperparams</span>
        <span class="p">),</span>
     <span class="n">inits</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="m">3</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="m">10</span><span class="p">)</span> <span class="c1">## starting vals</span>
    <span class="p">)</span>

<span class="n">samp</span> <span class="o">&lt;-</span> <span class="nf">coda.samples</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> 
  <span class="n">variable.names</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;mu&quot;</span><span class="p">,</span><span class="s">&quot;s2&quot;</span><span class="p">),</span> 
  <span class="n">n.iter</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span> <span class="n">progress.bar</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">)</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">samp</span><span class="p">)</span>

<span class="nf">summary</span><span class="p">(</span><span class="n">samp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Compiling model graph
   Resolving undeclared variables
   Allocating nodes
Graph information:
   Observed stochastic nodes: 9
   Unobserved stochastic nodes: 2
   Total graph size: 740

Initializing model
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iterations = 1001:2000
Thinning interval = 1 
Number of chains = 1 
Sample size per chain = 1000 

1. Empirical mean and standard deviation for each variable,
   plus standard error of the mean:

      Mean      SD  Naive SE Time-series SE
mu 0.06889 0.10389 0.0032853       0.016476
s2 0.01029 0.01799 0.0005689       0.002442

2. Quantiles for each variable:

        2.5%      25%      50%     75%  97.5%
mu -0.288547 0.071837 0.103609 0.11822 0.1525
s2  0.001188 0.002328 0.003969 0.01011 0.0590
</pre></div>
</div>
<img alt="../_images/20-ModelFitting_200_2.png" src="../_images/20-ModelFitting_200_2.png" />
</div>
</div>
<p>Now we plot each with their priors:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">bty</span><span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">)</span>

<span class="nf">hist</span><span class="p">(</span><span class="n">samp</span><span class="p">[[</span><span class="m">1</span><span class="p">]][,</span><span class="m">1</span><span class="p">],</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;samples of mu&quot;</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;mu&quot;</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nf">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mu0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">s20</span><span class="p">)),</span> 
  <span class="n">col</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lty</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span> <span class="c1">## prior</span>

<span class="n">x2</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">200</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="m">1000</span><span class="p">)</span>
<span class="nf">hist</span><span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="n">samp</span><span class="p">[[</span><span class="m">1</span><span class="p">]][,</span><span class="m">2</span><span class="p">],</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;samples of tau&quot;</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;tau&quot;</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="nf">dgamma</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">b</span><span class="p">),</span> 
  <span class="n">col</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lty</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span> <span class="c1">## prior</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_202_0.png" src="../_images/20-ModelFitting_202_0.png" />
</div>
</div>
<p>We also want to look at the joint distribution of <span class="math notranslate nohighlight">\(\mu\)</span> and <span class="math notranslate nohighlight">\(\sigma^2\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">samp</span><span class="p">[[</span><span class="m">1</span><span class="p">]][,</span><span class="m">1</span><span class="p">]),</span> <span class="n">samp</span><span class="p">[[</span><span class="m">1</span><span class="p">]][,</span><span class="m">2</span><span class="p">],</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;mu&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;s2&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_204_0.png" src="../_images/20-ModelFitting_204_0.png" />
</div>
</div>
</div>
<div class="section" id="exercise-updating-the-bayesian-model">
<h3>Exercise: Updating the Bayesian model<a class="headerlink" href="#exercise-updating-the-bayesian-model" title="Permalink to this headline">¶</a></h3>
<p>Redo the previous analysis placing a gamma prior on <span class="math notranslate nohighlight">\(\mu\)</span> as well. Set the prior so that the mean and variance are the same as in the normal example from above (use moment matching). Do you get something similar?</p>
</div>
<div class="section" id="aedes-data-revisited-using-bayesian-fitting">
<h3>Aedes data revisited using Bayesian fitting<a class="headerlink" href="#aedes-data-revisited-using-bayesian-fitting" title="Permalink to this headline">¶</a></h3>
<p>Now let’s do some Bayesian model fitting to * Aedes * thermal performance data. Lets try out the <code class="docutils literal notranslate"><span class="pre">R2jags</span></code> package for this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">require</span><span class="p">(</span><span class="n">R2jags</span><span class="p">)</span> <span class="c1"># fitting</span>
<span class="nf">require</span><span class="p">(</span><span class="n">coda</span><span class="p">)</span> <span class="c1"># diagnostic plots</span>
<span class="nf">set.seed</span><span class="p">(</span><span class="m">1234</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading required package: R2jags

Loading required package: rjags

Linked to JAGS 4.3.0

Loaded modules: basemod,bugs


Attaching package: ‘R2jags’


The following object is masked from ‘package:coda’:

    traceplot
</pre></div>
</div>
</div>
</div>
<p>Load the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Aaeg.data</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="s">&quot;../data/AeaegyptiTraitData.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="the-data">
<h4>The Data<a class="headerlink" href="#the-data" title="Permalink to this headline">¶</a></h4>
<p>These data are traits from * Aedes aegypti * mosquitoes measured across temperature in lab experiments. The traits we have data on thermal performance are:</p>
<ul class="simple">
<li><p>pEA: proportion surviving from egg to adulthood</p></li>
<li><p>MDR: mosquito development rate</p></li>
<li><p>PDR: parasite development rate (= 1/EIP the extrinsic incubation period)</p></li>
<li><p><span class="math notranslate nohighlight">\(\mu\)</span> (mu): death rate (= 1/longevity)</p></li>
</ul>
<p>Note that some of the traits come in multiple forms (e.g., <span class="math notranslate nohighlight">\(\mu\)</span> and 1/<span class="math notranslate nohighlight">\(\mu\)</span>, PDR and EIP).</p>
<p>Have a look at the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">head</span><span class="p">(</span><span class="n">Aaeg.data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A data.frame: 6 × 6</caption>
<thead>
	<tr><th></th><th scope=col>trait.name</th><th scope=col>T</th><th scope=col>trait</th><th scope=col>ref</th><th scope=col>trait2</th><th scope=col>trait2.name</th></tr>
	<tr><th></th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>pEA</td><td>22</td><td>0.90812</td><td>Westbrook_Thesis_2010</td><td>NA</td><td>NA</td></tr>
	<tr><th scope=row>2</th><td>pEA</td><td>27</td><td>0.93590</td><td>Westbrook_Thesis_2010</td><td>NA</td><td>NA</td></tr>
	<tr><th scope=row>3</th><td>pEA</td><td>32</td><td>0.81944</td><td>Westbrook_Thesis_2010</td><td>NA</td><td>NA</td></tr>
	<tr><th scope=row>4</th><td>MDR</td><td>22</td><td>0.09174</td><td>Westbrook_Thesis_2010</td><td>NA</td><td>NA</td></tr>
	<tr><th scope=row>5</th><td>MDR</td><td>27</td><td>0.13587</td><td>Westbrook_Thesis_2010</td><td>NA</td><td>NA</td></tr>
	<tr><th scope=row>6</th><td>MDR</td><td>32</td><td>0.15823</td><td>Westbrook_Thesis_2010</td><td>NA</td><td>NA</td></tr>
</tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">mu.data</span> <span class="o">&lt;-</span> <span class="nf">subset</span><span class="p">(</span><span class="n">Aaeg.data</span><span class="p">,</span> <span class="n">trait.name</span> <span class="o">==</span> <span class="s">&quot;mu&quot;</span><span class="p">)</span>
<span class="n">lf.data</span> <span class="o">&lt;-</span> <span class="nf">subset</span><span class="p">(</span><span class="n">Aaeg.data</span><span class="p">,</span> <span class="n">trait.name</span> <span class="o">==</span> <span class="s">&quot;1/mu&quot;</span><span class="p">)</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">bty</span><span class="o">=</span><span class="s">&quot;l&quot;</span><span class="p">)</span> 
<span class="nf">plot</span><span class="p">(</span><span class="n">trait</span> <span class="o">~</span> <span class="bp">T</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mu.data</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;mu&quot;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">trait</span> <span class="o">~</span> <span class="bp">T</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">lf.data</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;1/mu&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_212_0.png" src="../_images/20-ModelFitting_212_0.png" />
</div>
</div>
<p>Note that the <span class="math notranslate nohighlight">\(\mu\)</span> data is u-shaped and the lifespan data is unimodal (hump-shaped).</p>
<p>Since thermal biology theory is based on unimodal thermal responses, we want to fit the trait as lifespan instead of <span class="math notranslate nohighlight">\(\mu\)</span>. Thus, we’ll need to convert the <span class="math notranslate nohighlight">\(\mu\)</span> data to lifespan by taking the inverse. The combined data should have a nice unimodal shape that we can fit a function to:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">mu.data.inv</span> <span class="o">&lt;-</span> <span class="n">mu.data</span> <span class="c1"># make a copy of the mu data</span>
<span class="n">mu.data.inv</span><span class="o">$</span><span class="n">trait</span> <span class="o">&lt;-</span> <span class="m">1</span><span class="o">/</span><span class="n">mu.data</span><span class="o">$</span><span class="n">trait</span> <span class="c1"># take the inverse of the trait values to convert mu to lifespan</span>
<span class="n">lf.data.comb</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">mu.data.inv</span><span class="p">,</span> <span class="n">lf.data</span><span class="p">)</span> <span class="c1"># combine both lifespan data sets together </span>
 
<span class="nf">plot</span><span class="p">(</span><span class="n">trait</span> <span class="o">~</span> <span class="bp">T</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">lf.data.comb</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;1/mu&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_214_0.png" src="../_images/20-ModelFitting_214_0.png" />
</div>
</div>
</div>
<div class="section" id="two-thermal-performance-curve-models">
<h4>Two thermal performance curve models<a class="headerlink" href="#two-thermal-performance-curve-models" title="Permalink to this headline">¶</a></h4>
<p>Most thermal response curves can be reasonably fit using one of two thermal reponses. Traits that respond unimodally but symmetrically to temperature can be fit with a quadratic function:</p>
<p><span class="math notranslate nohighlight">\( B = q (T-T_0) (T-T_m)\)</span></p>
<p>Traits that respond unimodally but asymmetrically can be fitted with a Briere function (see definition <a class="reference internal" href="Appendix-MiniProj.html#miniproj-tpcs-models"><span class="std std-ref">here</span></a>).</p>
<p>In both models, <span class="math notranslate nohighlight">\(T_0\)</span> is the lower thermal limit, <span class="math notranslate nohighlight">\(T_m\)</span> is the upper thermal limit (i.e., where the trait value goes to zero on either end), and <span class="math notranslate nohighlight">\(q\)</span> scales the elevation of the curve, (and so also the value at the optimum temperature).</p>
</div>
<div class="section" id="the-thermal-response-model-file">
<h4>The thermal response model file<a class="headerlink" href="#the-thermal-response-model-file" title="Permalink to this headline">¶</a></h4>
<p>Unlike the previous bayesian \example, here we will provide jags with the model written as a <code class="docutils literal notranslate"><span class="pre">.txt</span></code> file. THis can be in your working directory, or elsewhere (but then inout the full path to it — ideally a relative path).</p>
<p>You can either write the text yourself directly to the file, or create it using the sink() function via your R script (see below):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">sink</span><span class="p">(</span><span class="s">&quot;quad.txt&quot;</span><span class="p">)</span> <span class="c1"># create a file</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;</span>
<span class="s"> model{</span>
<span class="s"> </span>
<span class="s"> ## Priors</span>
<span class="s"> cf.q ~ dunif(0, 1)</span>
<span class="s"> cf.T0 ~ dunif(0, 24)</span>
<span class="s"> cf.Tm ~ dunif(25, 45)</span>
<span class="s"> cf.sigma ~ dunif(0, 1000)</span>
<span class="s"> cf.tau &lt;- 1 / (cf.sigma * cf.sigma)</span>
<span class="s"> </span>
<span class="s"> ## Likelihood</span>
<span class="s"> for(i in 1:N.obs){</span>
<span class="s"> trait.mu[i] &lt;- -1 * cf.q * (temp[i] - cf.T0) * (temp[i] - cf.Tm) * (cf.Tm &gt; temp[i]) * (cf.T0 &lt; temp[i])</span>
<span class="s"> trait[i] ~ dnorm(trait.mu[i], cf.tau)</span>
<span class="s"> }</span>
<span class="s"> </span>
<span class="s"> ## Derived Quantities and Predictions</span>
<span class="s"> for(i in 1:N.Temp.xs){</span>
<span class="s"> z.trait.mu.pred[i] &lt;- -1 * cf.q * (Temp.xs[i] - cf.T0) * (Temp.xs[i] - cf.Tm) * (cf.Tm &gt; Temp.xs[i]) * (cf.T0 &lt; Temp.xs[i])</span>
<span class="s"> }</span>
<span class="s"> } # close model</span>
<span class="s">&quot;</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="bp">T</span><span class="p">)</span>
<span class="nf">sink</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> model{
 
 ## Priors
 cf.q ~ dunif(0, 1)
 cf.T0 ~ dunif(0, 24)
 cf.Tm ~ dunif(25, 45)
 cf.sigma ~ dunif(0, 1000)
 cf.tau &lt;- 1 / (cf.sigma * cf.sigma)
 
 ## Likelihood
 for(i in 1:N.obs){
 trait.mu[i] &lt;- -1 * cf.q * (temp[i] - cf.T0) * (temp[i] - cf.Tm) * (cf.Tm &gt; temp[i]) * (cf.T0 &lt; temp[i])
 trait[i] ~ dnorm(trait.mu[i], cf.tau)
 }
 
 ## Derived Quantities and Predictions
 for(i in 1:N.Temp.xs){
 z.trait.mu.pred[i] &lt;- -1 * cf.q * (Temp.xs[i] - cf.T0) * (Temp.xs[i] - cf.Tm) * (cf.Tm &gt; Temp.xs[i]) * (cf.T0 &lt; Temp.xs[i])
 }
 } # close model
</pre></div>
</div>
</div>
</div>
<p>Note that the model file <code class="docutils literal notranslate"><span class="pre">quad.txt</span></code> has two mandatory sections (the priors and the likelihood) and one optional section (derived measures calculated from your fitted parameters).</p>
<p>In the example below for a quadratic function, most of the priors are specified via uniform distributions (the two arguments specific the lower and upper bounds, respectively). Note that unlike in R and most other programs, in jags, the inverse of the variance of the normal distribution is used, denoted by <span class="math notranslate nohighlight">\(\tau (= \frac{1}{\sigma^2}\)</span>).</p>
<p>The likelihood for can be interpreted as follows: the observed data are normally distributed where the mean at a given temperature follows the quadratic equation.</p>
<p>Now, prepare the data for jags:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parameters to Estimate</span>
<span class="n">parameters</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;cf.q&quot;</span><span class="p">,</span> <span class="s">&quot;cf.T0&quot;</span><span class="p">,</span> <span class="s">&quot;cf.Tm&quot;</span><span class="p">,</span><span class="s">&quot;cf.sigma&quot;</span><span class="p">,</span> <span class="s">&quot;z.trait.mu.pred&quot;</span><span class="p">)</span>

<span class="c1"># Initial values for the parameters</span>
<span class="n">inits</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(){</span><span class="nf">list</span><span class="p">(</span>
 <span class="n">cf.q</span> <span class="o">=</span> <span class="m">0.01</span><span class="p">,</span>
 <span class="n">cf.Tm</span> <span class="o">=</span> <span class="m">35</span><span class="p">,</span>
 <span class="n">cf.T0</span> <span class="o">=</span> <span class="m">5</span><span class="p">,</span>
 <span class="n">cf.sigma</span> <span class="o">=</span> <span class="nf">rlnorm</span><span class="p">(</span><span class="m">1</span><span class="p">))}</span>

<span class="c1"># MCMC Settings: number of posterior dist elements = [(ni - nb) / nt ] * nc</span>
<span class="n">ni</span> <span class="o">&lt;-</span> <span class="m">25000</span> <span class="c1"># number of iterations in each chain</span>
<span class="n">nb</span> <span class="o">&lt;-</span> <span class="m">5000</span> <span class="c1"># number of &#39;burn in&#39; iterations to discard</span>
<span class="n">nt</span> <span class="o">&lt;-</span> <span class="m">8</span> <span class="c1"># thinning rate - jags saves every nt iterations in each chain</span>
<span class="n">nc</span> <span class="o">&lt;-</span> <span class="m">3</span> <span class="c1"># number of chains</span>

<span class="c1"># Temperature sequence for derived quantity calculations</span>
<span class="n">Temp.xs</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">45</span><span class="p">,</span> <span class="m">0.2</span><span class="p">)</span>
<span class="n">N.Temp.xs</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">Temp.xs</span><span class="p">)</span>

<span class="c1">### Fitting the trait thermal response; Pull out data columns as vectors</span>
<span class="n">data</span> <span class="o">&lt;-</span> <span class="n">lf.data.comb</span> <span class="c1"># this lets us reuse the same generic code: we only change this first line</span>
<span class="n">trait</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="o">$</span><span class="n">trait</span>
<span class="n">N.obs</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">trait</span><span class="p">)</span>
<span class="n">temp</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="o">$</span><span class="bp">T</span>

<span class="c1"># Bundle all data in a list for JAGS</span>
<span class="n">jag.data</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">trait</span> <span class="o">=</span> <span class="n">trait</span><span class="p">,</span> <span class="n">N.obs</span> <span class="o">=</span> <span class="n">N.obs</span><span class="p">,</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">,</span> <span class="n">Temp.xs</span> <span class="o">=</span> <span class="n">Temp.xs</span><span class="p">,</span> <span class="n">N.Temp.xs</span> <span class="o">=</span> <span class="n">N.Temp.xs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now run the fitting using jags:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">lf.fit</span> <span class="o">&lt;-</span> <span class="nf">jags</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">jag.data</span><span class="p">,</span> <span class="n">inits</span><span class="o">=</span><span class="n">inits</span><span class="p">,</span> <span class="n">parameters.to.save</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> 
    <span class="n">model.file</span><span class="o">=</span><span class="s">&quot;quad.txt&quot;</span><span class="p">,</span> <span class="n">n.thin</span><span class="o">=</span><span class="n">nt</span><span class="p">,</span> <span class="n">n.chains</span><span class="o">=</span><span class="n">nc</span><span class="p">,</span> <span class="n">n.burnin</span><span class="o">=</span><span class="n">nb</span><span class="p">,</span> 
    <span class="n">n.iter</span><span class="o">=</span><span class="n">ni</span><span class="p">,</span> <span class="n">DIC</span><span class="o">=</span><span class="bp">T</span><span class="p">,</span> <span class="n">working.directory</span><span class="o">=</span><span class="nf">getwd</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module glm loaded

Warning message in jags.model(model.file, data = data, inits = init.values, n.chains = n.chains, :
“Unused variable &quot;trait&quot; in data”
Warning message in jags.model(model.file, data = data, inits = init.values, n.chains = n.chains, :
“Unused variable &quot;N.obs&quot; in data”
Warning message in jags.model(model.file, data = data, inits = init.values, n.chains = n.chains, :
“Unused variable &quot;temp&quot; in data”
Warning message in jags.model(model.file, data = data, inits = init.values, n.chains = n.chains, :
“Unused variable &quot;Temp.xs&quot; in data”
Warning message in jags.model(model.file, data = data, inits = init.values, n.chains = n.chains, :
“Unused variable &quot;N.Temp.xs&quot; in data”
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Compiling model graph
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">jags</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">inits</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">chains</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">chains</span><span class="p">,</span> <span class="p">:</span> <span class="n">Nothing</span> <span class="n">to</span> <span class="nb">compile</span>


<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">jags</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">jag</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">inits</span> <span class="o">=</span> <span class="n">inits</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">,</span> 
 <span class="o">.</span>     <span class="n">model</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;quad.txt&quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">thin</span> <span class="o">=</span> <span class="n">nt</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">chains</span> <span class="o">=</span> <span class="n">nc</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">burnin</span> <span class="o">=</span> <span class="n">nb</span><span class="p">,</span> 
 <span class="o">.</span>     <span class="n">n</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="n">ni</span><span class="p">,</span> <span class="n">DIC</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="n">working</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">getwd</span><span class="p">())</span>
<span class="mi">2</span><span class="o">.</span> <span class="n">jags</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">inits</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">chains</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">chains</span><span class="p">,</span> 
 <span class="o">.</span>     <span class="n">n</span><span class="o">.</span><span class="n">adapt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Change into “mcmc” type samples for visualization with the <code class="docutils literal notranslate"><span class="pre">coda</span></code> package:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">lf.fit.mcmc</span> <span class="o">&lt;-</span> <span class="nf">as.mcmc</span><span class="p">(</span><span class="n">lf.fit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="k">as</span><span class="o">.</span><span class="n">mcmc</span><span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">fit</span><span class="p">):</span> <span class="nb">object</span> <span class="s1">&#39;lf.fit&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="k">as</span><span class="o">.</span><span class="n">mcmc</span><span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">fit</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="running-diagnostics">
<h4>Running diagnostics<a class="headerlink" href="#running-diagnostics" title="Permalink to this headline">¶</a></h4>
<p>View the parameters (only the first 5 lines, or it will also show you all of your derived quantities):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">lf.fit</span><span class="o">$</span><span class="n">BUGSoutput</span><span class="o">$</span><span class="n">summary</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">envir</span><span class="p">,</span> <span class="n">enclos</span><span class="p">):</span> <span class="nb">object</span> <span class="s1">&#39;lf.fit&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:
</pre></div>
</div>
</div>
</div>
<p>Plot the chains:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">lf.fit.mcmc</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">4</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">plot</span><span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">mcmc</span><span class="p">[,</span> <span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]):</span> <span class="nb">object</span> <span class="s1">&#39;lf.fit.mcmc&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">plot</span><span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">mcmc</span><span class="p">[,</span> <span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="plot-the-fits">
<h4>Plot the fits<a class="headerlink" href="#plot-the-fits" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">trait</span> <span class="o">~</span> <span class="bp">T</span><span class="p">,</span> <span class="n">xlim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">45</span><span class="p">),</span> <span class="n">ylim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">42</span><span class="p">),</span> <span class="n">data</span> <span class="o">=</span> <span class="n">lf.data.comb</span><span class="p">,</span> <span class="n">ylab</span> <span class="o">=</span> <span class="s">&quot;Lifespan for Ae. aegypti&quot;</span><span class="p">,</span> <span class="n">xlab</span> <span class="o">=</span> <span class="s">&quot;Temperature&quot;</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">lf.fit</span><span class="o">$</span><span class="n">BUGSoutput</span><span class="o">$</span><span class="n">summary</span><span class="p">[</span><span class="m">6</span><span class="o">:</span><span class="p">(</span><span class="m">6</span> <span class="o">+</span> <span class="n">N.Temp.xs</span> <span class="o">-</span> <span class="m">1</span><span class="p">),</span> <span class="s">&quot;2.5%&quot;</span><span class="p">]</span> <span class="o">~</span> <span class="n">Temp.xs</span><span class="p">,</span> <span class="n">lty</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">lf.fit</span><span class="o">$</span><span class="n">BUGSoutput</span><span class="o">$</span><span class="n">summary</span><span class="p">[</span><span class="m">6</span><span class="o">:</span><span class="p">(</span><span class="m">6</span> <span class="o">+</span> <span class="n">N.Temp.xs</span> <span class="o">-</span> <span class="m">1</span><span class="p">),</span> <span class="s">&quot;97.5%&quot;</span><span class="p">]</span> <span class="o">~</span> <span class="n">Temp.xs</span><span class="p">,</span> <span class="n">lty</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">lf.fit</span><span class="o">$</span><span class="n">BUGSoutput</span><span class="o">$</span><span class="n">summary</span><span class="p">[</span><span class="m">6</span><span class="o">:</span><span class="p">(</span><span class="m">6</span> <span class="o">+</span> <span class="n">N.Temp.xs</span> <span class="o">-</span> <span class="m">1</span><span class="p">),</span> <span class="s">&quot;mean&quot;</span><span class="p">]</span> <span class="o">~</span> <span class="n">Temp.xs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span>Error in eval(predvars, data, env): object &#39;lf.fit&#39; not found
Traceback:

1. lines(lf.fit$BUGSoutput$summary[6:(6 + N.Temp.xs - 1), &quot;2.5%&quot;] ~ 
 .     Temp.xs, lty = 2)
2. lines.formula(lf.fit$BUGSoutput$summary[6:(6 + N.Temp.xs - 1), 
 .     &quot;2.5%&quot;] ~ Temp.xs, lty = 2)
3. eval(m, eframe)
4. eval(m, eframe)
5. (function (formula, data = NULL, subset = NULL, na.action = na.fail, 
 .     drop.unused.levels = FALSE, xlev = NULL, ...) 
 . {
 .     possible_newdata &lt;- !missing(data) &amp;&amp; is.data.frame(data) &amp;&amp; 
 .         identical(substitute(data), quote(newdata)) &amp;&amp; (nr &lt;- nrow(data)) &gt; 
 .         0
 .     if (!missing(formula) &amp;&amp; nargs() == 1 &amp;&amp; is.list(formula) &amp;&amp; 
 .         !is.null(m &lt;- formula$model)) 
 .         return(m)
 .     if (!missing(formula) &amp;&amp; nargs() == 1 &amp;&amp; is.list(formula) &amp;&amp; 
 .         all(c(&quot;terms&quot;, &quot;call&quot;) %in% names(formula))) {
 .         fcall &lt;- formula$call
 .         m &lt;- match(c(&quot;formula&quot;, &quot;data&quot;, &quot;subset&quot;, &quot;weights&quot;, 
 .             &quot;na.action&quot;), names(fcall), 0)
 .         fcall &lt;- fcall[c(1, m)]
 .         fcall[[1L]] &lt;- quote(stats::model.frame)
 .         env &lt;- environment(formula$terms)
 .         if (is.null(env)) 
 .             env &lt;- parent.frame()
 .         return(eval(fcall, env))
 .     }
 .     if (missing(formula)) {
 .         if (!missing(data) &amp;&amp; inherits(data, &quot;data.frame&quot;) &amp;&amp; 
 .             length(attr(data, &quot;terms&quot;))) 
 .             return(data)
 .         formula &lt;- as.formula(data)
 .     }
 .     else if (missing(data) &amp;&amp; inherits(formula, &quot;data.frame&quot;)) {
 .         if (length(attr(formula, &quot;terms&quot;))) 
 .             return(formula)
 .         data &lt;- formula
 .         formula &lt;- as.formula(data)
 .     }
 .     else formula &lt;- as.formula(formula)
 .     if (missing(na.action)) {
 .         if (!is.null(naa &lt;- attr(data, &quot;na.action&quot;)) &amp; mode(naa) != 
 .             &quot;numeric&quot;) 
 .             na.action &lt;- naa
 .         else if (!is.null(naa &lt;- getOption(&quot;na.action&quot;))) 
 .             na.action &lt;- naa
 .     }
 .     if (missing(data)) 
 .         data &lt;- environment(formula)
 .     else if (!is.data.frame(data) &amp;&amp; !is.environment(data) &amp;&amp; 
 .         !is.null(attr(data, &quot;class&quot;))) 
 .         data &lt;- as.data.frame(data)
 .     else if (is.array(data)) 
 .         stop(&quot;&#39;data&#39; must be a data.frame, not a matrix or an array&quot;)
 .     if (!is.data.frame(data) &amp;&amp; !is.environment(data) &amp;&amp; !is.list(data) &amp;&amp; 
 .         !is.null(data)) 
 .         stop(&quot;&#39;data&#39; must be a data.frame, environment, or list&quot;)
 .     if (!inherits(formula, &quot;terms&quot;)) 
 .         formula &lt;- terms(formula, data = data)
 .     env &lt;- environment(formula)
 .     rownames &lt;- .row_names_info(data, 0L)
 .     vars &lt;- attr(formula, &quot;variables&quot;)
 .     predvars &lt;- attr(formula, &quot;predvars&quot;)
 .     if (is.null(predvars)) 
 .         predvars &lt;- vars
 .     varnames &lt;- vapply(vars, deparse2, &quot; &quot;)[-1L]
 .     variables &lt;- eval(predvars, data, env)
 .     resp &lt;- attr(formula, &quot;response&quot;)
 .     if (is.null(rownames) &amp;&amp; resp &gt; 0L) {
 .         lhs &lt;- variables[[resp]]
 .         rownames &lt;- if (is.matrix(lhs)) 
 .             rownames(lhs)
 .         else names(lhs)
 .     }
 .     if (possible_newdata &amp;&amp; length(variables)) {
 .         nr2 &lt;- max(sapply(variables, NROW))
 .         if (nr2 != nr) 
 .             warning(sprintf(paste0(ngettext(nr, &quot;&#39;newdata&#39; had %d row&quot;, 
 .                 &quot;&#39;newdata&#39; had %d rows&quot;), &quot; &quot;, ngettext(nr2, 
 .                 &quot;but variable found had %d row&quot;, &quot;but variables found have %d rows&quot;)), 
 .                 nr, nr2), call. = FALSE, domain = NA)
 .     }
 .     if (is.null(attr(formula, &quot;predvars&quot;))) {
 .         for (i in seq_along(varnames)) predvars[[i + 1L]] &lt;- makepredictcall(variables[[i]], 
 .             vars[[i + 1L]])
 .         attr(formula, &quot;predvars&quot;) &lt;- predvars
 .     }
 .     extras &lt;- substitute(list(...))
 .     extranames &lt;- names(extras[-1L])
 .     extras &lt;- eval(extras, data, env)
 .     subset &lt;- eval(substitute(subset), data, env)
 .     data &lt;- .External2(C_modelframe, formula, rownames, variables, 
 .         varnames, extras, extranames, subset, na.action)
 .     if (length(xlev)) {
 .         for (nm in names(xlev)) if (!is.null(xl &lt;- xlev[[nm]])) {
 .             xi &lt;- data[[nm]]
 .             if (is.character(xi)) 
 .                 xi &lt;- as.factor(xi)
 .             if (!is.factor(xi) || is.null(nxl &lt;- levels(xi))) 
 .                 warning(gettextf(&quot;variable &#39;%s&#39; is not a factor&quot;, 
 .                   nm), domain = NA)
 .             else {
 .                 ctr &lt;- attr(xi, &quot;contrasts&quot;)
 .                 xi &lt;- xi[, drop = TRUE]
 .                 nxl &lt;- levels(xi)
 .                 if (any(m &lt;- is.na(match(nxl, xl)))) 
 .                   stop(sprintf(ngettext(length(m), &quot;factor %s has new level %s&quot;, 
 .                     &quot;factor %s has new levels %s&quot;), nm, paste(nxl[m], 
 .                     collapse = &quot;, &quot;)), domain = NA)
 .                 data[[nm]] &lt;- factor(xi, levels = xl, exclude = NULL)
 .                 if (!identical(attr(data[[nm]], &quot;contrasts&quot;), 
 .                   ctr)) 
 .                   warning(gettext(sprintf(&quot;contrasts dropped from factor %s&quot;, 
 .                     nm), domain = NA), call. = FALSE)
 .             }
 .         }
 .     }
 .     else if (drop.unused.levels) {
 .         for (nm in names(data)) {
 .             x &lt;- data[[nm]]
 .             if (is.factor(x) &amp;&amp; length(unique(x[!is.na(x)])) &lt; 
 .                 length(levels(x))) {
 .                 ctr &lt;- attr(x, &quot;contrasts&quot;)
 .                 data[[nm]] &lt;- x[, drop = TRUE]
 .                 if (!identical(attr(data[[nm]], &quot;contrasts&quot;), 
 .                   ctr)) 
 .                   warning(gettext(sprintf(&quot;contrasts dropped from factor %s due to missing levels&quot;, 
 .                     nm), domain = NA), call. = FALSE)
 .             }
 .         }
 .     }
 .     attr(formula, &quot;dataClasses&quot;) &lt;- vapply(data, .MFclass, &quot;&quot;)
 .     attr(data, &quot;terms&quot;) &lt;- formula
 .     data
 . })(formula = lf.fit$BUGSoutput$summary[6:(6 + N.Temp.xs - 1), 
 .     &quot;2.5%&quot;] ~ Temp.xs, na.action = NULL)
6. eval(predvars, data, env)
7. eval(predvars, data, env)
</pre></div>
</div>
<img alt="../_images/20-ModelFitting_229_1.png" src="../_images/20-ModelFitting_229_1.png" />
</div>
</div>
</div>
<div class="section" id="additional-analyses">
<h4>Additional analyses<a class="headerlink" href="#additional-analyses" title="Permalink to this headline">¶</a></h4>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">which.max()</span></code> function to find the optimal temperature for adult lifespan:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Temp.xs</span><span class="p">[</span><span class="nf">which.max</span><span class="p">(</span><span class="nf">as.vector</span><span class="p">(</span><span class="n">lf.fit</span><span class="o">$</span><span class="n">BUGSoutput</span><span class="o">$</span><span class="n">summary</span><span class="p">[</span><span class="m">6</span><span class="o">:</span><span class="p">(</span><span class="m">6</span> <span class="o">+</span> <span class="n">N.Temp.xs</span> <span class="o">-</span> <span class="m">1</span><span class="p">),</span> <span class="s">&quot;mean&quot;</span><span class="p">]))]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span>Error in as.vector(lf.fit$BUGSoutput$summary[6:(6 + N.Temp.xs - 1), &quot;mean&quot;]): object &#39;lf.fit&#39; not found
Traceback:

1. which.max(as.vector(lf.fit$BUGSoutput$summary[6:(6 + N.Temp.xs - 
 .     1), &quot;mean&quot;]))
2. as.vector(lf.fit$BUGSoutput$summary[6:(6 + N.Temp.xs - 1), &quot;mean&quot;])
</pre></div>
</div>
</div>
</div>
<p>You can also pull out the lifespan values for each iteration of the MCMC chain over the temperature gradient to calculate <span class="math notranslate nohighlight">\(R_0\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">lf.grad</span> <span class="o">&lt;-</span> <span class="n">lf.fit</span><span class="o">$</span><span class="n">BUGSoutput</span><span class="o">$</span><span class="n">sims.list</span><span class="o">$</span><span class="n">z.trait.mu.pred</span>
<span class="nf">dim</span><span class="p">(</span><span class="n">lf.grad</span><span class="p">)</span> <span class="c1"># A matrix with 7500 iterations of the MCMC chains at 226 temperatures</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">envir</span><span class="p">,</span> <span class="n">enclos</span><span class="p">):</span> <span class="nb">object</span> <span class="s1">&#39;lf.fit&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-bayesian-model-fitting-of-abundance-data">
<h3>A Bayesian model fitting of abundance data<a class="headerlink" href="#a-bayesian-model-fitting-of-abundance-data" title="Permalink to this headline">¶</a></h3>
<p>We will now perform a bayesian analysis of population growth data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">require</span><span class="p">(</span><span class="n">R2jags</span><span class="p">)</span> <span class="c1"># does the fitting</span>
<span class="nf">require</span><span class="p">(</span><span class="n">coda</span><span class="p">)</span> <span class="c1"># makes diagnostic plots</span>
<span class="nf">library</span><span class="p">(</span><span class="n">IDPmisc</span><span class="p">)</span> <span class="c1"># makes nice colored pairs plots to look at joint posteriors</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id1">
<h4>The Data<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>These data are observations of the amphibian fungal pathogen <em>Batrachochytrium dendrobatidis</em> being grown in liquid culture at multiple different temperatures. The experiment is conducted in 96 well plates with a fixed initial innoculation of fungal spores in each well, and the plate placed in a constant temperature incubator. Each day, 8 wells per plate are observed and the optical density (OD) is measured. We will focus on a single temperature trial across mulitple plates with OD as the response.</p>
<p>We will fit a logistic model to these growth data.</p>
<p>Let’s have a look at the data first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">dat</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="s">&quot;../data/lb_ab_temps.csv&quot;</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<caption>A data.frame: 6 × 10</caption>
<thead>
	<tr><th></th><th scope=col>X</th><th scope=col>EXP</th><th scope=col>TEMP</th><th scope=col>DAY</th><th scope=col>ISOLATE</th><th scope=col>PLATE</th><th scope=col>WELL</th><th scope=col>OD</th><th scope=col>NC_AVG</th><th scope=col>OD_SUB</th></tr>
	<tr><th></th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>1</td><td>2</td><td>5</td><td>1</td><td>LB_AB</td><td>P.16</td><td>1</td><td>0.120</td><td>0.1195</td><td>0.0005</td></tr>
	<tr><th scope=row>2</th><td>2</td><td>2</td><td>5</td><td>1</td><td>LB_AB</td><td>P.16</td><td>2</td><td>0.120</td><td>0.1195</td><td>0.0005</td></tr>
	<tr><th scope=row>3</th><td>3</td><td>2</td><td>5</td><td>1</td><td>LB_AB</td><td>P.16</td><td>3</td><td>0.122</td><td>0.1195</td><td>0.0025</td></tr>
	<tr><th scope=row>4</th><td>4</td><td>2</td><td>5</td><td>1</td><td>LB_AB</td><td>P.16</td><td>4</td><td>0.123</td><td>0.1195</td><td>0.0035</td></tr>
	<tr><th scope=row>5</th><td>5</td><td>2</td><td>5</td><td>1</td><td>LB_AB</td><td>P.16</td><td>5</td><td>0.125</td><td>0.1195</td><td>0.0055</td></tr>
	<tr><th scope=row>6</th><td>6</td><td>2</td><td>5</td><td>1</td><td>LB_AB</td><td>P.16</td><td>6</td><td>0.125</td><td>0.1195</td><td>0.0055</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>We are only interested in a subset of these data, so we will subset out only those from experiment 2, and a temperature of 12<span class="math notranslate nohighlight">\(^\circ\)</span>C.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">d2</span> <span class="o">&lt;-</span> <span class="n">dat</span><span class="p">[</span><span class="nf">which</span><span class="p">(</span><span class="n">dat</span><span class="o">$</span><span class="n">EXP</span><span class="o">==</span><span class="m">2</span><span class="p">),</span><span class="m">2</span><span class="o">:</span><span class="m">8</span><span class="p">]</span>
<span class="n">d2</span> <span class="o">&lt;-</span> <span class="n">d2</span><span class="p">[</span><span class="nf">which</span><span class="p">(</span><span class="n">d2</span><span class="o">$</span><span class="n">TEMP</span><span class="o">==</span><span class="m">12</span><span class="p">),]</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      EXP         TEMP         DAY          ISOLATE             PLATE          
 Min.   :2   Min.   :12   Min.   : 1.00   Length:730         Length:730        
 1st Qu.:2   1st Qu.:12   1st Qu.: 9.00   Class :character   Class :character  
 Median :2   Median :12   Median :19.00   Mode  :character   Mode  :character  
 Mean   :2   Mean   :12   Mean   :19.04                                        
 3rd Qu.:2   3rd Qu.:12   3rd Qu.:29.00                                        
 Max.   :2   Max.   :12   Max.   :39.00                                        
      WELL             OD        
 Min.   :1.000   Min.   :0.0930  
 1st Qu.:2.000   1st Qu.:0.1630  
 Median :4.000   Median :0.2580  
 Mean   :4.315   Mean   :0.2437  
 3rd Qu.:6.000   3rd Qu.:0.3170  
 Max.   :8.000   Max.   :0.4600  
</pre></div>
</div>
</div>
</div>
<p>Now plot it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Temps</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="nf">max</span><span class="p">(</span><span class="n">d2</span><span class="o">$</span><span class="n">DAY</span><span class="p">)</span><span class="m">-1</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="m">0.05</span><span class="p">)</span>
<span class="n">mycol</span> <span class="o">&lt;-</span> <span class="m">1</span> 
<span class="n">my.ylim</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0.5</span><span class="p">)</span>
<span class="n">my.title</span> <span class="o">&lt;-</span> <span class="s">&quot;LB-AB isolate, T=12C&quot;</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">d2</span><span class="o">$</span><span class="n">DAY</span><span class="m">-1</span><span class="p">,</span> <span class="n">d2</span><span class="o">$</span><span class="n">OD</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="nf">max</span><span class="p">(</span><span class="n">Temps</span><span class="p">)),</span> <span class="n">ylim</span><span class="o">=</span><span class="n">my.ylim</span><span class="p">,</span>
 <span class="n">pch</span><span class="o">=</span><span class="p">(</span><span class="n">mycol</span><span class="m">+20</span><span class="p">),</span>
 <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;time (days)&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
 <span class="n">main</span><span class="o">=</span><span class="n">my.title</span><span class="p">,</span>
 <span class="n">col</span><span class="o">=</span><span class="n">mycol</span><span class="m">+1</span><span class="p">,</span> <span class="n">cex</span><span class="o">=</span><span class="m">1.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20-ModelFitting_241_0.png" src="../_images/20-ModelFitting_241_0.png" />
</div>
</div>
</div>
<div class="section" id="specifying-the-growth-curve">
<h4>Specifying the growth curve<a class="headerlink" href="#specifying-the-growth-curve" title="Permalink to this headline">¶</a></h4>
<p>Although logistic growth is often written as a differential equation, here we will work with the analytic solution of the model:</p>
<div class="math notranslate nohighlight">
\[
\mu(t) = \frac{KY_0}{Y_0+(K-Y_0)\exp{(-rt)}}
\]</div>
<p>This gives the mean function that we want to fit. We will assume log-normal noise around this response, as the optical density is bounded to be greater than 0 and since we also have increasing variance over time (as the optical density increases).</p>
</div>
<div class="section" id="id2">
<h4>The thermal response model file<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>JAGS needs the model written as a <code class="docutils literal notranslate"><span class="pre">.txt</span></code> or <code class="docutils literal notranslate"><span class="pre">.bug</span></code> file inside the working directory. You can either make the text file directly, or create it using the <code class="docutils literal notranslate"><span class="pre">sink()</span></code> function in your R script, as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">sink</span><span class="p">(</span><span class="s">&quot;jags-logistic.bug&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;</span>
<span class="s"> model {</span>
<span class="s"> </span>
<span class="s"> ## Likelihood</span>
<span class="s"> for (i in 1:N) {</span>
<span class="s">  Y[i] ~ dlnorm(log(mu[i]), tau)</span>
<span class="s">  mu[i] &lt;- K * Y0/(Y0+(K-Y0) * exp(-r * t[i]))</span>
<span class="s"> }</span>

<span class="s"> ## Priors</span>
<span class="s"> r~dexp(1000)</span>
<span class="s"> K ~ dunif(0.01, 0.6)</span>
<span class="s"> Y0 ~ dunif(0.09, 0.15)</span>
<span class="s"> tau &lt;- 1/sigma^2</span>
<span class="s"> sigma ~ dexp(0.1)</span>

<span class="s"> } # close model</span>
<span class="s"> &quot;</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="bp">T</span><span class="p">)</span>
<span class="nf">sink</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  model {
    
    ## Likelihood
    for (i in 1:N) {
        Y[i] ~ dlnorm(log(mu[i]), tau)
        mu[i] &lt;- K*Y0/(Y0+(K-Y0)*exp(-r*t[i]))
    }

    ## Priors
    r~dexp(1000)
    K ~ dunif(0.01, 0.6)
    Y0 ~ dunif(0.09, 0.15)
    tau&lt;-1/sigma^2
    sigma ~ dexp(0.1)

  } # close model
    
</pre></div>
</div>
</div>
</div>
<p>Note that the model file has two mandatory sections (the priors and the likelihood) and one optional section (derived quantiaties calculated from your fitted parameters).</p>
<p>In the example below we will build the model function with the log-normal likelihood for the logistic growth function. Priors are a combination of uniform and exponential distributions. As with the normal distribution, jags uses <span class="math notranslate nohighlight">\(\tau\)</span> to parameterize the variance of the normal distribution (<span class="math notranslate nohighlight">\(\tau = 1/(\sigma^2)\)</span>). However it can be easier to specify the prior on sigma directly. In this example we will generate posterior samples of derived quantities outside of JAGS (so you can see what this is actually doing).</p>
</div>
<div class="section" id="additional-settings-for-jags">
<h4>Additional settings for jags<a class="headerlink" href="#additional-settings-for-jags" title="Permalink to this headline">¶</a></h4>
<p>Now for some additional settings/specifications for jags:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parameters to Estimate</span>
<span class="n">parameters</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;Y0&#39;</span><span class="p">,</span> <span class="s">&#39;K&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="s">&#39;sigma&#39;</span><span class="p">)</span>

<span class="c1"># Initial values for the parameters</span>
<span class="n">inits</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(){</span><span class="nf">list</span><span class="p">(</span>
 <span class="n">Y0</span> <span class="o">=</span> <span class="m">0.1</span><span class="p">,</span>
 <span class="n">K</span> <span class="o">=</span> <span class="m">0.4</span><span class="p">,</span>
 <span class="n">r</span> <span class="o">=</span> <span class="m">0.1</span><span class="p">,</span>
 <span class="n">sigma</span> <span class="o">=</span> <span class="nf">rlnorm</span><span class="p">(</span><span class="m">1</span><span class="p">))}</span>

<span class="c1"># MCMC Settings: number of posterior dist elements = [(ni - nb) / nt ] * nc</span>
<span class="n">ni</span> <span class="o">&lt;-</span> <span class="m">6000</span> <span class="c1"># number of iterations in each chain</span>
<span class="n">nb</span> <span class="o">&lt;-</span> <span class="m">1000</span> <span class="c1"># number of &#39;burn in&#39; iterations to discard</span>
<span class="n">nt</span> <span class="o">&lt;-</span> <span class="m">1</span> <span class="c1"># thinning rate - jags saves every nt iterations in each chain</span>
<span class="n">nc</span> <span class="o">&lt;-</span> <span class="m">5</span> <span class="c1"># number of chains</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="fitting-the-model">
<h4>Fitting the model<a class="headerlink" href="#fitting-the-model" title="Permalink to this headline">¶</a></h4>
<p>Now we can run jags:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pull out data columns as vectors</span>
<span class="n">data</span> <span class="o">&lt;-</span> <span class="n">d2</span> <span class="c1"># this lets us reuse the same generic code: we only change this first line</span>
<span class="n">Y</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="o">$</span><span class="n">OD</span>
<span class="n">N</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
<span class="n">t</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="o">$</span><span class="n">DAY</span>

<span class="c1"># Bundle all data in a list for JAGS</span>
<span class="n">jag.data</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run JAGS</span>
<span class="n">OD.12C</span> <span class="o">&lt;-</span> <span class="nf">jags</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">jag.data</span><span class="p">,</span> <span class="n">inits</span><span class="o">=</span><span class="n">inits</span><span class="p">,</span> <span class="n">parameters.to.save</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> 
    <span class="n">model.file</span><span class="o">=</span><span class="s">&quot;jags-logistic.bug&quot;</span><span class="p">,</span> <span class="n">n.thin</span><span class="o">=</span><span class="n">nt</span><span class="p">,</span> <span class="n">n.chains</span><span class="o">=</span><span class="n">nc</span><span class="p">,</span> <span class="n">n.burnin</span><span class="o">=</span><span class="n">nb</span><span class="p">,</span> 
    <span class="n">n.iter</span><span class="o">=</span><span class="n">ni</span><span class="p">,</span> <span class="n">DIC</span><span class="o">=</span><span class="bp">T</span><span class="p">,</span> <span class="n">working.directory</span><span class="o">=</span><span class="nf">getwd</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in jags.model(model.file, data = data, inits = init.values, n.chains = n.chains, :
“Unused variable &quot;Y&quot; in data”
Warning message in jags.model(model.file, data = data, inits = init.values, n.chains = n.chains, :
“Unused variable &quot;N&quot; in data”
Warning message in jags.model(model.file, data = data, inits = init.values, n.chains = n.chains, :
“Unused variable &quot;t&quot; in data”
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Compiling model graph
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">jags</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">inits</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">chains</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">chains</span><span class="p">,</span> <span class="p">:</span> <span class="n">Nothing</span> <span class="n">to</span> <span class="nb">compile</span>


<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">jags</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">jag</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">inits</span> <span class="o">=</span> <span class="n">inits</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">,</span> 
 <span class="o">.</span>     <span class="n">model</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;jags-logistic.bug&quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">thin</span> <span class="o">=</span> <span class="n">nt</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">chains</span> <span class="o">=</span> <span class="n">nc</span><span class="p">,</span> 
 <span class="o">.</span>     <span class="n">n</span><span class="o">.</span><span class="n">burnin</span> <span class="o">=</span> <span class="n">nb</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="n">ni</span><span class="p">,</span> <span class="n">DIC</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="n">working</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">getwd</span><span class="p">())</span>
<span class="mi">2</span><span class="o">.</span> <span class="n">jags</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">inits</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">chains</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">chains</span><span class="p">,</span> 
 <span class="o">.</span>     <span class="n">n</span><span class="o">.</span><span class="n">adapt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Change into “mcmc” type samples for visualization with <code class="docutils literal notranslate"><span class="pre">coda</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">OD.12C.mcmc</span> <span class="o">&lt;-</span> <span class="nf">as.mcmc</span><span class="p">(</span><span class="n">OD.12C</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="k">as</span><span class="o">.</span><span class="n">mcmc</span><span class="p">(</span><span class="n">OD</span><span class="o">.</span><span class="mi">12</span><span class="n">C</span><span class="p">):</span> <span class="nb">object</span> <span class="s1">&#39;OD.12C&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="k">as</span><span class="o">.</span><span class="n">mcmc</span><span class="p">(</span><span class="n">OD</span><span class="o">.</span><span class="mi">12</span><span class="n">C</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="diagnostics">
<h4>Diagnostics<a class="headerlink" href="#diagnostics" title="Permalink to this headline">¶</a></h4>
<p>As you did in the <a class="reference external" href="#Aedes-data-revisited-using-Bayesian-fitting">Traits bayesian fitting example</a>, there are a number of model diagnostics that we need to check. First we want to look at the chains and confirm that they look like “fuzzy caterpillars” – no linear/non-linear patterns across the chains, low auto-correlation, etc.</p>
<p>First view the fitted parameters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">OD.12C</span><span class="o">$</span><span class="n">BUGSoutput</span><span class="o">$</span><span class="n">summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">envir</span><span class="p">,</span> <span class="n">enclos</span><span class="p">):</span> <span class="nb">object</span> <span class="s1">&#39;OD.12C&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:
</pre></div>
</div>
</div>
</div>
<p>Plot the chains using the coda package:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">OD.12C.mcmc</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">4</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">h</span><span class="p">(</span><span class="n">simpleError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">call</span><span class="p">)):</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">evaluating</span> <span class="n">the</span> <span class="n">argument</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">selecting</span> <span class="n">a</span> <span class="n">method</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span> <span class="nb">object</span> <span class="s1">&#39;OD.12C.mcmc&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">plot</span><span class="p">(</span><span class="n">OD</span><span class="o">.</span><span class="mi">12</span><span class="n">C</span><span class="o">.</span><span class="n">mcmc</span><span class="p">[,</span> <span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>
<span class="mi">2</span><span class="o">.</span> <span class="o">.</span><span class="n">handleSimpleError</span><span class="p">(</span><span class="n">function</span> <span class="p">(</span><span class="n">cond</span><span class="p">)</span> 
 <span class="o">.</span> <span class="o">.</span><span class="n">Internal</span><span class="p">(</span><span class="n">C_tryCatchHelper</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="n">L</span><span class="p">,</span> <span class="n">cond</span><span class="p">)),</span> <span class="s2">&quot;object &#39;OD.12C.mcmc&#39; not found&quot;</span><span class="p">,</span> 
 <span class="o">.</span>     <span class="n">base</span><span class="p">::</span><span class="n">quote</span><span class="p">(</span><span class="n">plot</span><span class="p">(</span><span class="n">OD</span><span class="o">.</span><span class="mi">12</span><span class="n">C</span><span class="o">.</span><span class="n">mcmc</span><span class="p">[,</span> <span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])))</span>
<span class="mi">3</span><span class="o">.</span> <span class="n">h</span><span class="p">(</span><span class="n">simpleError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">call</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We can examine the ACF of the chains as well, similarly to a time series:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">s1</span> <span class="o">&lt;-</span> <span class="nf">as.data.frame</span><span class="p">(</span><span class="n">OD.12C.mcmc</span><span class="p">[[</span><span class="m">1</span><span class="p">]])</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">))</span>
<span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">2</span><span class="o">:</span><span class="m">5</span><span class="p">)</span> <span class="nf">acf</span><span class="p">(</span><span class="n">s1</span><span class="p">[,</span><span class="n">i</span><span class="p">],</span> <span class="n">lag.max</span><span class="o">=</span><span class="m">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="k">as</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="n">OD</span><span class="o">.</span><span class="mi">12</span><span class="n">C</span><span class="o">.</span><span class="n">mcmc</span><span class="p">[[</span><span class="mi">1</span><span class="p">]]):</span> <span class="nb">object</span> <span class="s1">&#39;OD.12C.mcmc&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="k">as</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="n">OD</span><span class="o">.</span><span class="mi">12</span><span class="n">C</span><span class="o">.</span><span class="n">mcmc</span><span class="p">[[</span><span class="mi">1</span><span class="p">]])</span>
</pre></div>
</div>
</div>
</div>
<p>There is still a bit of autocorrelation, but it isn’t too bad. The chain for <span class="math notranslate nohighlight">\(\sigma\)</span> is mixing best. We could reduce the autocorrelation even further by thinning the chain (i.e., change the <code class="docutils literal notranslate"><span class="pre">nt</span></code> parameter to 5 or 10).</p>
<p>The last important diagnostic is to compare the prior and posterior distributions. Various packages in R have bespoke functions to do this. Here we use functions that we provide in the <code class="docutils literal notranslate"><span class="pre">mcmc_utils.R</span></code> file provided on the website.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">source</span><span class="p">(</span><span class="s">&quot;../code/mcmc_utils.R&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in file(filename, &quot;r&quot;, encoding = encoding):
“cannot open file &#39;../code/mcmc_utils.R&#39;: No such file or directory”
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span><span class="p">):</span> <span class="n">cannot</span> <span class="nb">open</span> <span class="n">the</span> <span class="n">connection</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">source</span><span class="p">(</span><span class="s2">&quot;../code/mcmc_utils.R&quot;</span><span class="p">)</span>
<span class="mi">2</span><span class="o">.</span> <span class="n">file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We also can write a function to put the samples into a convenient format for visualizing, etc:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">samps</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>
<span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">nc</span><span class="p">){</span>
 <span class="n">samps</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">samps</span><span class="p">,</span> <span class="nf">as.data.frame</span><span class="p">(</span><span class="n">OD.12C.mcmc</span><span class="p">[[</span><span class="n">i</span><span class="p">]]))</span>
<span class="p">}</span>

<span class="n">samps</span> <span class="o">&lt;-</span> <span class="n">samps</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">4</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="k">as</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="n">OD</span><span class="o">.</span><span class="mi">12</span><span class="n">C</span><span class="o">.</span><span class="n">mcmc</span><span class="p">[[</span><span class="n">i</span><span class="p">]]):</span> <span class="nb">object</span> <span class="s1">&#39;OD.12C.mcmc&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">rbind</span><span class="p">(</span><span class="n">samps</span><span class="p">,</span> <span class="k">as</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="n">OD</span><span class="o">.</span><span class="mi">12</span><span class="n">C</span><span class="o">.</span><span class="n">mcmc</span><span class="p">[[</span><span class="n">i</span><span class="p">]]))</span>
<span class="mi">2</span><span class="o">.</span> <span class="k">as</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="n">OD</span><span class="o">.</span><span class="mi">12</span><span class="n">C</span><span class="o">.</span><span class="n">mcmc</span><span class="p">[[</span><span class="n">i</span><span class="p">]])</span>
</pre></div>
</div>
</div>
</div>
<p>And also, we can building a list to hold all the information about the priors for each parameter:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">priors</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>
<span class="n">priors</span><span class="o">$</span><span class="n">names</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;Y0&quot;</span><span class="p">,</span> <span class="s">&quot;K&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">,</span><span class="s">&quot;sigma&quot;</span><span class="p">)</span>
<span class="n">priors</span><span class="o">$</span><span class="n">fun</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;uniform&quot;</span><span class="p">,</span> <span class="s">&quot;uniform&quot;</span><span class="p">,</span> <span class="s">&quot;exp&quot;</span><span class="p">,</span><span class="s">&quot;exp&quot;</span><span class="p">)</span>
<span class="n">priors</span><span class="o">$</span><span class="n">hyper</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
<span class="n">priors</span><span class="o">$</span><span class="n">hyper</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">0.09</span><span class="p">,</span> <span class="m">0.15</span><span class="p">,</span> <span class="kc">NA</span><span class="p">)</span>
<span class="n">priors</span><span class="o">$</span><span class="n">hyper</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">0.01</span><span class="p">,</span> <span class="m">0.6</span><span class="p">,</span> <span class="kc">NA</span><span class="p">)</span>
<span class="n">priors</span><span class="o">$</span><span class="n">hyper</span><span class="p">[,</span><span class="m">3</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="kc">NA</span><span class="p">,</span> <span class="kc">NA</span><span class="p">)</span> 
<span class="n">priors</span><span class="o">$</span><span class="n">hyper</span><span class="p">[,</span><span class="m">4</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span> <span class="kc">NA</span><span class="p">,</span> <span class="kc">NA</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can plot the histograms of the posterior samples together with the prior distributions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot.hists</span><span class="p">(</span><span class="n">samps</span><span class="p">,</span> <span class="n">my.par</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">n.hists</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="n">priors</span><span class="p">,</span> <span class="n">mai</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">0.25</span><span class="p">,</span> <span class="m">0.2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">plot</span><span class="o">.</span><span class="n">hists</span><span class="p">(</span><span class="n">samps</span><span class="p">,</span> <span class="n">my</span><span class="o">.</span><span class="n">par</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">n</span><span class="o">.</span><span class="n">hists</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">priors</span> <span class="o">=</span> <span class="n">priors</span><span class="p">,</span> <span class="p">:</span> <span class="n">could</span> <span class="ow">not</span> <span class="n">find</span> <span class="n">function</span> <span class="s2">&quot;plot.hists&quot;</span>
<span class="ne">Traceback</span>:
</pre></div>
</div>
</div>
</div>
<p>The prior distribution here is very different from the posterior. These data are highly informative for the parameters of interest and are very unlikely to be influenced much by the prior distribution (although you can always change the priors to check this). However, notice that <span class="math notranslate nohighlight">\(Y_0\)</span> (the initial condition) is truncated by the prior. This is a fairly strong prior, because we know something about the initial optical density that is typical for the esperimental set up with the density of innoculum used and with a properly calibrated set-up.</p>
</div>
<div class="section" id="visualizing-the-joint-posterior-of-parameters">
<h4>Visualizing the joint posterior of parameters<a class="headerlink" href="#visualizing-the-joint-posterior-of-parameters" title="Permalink to this headline">¶</a></h4>
<p>It’s often useful to also look at the joint distbution of all of your parameters together. Of course, if you have a high dimensional posterior, rendering a 2-D representation can be difficult. Instead, the standard is to examine the pair-wise posterior distribution, for instance as follows (using the <code class="docutils literal notranslate"><span class="pre">s1</span></code> data frame we created above):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">ipairs</span><span class="p">(</span><span class="n">s1</span><span class="p">[,</span><span class="m">2</span><span class="o">:</span><span class="m">5</span><span class="p">],</span> <span class="n">ztransf</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">&lt;</span><span class="m">1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="m">1</span><span class="p">;</span> <span class="nf">log2</span><span class="p">(</span><span class="n">x</span><span class="p">)})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="ow">is</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="nb">object</span> <span class="s1">&#39;s1&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">s1</span><span class="p">[,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="n">ztransf</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
 <span class="o">.</span>     <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="mi">1</span>
 <span class="o">.</span>     <span class="n">log2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
 <span class="o">.</span> <span class="p">})</span>
<span class="mi">2</span><span class="o">.</span> <span class="ow">is</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As you can see, estimates of <span class="math notranslate nohighlight">\(r\)</span> and <span class="math notranslate nohighlight">\(K\)</span> are highly correlated – not surprising given the interplay between them in the logistic growth function. This correlation is an important feature of the system, and we use the full posterior distribution that includes this correlation when we want to build the corresponding posterior distribution of the behavior of the logistic function.</p>
</div>
<div class="section" id="the-posterior-distribution-of-the-mean-function">
<h4>The posterior distribution of the mean function<a class="headerlink" href="#the-posterior-distribution-of-the-mean-function" title="Permalink to this headline">¶</a></h4>
<p>The final step is to check how well we are fitting the data. To do this we usually examine the posterior distribution of the mean function of our system, in this case the distribution of the logistic solution and compare this to the data. To do this, for each of our posterior samples (or a thinned subset), we plug the parameters for the <span class="math notranslate nohighlight">\(i^{\mathrm th}\)</span> sample <span class="math notranslate nohighlight">\(\theta_i\)</span> into our function of interest, and evaluate the function as a desired set of <span class="math notranslate nohighlight">\(x\)</span>’s. For instance, for logistic growth, we’ll evaluate
$<span class="math notranslate nohighlight">\(
\mu(t) = \frac{K_iY_{0,i}}{Y_{0,i}+(K_i-Y_{0,i})\exp{(-r_it)}}
\)</span><span class="math notranslate nohighlight">\(
for the \)</span>i^{\mathrm th}<span class="math notranslate nohighlight">\( set of parameters for a sequence of times, \)</span>t<span class="math notranslate nohighlight">\(. This we obtain points describing the curve \)</span>\mu_i(t)$ for each set of parameters. Here is one way to do this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">my.logistic</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Y0</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">r</span><span class="p">){</span>
 <span class="nf">return</span><span class="p">(</span><span class="n">K</span> <span class="o">*</span> <span class="n">Y0</span><span class="o">/</span><span class="p">(</span><span class="n">Y0</span><span class="o">+</span><span class="p">(</span><span class="n">K</span><span class="o">-</span><span class="n">Y0</span><span class="p">)</span> <span class="o">*</span> <span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">t</span><span class="p">)))</span>
<span class="p">}</span>

<span class="n">ts</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">40</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="m">100</span><span class="p">)</span>
<span class="n">ss</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="nf">dim</span><span class="p">(</span><span class="n">samps</span><span class="p">)[</span><span class="m">1</span><span class="p">],</span> <span class="n">by</span><span class="o">=</span><span class="m">10</span><span class="p">)</span>
<span class="n">my.curves</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">ss</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>

<span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">ss</span><span class="p">)){</span>
 <span class="n">my.curves</span><span class="p">[</span><span class="n">i</span><span class="p">,]</span> <span class="o">&lt;-</span> <span class="nf">my.logistic</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">Y0</span><span class="o">=</span><span class="n">samps</span><span class="o">$</span><span class="n">Y0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">K</span><span class="o">=</span><span class="n">samps</span><span class="o">$</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">samps</span><span class="o">$</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">seq</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">(</span><span class="n">samps</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">by</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span> <span class="s1">&#39;to&#39;</span> <span class="n">must</span> <span class="n">be</span> <span class="n">of</span> <span class="n">length</span> <span class="mi">1</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">(</span><span class="n">samps</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">by</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="mi">2</span><span class="o">.</span> <span class="n">seq</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">(</span><span class="n">samps</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">by</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="mi">3</span><span class="o">.</span> <span class="n">stop</span><span class="p">(</span><span class="s2">&quot;&#39;to&#39; must be of length 1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can now plot all of these curves:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">my.curves</span><span class="p">[</span><span class="m">1</span><span class="p">,],</span> <span class="n">col</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&quot;l&quot;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.09</span><span class="p">,</span> <span class="m">0.36</span><span class="p">),</span> 
  <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;predicted OD&quot;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;time (days)&quot;</span><span class="p">)</span>
<span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">2</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">ss</span><span class="p">))</span> <span class="nf">lines</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">my.curves</span><span class="p">[</span><span class="n">i</span><span class="p">,],</span> <span class="n">col</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">h</span><span class="p">(</span><span class="n">simpleError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">call</span><span class="p">)):</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">evaluating</span> <span class="n">the</span> <span class="n">argument</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">selecting</span> <span class="n">a</span> <span class="n">method</span> <span class="k">for</span> <span class="n">function</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span> <span class="nb">object</span> <span class="s1">&#39;my.curves&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">my</span><span class="o">.</span><span class="n">curves</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="n">col</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="mf">0.09</span><span class="p">,</span> 
 <span class="o">.</span>     <span class="mf">0.36</span><span class="p">),</span> <span class="n">ylab</span> <span class="o">=</span> <span class="s2">&quot;predicted OD&quot;</span><span class="p">,</span> <span class="n">xlab</span> <span class="o">=</span> <span class="s2">&quot;time (days)&quot;</span><span class="p">)</span>
<span class="mi">2</span><span class="o">.</span> <span class="o">.</span><span class="n">handleSimpleError</span><span class="p">(</span><span class="n">function</span> <span class="p">(</span><span class="n">cond</span><span class="p">)</span> 
 <span class="o">.</span> <span class="o">.</span><span class="n">Internal</span><span class="p">(</span><span class="n">C_tryCatchHelper</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="n">L</span><span class="p">,</span> <span class="n">cond</span><span class="p">)),</span> <span class="s2">&quot;object &#39;my.curves&#39; not found&quot;</span><span class="p">,</span> 
 <span class="o">.</span>     <span class="n">base</span><span class="p">::</span><span class="n">quote</span><span class="p">(</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">my</span><span class="o">.</span><span class="n">curves</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">],</span> <span class="n">col</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> 
 <span class="o">.</span>         <span class="n">ylim</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">),</span> <span class="n">ylab</span> <span class="o">=</span> <span class="s2">&quot;predicted OD&quot;</span><span class="p">,</span> <span class="n">xlab</span> <span class="o">=</span> <span class="s2">&quot;time (days)&quot;</span><span class="p">)))</span>
<span class="mi">3</span><span class="o">.</span> <span class="n">h</span><span class="p">(</span><span class="n">simpleError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">call</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Then we can summarize this posterior using the <code class="docutils literal notranslate"><span class="pre">apply</span></code> function to find the mean and the (for simplicity) quantile based 95% CI:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">m.log</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">my.curves</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>
<span class="n">l.log</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">my.curves</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="n">quantile</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="m">0.025</span><span class="p">)</span>
<span class="n">u.log</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">my.curves</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="n">quantile</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="m">0.975</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">apply</span><span class="p">(</span><span class="n">my</span><span class="o">.</span><span class="n">curves</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span> <span class="nb">object</span> <span class="s1">&#39;my.curves&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">apply</span><span class="p">(</span><span class="n">my</span><span class="o">.</span><span class="n">curves</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For comparison, here is how to find the 95% HPD Interval across time, using the <code class="docutils literal notranslate"><span class="pre">HPDinterval</span></code> function from the <code class="docutils literal notranslate"><span class="pre">coda</span></code> package:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">hpd.log</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>
<span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">ts</span><span class="p">)){</span>
 <span class="n">hpd.log</span> <span class="o">&lt;-</span> <span class="nf">cbind</span><span class="p">(</span><span class="n">hpd.log</span><span class="p">,</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="nf">HPDinterval</span><span class="p">(</span><span class="nf">mcmc</span><span class="p">(</span><span class="n">my.curves</span><span class="p">[,</span><span class="n">i</span><span class="p">]))))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">mcmc</span><span class="p">(</span><span class="n">my</span><span class="o">.</span><span class="n">curves</span><span class="p">[,</span> <span class="n">i</span><span class="p">]):</span> <span class="nb">object</span> <span class="s1">&#39;my.curves&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">cbind</span><span class="p">(</span><span class="n">hpd</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="k">as</span><span class="o">.</span><span class="n">numeric</span><span class="p">(</span><span class="n">HPDinterval</span><span class="p">(</span><span class="n">mcmc</span><span class="p">(</span><span class="n">my</span><span class="o">.</span><span class="n">curves</span><span class="p">[,</span> <span class="n">i</span><span class="p">]))))</span>
<span class="mi">2</span><span class="o">.</span> <span class="n">HPDinterval</span><span class="p">(</span><span class="n">mcmc</span><span class="p">(</span><span class="n">my</span><span class="o">.</span><span class="n">curves</span><span class="p">[,</span> <span class="n">i</span><span class="p">]))</span>
<span class="mi">3</span><span class="o">.</span> <span class="n">mcmc</span><span class="p">(</span><span class="n">my</span><span class="o">.</span><span class="n">curves</span><span class="p">[,</span> <span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>And plot these together with the data (in this case the HPD and quantile based intervals are indistinguishable):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">my.ylim</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">0.09</span><span class="p">,</span> <span class="m">0.45</span><span class="p">)</span>
<span class="n">my.title</span> <span class="o">&lt;-</span> <span class="s">&quot;LB-AB isolate, T=12C&quot;</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">d2</span><span class="o">$</span><span class="n">DAY</span><span class="m">-1</span><span class="p">,</span> <span class="n">d2</span><span class="o">$</span><span class="n">OD</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="nf">max</span><span class="p">(</span><span class="n">Temps</span><span class="p">)),</span> <span class="n">ylim</span><span class="o">=</span><span class="n">my.ylim</span><span class="p">,</span>
 <span class="n">pch</span><span class="o">=</span><span class="p">(</span><span class="n">mycol</span><span class="m">+20</span><span class="p">),</span>
 <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;time (days)&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
 <span class="n">main</span><span class="o">=</span><span class="n">my.title</span><span class="p">,</span>
 <span class="n">col</span><span class="o">=</span><span class="s">&quot;grey&quot;</span><span class="p">,</span> <span class="n">cex</span><span class="o">=</span><span class="m">1.5</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">m.log</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">l.log</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lty</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">u.log</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lty</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>

<span class="nf">lines</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">hpd.log</span><span class="p">[</span><span class="m">1</span><span class="p">,],</span> <span class="n">col</span><span class="o">=</span><span class="m">3</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lty</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">hpd.log</span><span class="p">[</span><span class="m">2</span><span class="p">,],</span> <span class="n">col</span><span class="o">=</span><span class="m">3</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">lty</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">xy</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> <span class="nb">object</span> <span class="s1">&#39;m.log&#39;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">lines</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lwd</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="mi">2</span><span class="o">.</span> <span class="n">lines</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lwd</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="mi">3</span><span class="o">.</span> <span class="n">plot</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">xy</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="mi">4</span><span class="o">.</span> <span class="n">xy</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/20-ModelFitting_277_1.png" src="../_images/20-ModelFitting_277_1.png" />
</div>
</div>
<p>Note that this only shows the uncertainty in the * mean function * – the assumed model with log normal noise says that the observations simply have this mean. The fit is attributing the majority of the observed noise to process error rather than parameter uncertainty.</p>
</div>
</div>
</div>
<div class="section" id="readings-and-resources-a-id-readings-a">
<h2>Readings and Resources <a id='Readings'></a><a class="headerlink" href="#readings-and-resources-a-id-readings-a" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Motulsky, Harvey, and Arthur Christopoulos. Fitting models to biological data using linear and nonlinear regression: a practical guide to curve fitting. OUP USA, 2004.</p></li>
<li><p>Johnson, J. B. &amp; Omland, K. S. 2004 Model selection in ecology and evolution. Trends Ecol. Evol. 19, 101–108.</p></li>
<li><p>The <a class="reference external" href="https://groups.nceas.ucsb.edu/non-linear-modeling/projects/OrangeTree">NCEAS non-linear modelling working group</a></p></li>
<li><p><a class="reference external" href="https://link.springer.com/book/10.1007/b98882">Mixed-Effects Models in S and S-PLUS</a></p></li>
<li><p>Bolker, B. Ecological models and data in R. (Princeton University Press, 2008).</p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            kernelName: "ir",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="19-glm.html" title="previous page">Generalised Linear Models</a>
    <a class='right-next' id="next-link" href="Appendix-JupyIntro.html" title="next page">Introduction to Jupyter</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Samraat Pawar<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.30270b6e4c972e43c488.js"></script>


    
  </body>
</html>